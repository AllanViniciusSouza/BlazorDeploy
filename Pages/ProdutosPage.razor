@page "/produtos"
@inject ApiService _apiService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@using System.Globalization

<PageTitle>Lista de Produtos</PageTitle>

<div id="produtos-barcode-scanner" style="display:none;"></div>

<div class="d-flex align-items-center justify-content-end mb-3">
    <div class="d-flex align-items-center">
        <button class="btn btn-success btn-sm me-2" title="Adicionar novo produto" @onclick="MostrarFormulario" aria-label="Adicionar produto">+</button>
        <button class="btn btn-sm btn-outline-primary" title="Abrir leitor (câmera)" @onclick="OpenScanner" aria-label="Abrir leitor de códigos">
            <!-- camera icon (rounded camera) -->
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                <path d="M10.5 3a.5.5 0 0 1 .416.223L11.9 4.7H13.5A1.5 1.5 0 0 1 15 6.2v5.6A1.5 1.5 0 0 1 13.5 13.3H2.5A1.5 1.5 0 0 1 1 11.8V6.2A1.5 1.5 0 0 1 2.5 4.7H4.1l.984-1.477A.5.5 0 0 1 5.5 3h5z"/>
                <path d="M8 6.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM8 8a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3z"/>
            </svg>
        </button>
    </div>
</div>

@* Brand quick-filter grouped by initial letter (from CaixaPage) *@
@if (marcas != null && marcas.Any())
{
    <div class="mb-3">
        <label class="form-label fw-bold">Marcas</label>
        <div class="brand-list" style="font-size:0.85rem;">
            @if (string.IsNullOrEmpty(selectedMarca))
            {
                <div class="d-flex flex-row flex-wrap" style="gap:1rem; align-items:flex-start;">
                    @foreach (var group in marcas.GroupBy(m => char.ToUpperInvariant((!string.IsNullOrWhiteSpace(m) ? m.Trim()[0] : '?'))).OrderBy(g => g.Key))
                    {
                        <div style="min-width:90px;">
                            <div class="fw-bold mb-1">@group.Key</div>
                            @foreach (var m in group.OrderBy(x => x))
                            {
                                <button class="brand-item text-start p-0 mb-1" style="background:none; border:none; display:block; width:100%; padding:0.12rem 0;" @onclick="() => OnSelectMarca(m)">@m</button>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <div>
                    <span class="fw-bold">@selectedMarca</span>
                    <button class="btn btn-sm btn-outline-secondary ms-2" @onclick="() => OnSelectMarca(null)">Limpar</button>
                </div>
            }
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(selectedMarca) && sizesForMarca != null && sizesForMarca.Any())
{
    <div class="mb-3">
        <label class="form-label fw-bold">Tamanhos para @selectedMarca</label>
        <div class="d-flex flex-wrap gap-2">
            @if (string.IsNullOrEmpty(selectedSize))
            {
                @foreach (var s in sizesForMarca)
                {
                    <button class="btn btn-sm btn-outline-secondary" @onclick="() => OnSelectSize(s)">@s</button>
                }
            }
            else
            {
                <button class="btn btn-sm btn-primary">@selectedSize</button>
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => OnSelectSize(null)">Limpar</button>
            }
        </div>
    </div>
}

@if (flavorsForSelection != null && flavorsForSelection.Any())
{
    <div class="mb-3">
        <label class="form-label fw-bold">Sabores para @selectedMarca @selectedSize</label>
        <div class="d-flex flex-wrap gap-2">
            @foreach (var f in flavorsForSelection)
            {
                var flavorLocal = f; 
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => OnSelectFlavor(flavorLocal)">@f</button>
            }
            <button class="btn btn-sm btn-outline-secondary" @onclick="() => ClearFlavors()">Limpar</button>
        </div>
    </div>
}

@if (exibirFormulario)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block">
        <div class="modal-dialog modal-md mt-5">
            <div class="modal-content p-4">
                <EditForm Model="novoProduto" OnValidSubmit="AdicionarProduto">
                    <DataAnnotationsValidator />
                    <h5 class="mb-3">Adicionar Produto</h5>

                    <div class="form-group mb-2">
                        <label for="nome">Nome:</label>
                        <InputText id="nome" class="form-control" @bind-Value="novoProduto.Nome" />
                        <ValidationMessage For="@(() => novoProduto.Nome)" />
                    </div>

                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label class="form-label">Preço Quente</label>
                            <InputNumber class="form-control" @bind-Value="novoProduto.PrecoQuente" step="0.01" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Preço Gelada</label>
                            <InputNumber class="form-control" @bind-Value="novoProduto.PrecoGelada" step="0.01" />
                        </div>
                    </div>

                    <div class="form-group mb-2">
                        <label class="form-label">Categoria:</label>
                        <div class="d-flex flex-wrap" style="gap:.5rem;">
                            @if (categorias != null && categorias.Any())
                            {
                                @foreach (var cat in categorias)
                                {
                                    <div class="form-check" style="flex:1 0 140px; min-width:140px;">
                                        <input class="form-check-input" type="radio" name="categoria_radio" id="cat_@cat.Id" value="@cat.Id" @onchange="() => novoProduto.CategoriaId = cat.Id" checked="@(novoProduto.CategoriaId == cat.Id)" />
                                        <label class="form-check-label ms-1" for="cat_@cat.Id">@cat.Nome</label>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-muted">Nenhuma categoria disponível</div>
                            }
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="barcode">Barcode:</label>
                        <InputText id="barcode" class="form-control" @bind-Value="novoProduto.Barcode" />
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-success me-2">Salvar</button>
                        <button type="button" class="btn btn-secondary" @onclick="Cancelar">Cancelar</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@if (string.IsNullOrEmpty(selectedMarca))
{
    <div class="row mb-3">
        <div class="col-12">
            <label class="form-label fw-bold">Pesquisar (nome ou código de barras)</label>
            <input class="form-control" @bind="searchTerm" @oninput="Search" placeholder="Digite nome ou código" />
        </div>
    </div>
}

<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
    @if (filteredProdutos != null)
    {
        @foreach (var produto in filteredProdutos)
        {
            <div class="col">
                <div class="card bg-dark text-white h-100 position-relative" style="cursor:pointer;" @onclick="@(() => EditRowClicked(produto.Id))">
                    @* small delete X in top-right; stopPropagation so clicking it doesn't open edit *@
                    <button class="btn btn-sm btn-outline-light position-absolute" style="top:6px; right:6px; padding:0.15rem 0.4rem; font-size:0.9rem; line-height:1;" @onclick:stopPropagation="true" @onclick="() => ExcluirProduto(produto.Id)">×</button>

                    <div class="card-body p-2">
                        @if (editandoProdutos.ContainsKey(produto.Id) && editandoProdutos[produto.Id])
                        {
                            <InputText class="form-control form-control-sm mb-1" @bind-Value="produto.Nome" @onclick:stopPropagation="true" />
                            <InputSelect class="form-control form-control-sm mb-1" @bind-Value="produto.CategoriaId" @onclick:stopPropagation="true">
                                @foreach (var cat in categorias)
                                {
                                    <option value="@cat.Id">@cat.Nome</option>
                                }
                            </InputSelect>

                            <div class="d-flex gap-2 align-items-center">
                                <div class="input-group" style="width:170px;">
                                    <span class="input-group-text small">Quente</span>
                                    <input id="@($"precoQ-{produto.Id}")" class="form-control form-control-sm text-end" value="@(editPrecoQuenteInputs.ContainsKey(produto.Id) ? editPrecoQuenteInputs[produto.Id] : string.Empty)" @oninput="@(e => OnEditPrecoQuenteInput(produto.Id, e))" @onclick:stopPropagation="true" />
                                    <div class="small text-white-50 mt-1">Atual: R$ @produto.PrecoQuente.ToString("0.00")</div>
                                </div>
                                <div class="input-group" style="width:170px;">
                                    <span class="input-group-text small">Gelada</span>
                                    <input id="@($"precoG-{produto.Id}")" class="form-control form-control-sm text-end" value="@(editPrecoGeladaInputs.ContainsKey(produto.Id) ? editPrecoGeladaInputs[produto.Id] : string.Empty)" @oninput="@(e => OnEditPrecoGeladaInput(produto.Id, e))" @onclick:stopPropagation="true" />
                                    <div class="small text-white-50 mt-1">Atual: R$ @produto.PrecoGelada.ToString("0.00")</div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="d-flex flex-column">
                                <div>
                                    <div class="fw-bold" style="white-space:normal; word-break:break-word; font-size:0.95rem;">
                                        @produto.Nome
                                        @if (!string.IsNullOrWhiteSpace(produto.Barcode))
                                        {
                                            <span class="text-white-50" style="font-size:0.85rem; margin-left:6px;">- @produto.Barcode</span>
                                        }
                                    </div>
                                </div>

                                <div class="small text-white-50">@categorias.FirstOrDefault(c => c.Id == produto.CategoriaId)?.Nome</div>

                                <div class="d-flex gap-3 mt-2 align-items-end">
                                    <div>
                                        <div class="small text-white-50">Quente</div>
                                        <div class="fw-bold">R$ @produto.PrecoQuente.ToString("0.00")</div>
                                    </div>
                                    <div>
                                        <div class="small text-white-50">Gelada</div>
                                        <div class="fw-bold">R$ @produto.PrecoGelada.ToString("0.00")</div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    @* removed duplicate barcode overlay; barcode now shown inline with name *@

                    <div class="card-footer bg-transparent d-flex justify-content-end">
                        @if (editandoProdutos.ContainsKey(produto.Id) && editandoProdutos[produto.Id])
                        {
                            <button class="btn btn-success btn-sm me-1" @onclick:stopPropagation="true" @onclick="() => SalvarEdicao(produto)">Salvar</button>
                            <button class="btn btn-secondary btn-sm" @onclick:stopPropagation="true" @onclick="() => CancelarEdicao(produto.Id)">Cancelar</button>
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private DotNetObjectReference<object>? _dotNetRefProdutos;
    [JSInvokable]
    public async Task OnBarcodeScanned_Produtos(string code)
    {
        // put code into search field and trigger search
        searchTerm = code;
        await Search(new ChangeEventArgs { Value = code });

        // if product found, move it to top and enter edit mode
        var found = filteredProdutos.FirstOrDefault(p => string.Equals(p.Barcode?.Trim(), code?.Trim(), StringComparison.OrdinalIgnoreCase)
                    || (!string.IsNullOrEmpty(p.Barcode) && new string(p.Barcode.Where(char.IsDigit).ToArray()) == new string(code.Where(char.IsDigit).ToArray())));
        if (found != null)
        {
            // move to top
            filteredProdutos.Remove(found);
            filteredProdutos.Insert(0, found);
            editandoProdutos[found.Id] = true;
            StateHasChanged();
        }
    }

    private async Task OpenScanner()
    {
        _dotNetRefProdutos ??= DotNetObjectReference.Create((object)this);
        // use same container id as CaixaPage so scanner UI/behavior is identical
        await JS.InvokeVoidAsync("barcodeScanner.start", _dotNetRefProdutos, "barcode-scanner-container");
    }

    // The shared JS expects a method named OnBarcodeScanned; provide a wrapper that calls our handler
    [JSInvokable]
    public async Task OnBarcodeScanned(string code)
    {
        await OnBarcodeScanned_Produtos(code);
    }

    private string searchTerm = string.Empty;
    private List<Produto> filteredProdutos = new();
    private List<string> marcas = new();
    private string? selectedMarca = null;
    private List<string> sizesForMarca = new();
    private string? selectedSize = null;
    private List<string> flavorsForSelection = new();
    private Dictionary<string, Produto> flavorToProduct = new(StringComparer.OrdinalIgnoreCase);
    private List<Produto> allProdutos = new();
    
    private void PopulateMarcasFromProdutos(List<Produto> produtos)
    {
        var known = new[] { "Brahma", "Skol", "Antarctica", "Original", "Xereta", "Coca Cola", "Coca-Cola", "Fanta", "Heineken", "Budweiser", "Red Bull", "Gaterade", "Petra", "Pepsi",
        "Sukita", "Corona", "Tubaina", "Lacta", "Eisenbahn", "Baianinha", "Chapinha", "Askov", "Stella", "Monster", "Amstel", "Red label", "Del valle", "Sprite", "Fanta", "Imperio", "Baly",
        "Crystal", "Gorillaz" };
        var found = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        foreach (var p in produtos)
        {
            var txt = (p.Nome ?? string.Empty) + " " + (p.Detalhe ?? string.Empty);
            foreach (var k in known)
            {
                if (!found.Contains(k) && txt.IndexOf(k, StringComparison.OrdinalIgnoreCase) >= 0)
                    found.Add(k);
            }
        }
        // normalize certain brand variants (e.g. "Coca Cola" / "Coca-Cola" -> "Coca-cola")
        if (found.Remove("Coca Cola") | found.Remove("Coca-Cola"))
        {
            found.Add("Coca-cola");
        }
        marcas = found.OrderBy(m => m).ToList();
    }

    // return true if the given text contains the brand, accepting orthographic variants
    private bool BrandMatch(string text, string brand)
    {
        if (string.IsNullOrEmpty(text) || string.IsNullOrEmpty(brand)) return false;

        string NormalizeForMatch(string s)
        {
            if (string.IsNullOrEmpty(s)) return string.Empty;
            // lowercase, remove diacritics, normalize separators to space
            var lower = s.ToLowerInvariant();
            var formD = lower.Normalize(System.Text.NormalizationForm.FormD);
            var sb = new System.Text.StringBuilder();
            foreach (var ch in formD)
            {
                var cat = System.Globalization.CharUnicodeInfo.GetUnicodeCategory(ch);
                if (cat != System.Globalization.UnicodeCategory.NonSpacingMark)
                    sb.Append(ch);
            }
            var cleaned = sb.ToString();
            cleaned = cleaned.Replace('\u00A0', ' ');
            cleaned = cleaned.Replace('-', ' ');
            cleaned = cleaned.Replace('_', ' ');
            cleaned = System.Text.RegularExpressions.Regex.Replace(cleaned, "\\s+", " ").Trim();
            return cleaned;
        }

        var nText = NormalizeForMatch(text);
        var nBrand = NormalizeForMatch(brand);
        if (nText.Contains(nBrand, StringComparison.OrdinalIgnoreCase)) return true;

        // also check without any separators: e.g. "cocacola" in "coca cola"
        var noSepText = nText.Replace(" ", string.Empty);
        var noSepBrand = nBrand.Replace(" ", string.Empty);
        if (!string.IsNullOrEmpty(noSepBrand) && noSepText.Contains(noSepBrand, StringComparison.OrdinalIgnoreCase)) return true;

        return false;
    }

    private void OnSelectMarca(string? marca)
    {
        selectedMarca = marca;
        // clear dependent selections whenever brand changes
        sizesForMarca.Clear();
        selectedSize = null;
        flavorsForSelection.Clear();
        flavorToProduct.Clear();

        // filter product grid immediately for this brand
        if (string.IsNullOrEmpty(marca))
        {
            // reset to all
            filteredProdutos = allProdutos.ToList();
            return;
        }

        var sizes = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        foreach (var p in allProdutos)
        {
            if (BrandMatch((p.Nome ?? string.Empty) + " " + (p.Detalhe ?? string.Empty), marca))
            {
                var s = ExtractSizeFromName(p.Nome) ?? ExtractSizeFromName(p.Detalhe);
                if (!string.IsNullOrEmpty(s)) sizes.Add(s);
            }
        }
        if (!sizes.Any()) sizes.UnionWith(new[] { "600ml", "350ml", "1L", "2L", "269ml", "dose" });
        sizesForMarca = sizes.OrderBy(s => s).ToList();

        // filter product grid to this brand
        filteredProdutos = allProdutos.Where(p => BrandMatch((p.Nome ?? string.Empty) + " " + (p.Detalhe ?? string.Empty), marca)).ToList();
    }

    private string? ExtractSizeFromName(string? text)
    {
        if (string.IsNullOrEmpty(text)) return null;
        var lower = text.ToLowerInvariant();
        var candidates = new[] { "600ml", "350ml", "269ml", "1l", "2l", "500ml", "dose", "300ml", "250ml", "200ml", "330ml", "330 ml", "2000ml", "20g", "1kg", "35g", "880ml", "1.5L", "473ml",
        "275ml", "355ml" };
        foreach (var c in candidates)
        {
            if (lower.Contains(c)) return c.ToUpperInvariant();
        }
        return null;
    }

    private bool TryParseDecimalFlexible(string? s, out decimal value)
    {
        value = 0m;
        if (string.IsNullOrWhiteSpace(s)) return false;
        s = s.Trim();

        string normalized = s;
        bool hasDot = s.IndexOf('.') >= 0;
        bool hasComma = s.IndexOf(',') >= 0;

        if (hasDot && hasComma)
        {
            int lastDot = s.LastIndexOf('.');
            int lastComma = s.LastIndexOf(',');
            if (lastComma > lastDot)
            {
                normalized = s.Replace(".", string.Empty).Replace(',', '.');
            }
            else
            {
                normalized = s.Replace(",", string.Empty);
            }
        }
        else if (hasComma && !hasDot)
        {
            normalized = s.Replace(',', '.');
        }

        if (decimal.TryParse(normalized, NumberStyles.Number, CultureInfo.InvariantCulture, out var result))
        {
            value = result;
            return true;
        }

        if (decimal.TryParse(s, NumberStyles.Number, CultureInfo.CurrentCulture, out result))
        {
            value = result;
            return true;
        }

        return false;
    }

    private string? ExtractFlavorFromName(string? text)
    {
        if (string.IsNullOrEmpty(text)) return null;
        var lower = text.ToLowerInvariant();
        var candidates = new[] { "uva", "maçã", "maca", "laranja", "limão", "limao", "morango", "abacaxi", "cajú", "caju", "guaraná", "guarana",
        "cola", "baunilha", "chocolate", "melancia", "morango-maracuja", "zero", "sem açúcar", "maracuja", "Limonada", "Tanjerina", "black", "Tradicional", "Tropical", "maca verde",
        "f vermelhas", "manga", "morango e pêssego", "Maça verde", "Mango loco", "Pipeline" };
        foreach (var c in candidates)
        {
            if (lower.Contains(c)) return CultureInfo.CurrentCulture.TextInfo.ToTitleCase(c.Replace("ç","c"));
        }
        return null;
    }

    private void OnSelectSize(string? size)
    {
        selectedSize = size;
        // clear flavor selection when size changes
        flavorsForSelection.Clear();
        flavorToProduct.Clear();

        // if no size selected -> show brand products
        if (string.IsNullOrEmpty(size))
        {
            filteredProdutos = allProdutos.Where(p => ((p.Nome ?? string.Empty) + " " + (p.Detalhe ?? string.Empty)).IndexOf(selectedMarca ?? string.Empty, StringComparison.OrdinalIgnoreCase) >= 0).ToList();
            return;
        }

        // collect flavors for brand+size and filter products to brand+size
        var flavors = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        var brandAndSize = allProdutos.Where(p => BrandMatch((p.Nome ?? string.Empty) + " " + (p.Detalhe ?? string.Empty), selectedMarca ?? string.Empty)
            && (((p.Nome ?? string.Empty).IndexOf(size, StringComparison.OrdinalIgnoreCase) >= 0) || ((p.Detalhe ?? string.Empty).IndexOf(size, StringComparison.OrdinalIgnoreCase) >= 0))).ToList();

        foreach (var p in brandAndSize)
        {
            var f = ExtractFlavorFromName(p.Nome) ?? ExtractFlavorFromName(p.Detalhe);
            if (!string.IsNullOrEmpty(f)) flavors.Add(f);
        }

        flavorsForSelection = flavors.OrderBy(f => f).ToList();

        // populate flavor->product map for quick lookup (first match)
        flavorToProduct.Clear();
        foreach (var f in flavorsForSelection)
        {
            var match = brandAndSize.FirstOrDefault(p => (((p.Nome ?? string.Empty).IndexOf(f, StringComparison.OrdinalIgnoreCase) >= 0)
                || ((p.Detalhe ?? string.Empty).IndexOf(f, StringComparison.OrdinalIgnoreCase) >= 0)));
            if (match != null && !flavorToProduct.ContainsKey(f))
                flavorToProduct[f] = match;
            else if (match == null)
            {
                // try matching flavor against normalized brand variants as well
                var altFlavor = f.Replace('-', ' ');
                match = brandAndSize.FirstOrDefault(p => (((p.Nome ?? string.Empty).IndexOf(altFlavor, StringComparison.OrdinalIgnoreCase) >= 0)
                    || ((p.Detalhe ?? string.Empty).IndexOf(altFlavor, StringComparison.OrdinalIgnoreCase) >= 0)));
                if (match != null && !flavorToProduct.ContainsKey(f))
                    flavorToProduct[f] = match;
            }
        }

        // set filtered products to brand+size
        filteredProdutos = brandAndSize;
    }

    private void OnSelectFlavor(string flavor)
    {
        if (string.IsNullOrEmpty(flavor)) return;
        if (!flavorToProduct.TryGetValue(flavor, out var prod)) return;
        // filter products for current brand + size + flavor
        filteredProdutos = allProdutos.Where(p => ((p.Nome ?? string.Empty) + " " + (p.Detalhe ?? string.Empty)).IndexOf(selectedMarca ?? string.Empty, StringComparison.OrdinalIgnoreCase) >= 0
            && (((p.Nome ?? string.Empty).IndexOf(selectedSize ?? string.Empty, StringComparison.OrdinalIgnoreCase) >= 0) || ((p.Detalhe ?? string.Empty).IndexOf(selectedSize ?? string.Empty, StringComparison.OrdinalIgnoreCase) >= 0))
            && (((p.Nome ?? string.Empty).IndexOf(flavor, StringComparison.OrdinalIgnoreCase) >= 0) || ((p.Detalhe ?? string.Empty).IndexOf(flavor, StringComparison.OrdinalIgnoreCase) >= 0))).ToList();
    }

    private void ClearFlavors()
    {
        flavorsForSelection.Clear();
        flavorToProduct.Clear();
    }
    private List<Categoria> categorias = new();
    private Produto novoProduto = new Produto();
    private bool exibirFormulario = false;
    private Dictionary<int, bool> editandoProdutos = new();
    // temporary input buffers for editing prices so inputs can start empty
    private Dictionary<int, string> editPrecoQuenteInputs = new();
    private Dictionary<int, string> editPrecoGeladaInputs = new();

    protected override async Task OnInitializedAsync()
    {
        var nome = await JS.InvokeAsync<string>("sessionStorage.getItem", "Email");
        if (string.IsNullOrEmpty(nome))
        {
            Navigation.NavigateTo("login");
            return;
        }

        var (todosProdutos, _) = await _apiService.GetTodosProdutos();
        filteredProdutos = todosProdutos ?? new List<Produto>();
        allProdutos = filteredProdutos.ToList();
        PopulateMarcasFromProdutos(allProdutos);

        var (cats, _) = await _apiService.GetCategorias();
        categorias = cats ?? new List<Categoria>();
    }

    private async Task Search(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;

        var (todosProdutos, _) = await _apiService.GetTodosProdutos();
        var all = todosProdutos ?? new List<Produto>();

        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredProdutos = all;
            return;
        }

        var term = searchTerm.Trim();
        filteredProdutos = all
            .Where(p => (!string.IsNullOrEmpty(p.Nome) && p.Nome.Contains(term, StringComparison.OrdinalIgnoreCase))
                     || (!string.IsNullOrEmpty(p.Barcode) && p.Barcode.Equals(term, StringComparison.OrdinalIgnoreCase)))
            .ToList();
    }

    private void MostrarFormulario()
    {
        novoProduto = new Produto();
        exibirFormulario = true;
    }

    private void Cancelar()
    {
        exibirFormulario = false;
    }

    private async Task AdicionarProduto()
    {
        await _apiService.AdicionarProdutoAsync(novoProduto);
        var (todosProdutos, _) = await _apiService.GetTodosProdutos();
        filteredProdutos = todosProdutos ?? new List<Produto>();
        exibirFormulario = false;
    }

    private async Task ExcluirProduto(int id)
    {
        bool ok = await JS.InvokeAsync<bool>("confirm", "Tem certeza que deseja excluir este produto?");
        if (!ok) return;
        var sucesso = await _apiService.ExcluirProdutoAsync(id);
        if (sucesso)
        {
            var (todosProdutos, _) = await _apiService.GetTodosProdutos();
            filteredProdutos = todosProdutos ?? new List<Produto>();
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Erro ao excluir o produto.");
        }
    }

    private void EditarProduto(int id)
    {
        editandoProdutos[id] = true;
        // initialize temp inputs empty so user types fresh values
        editPrecoQuenteInputs[id] = string.Empty;
        editPrecoGeladaInputs[id] = string.Empty;
    }

    private Task EditRowClicked(int id)
    {
        if (editandoProdutos.ContainsKey(id) && editandoProdutos[id])
            return Task.CompletedTask;
        editandoProdutos[id] = true;
        // initialize temp inputs empty when entering edit mode via row click
        editPrecoQuenteInputs[id] = string.Empty;
        editPrecoGeladaInputs[id] = string.Empty;
        return Task.CompletedTask;
    }

    private async Task SalvarEdicao(Produto produto)
    {
        // If user typed new prices in the temporary inputs, apply them to the model before saving
        if (editPrecoQuenteInputs.TryGetValue(produto.Id, out var precoQStr) && !string.IsNullOrWhiteSpace(precoQStr))
        {
            if (TryParseDecimalFlexible(precoQStr, out var precoQ))
                produto.PrecoQuente = Math.Round(precoQ, 2);
        }

        if (editPrecoGeladaInputs.TryGetValue(produto.Id, out var precoGStr) && !string.IsNullOrWhiteSpace(precoGStr))
        {
            if (TryParseDecimalFlexible(precoGStr, out var precoG))
                produto.PrecoGelada = Math.Round(precoG, 2);
        }

        var sucesso = await _apiService.AtualizarProduto(produto.Id, produto);
            if (sucesso)
        {
            editandoProdutos[produto.Id] = false;

            // If no brand filter is active, refresh full list from server.
            // Preserve current searchTerm so the user's filter remains active after save.
            if (string.IsNullOrEmpty(selectedMarca))
            {
                var (todosProdutos, _) = await _apiService.GetTodosProdutos();
                allProdutos = todosProdutos ?? new List<Produto>();

                if (string.IsNullOrWhiteSpace(searchTerm))
                {
                    filteredProdutos = allProdutos.ToList();
                }
                else
                {
                    var term = searchTerm.Trim();
                    filteredProdutos = allProdutos
                        .Where(p => (!string.IsNullOrEmpty(p.Nome) && p.Nome.Contains(term, StringComparison.OrdinalIgnoreCase))
                                 || (!string.IsNullOrEmpty(p.Barcode) && p.Barcode.Equals(term, StringComparison.OrdinalIgnoreCase)))
                        .ToList();
                }

                PopulateMarcasFromProdutos(allProdutos);
            }
            else
            {
                // update item in allProdutos
                var ai = allProdutos.FindIndex(p => p.Id == produto.Id);
                if (ai >= 0) allProdutos[ai] = produto;

                // update item in filteredProdutos
                var fi = filteredProdutos.FindIndex(p => p.Id == produto.Id);
                if (fi >= 0) filteredProdutos[fi] = produto;
            }

            // clear temp inputs for this produto
            if (editPrecoQuenteInputs.ContainsKey(produto.Id)) editPrecoQuenteInputs.Remove(produto.Id);
            if (editPrecoGeladaInputs.ContainsKey(produto.Id)) editPrecoGeladaInputs.Remove(produto.Id);
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Erro ao atualizar produto.");
        }
    }

    private void CancelarEdicao(int id)
    {
        editandoProdutos[id] = false;
        // clear temp inputs when cancelling
        if (editPrecoQuenteInputs.ContainsKey(id)) editPrecoQuenteInputs.Remove(id);
        if (editPrecoGeladaInputs.ContainsKey(id)) editPrecoGeladaInputs.Remove(id);
    }

    private void OnEditPrecoQuenteInput(int produtoId, ChangeEventArgs e)
    {
        var s = e?.Value?.ToString() ?? string.Empty;
        editPrecoQuenteInputs[produtoId] = s;
    }

    private void OnEditPrecoGeladaInput(int produtoId, ChangeEventArgs e)
    {
        var s = e?.Value?.ToString() ?? string.Empty;
        editPrecoGeladaInputs[produtoId] = s;
    }
}
