<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rota019</title>
    <base href="./" />

    <!-- ✅ Bootstrap via CDN (sem arquivos locais) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Seu CSS e manifestos -->
    <link href="css/app.css" rel="stylesheet" />
    <link href="BlazorDeploy.styles.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="logo.png" />
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="apple-touch-icon" sizes="512x512" href="logo.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="logo.png" />

    <!-- Google Places API (mantido, caso ainda use) -->
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBy_9neF5tiB38rjc9FiZjbP7H13JS-OZI&libraries=places&v=weekly&region=BR&language=pt-BR&components=element"></script>
    <script type="module" src="https://unpkg.com/@googlemaps/places-widget-element/dist/places-widget-element.js"></script>
    <script src="js/autocomplete.js"></script>
    <script src="js/triggerFileInput.js"></script>
    <script src="js/barcodeScanner.js"></script>
    <script src="js/layout-utils.js"></script>


</head>


<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>
    <script src="_framework/blazor.webassembly.js"></script>

    <script>
        // keyHandler: expose F1 handler that calls .NET OnF1Key via DotNetObjectReference
        (function () {
            var dotNetRefF1 = null;
            function f1Handler(e) {
                try {
                    if (e.key === 'F1') {
                        e.preventDefault();
                        if (dotNetRefF1) {
                            try { dotNetRefF1.invokeMethodAsync('OnF1Key'); } catch (ex) { }
                        }
                    }
                } catch (ex) { }
            }

            window.keyHandler = {
                addF1Handler: function (dref) {
                    try {
                        dotNetRefF1 = dref;
                        window.addEventListener('keydown', f1Handler);
                    } catch (e) { }
                },
                removeF1Handler: function () {
                    try {
                        window.removeEventListener('keydown', f1Handler);
                        dotNetRefF1 = null;
                    } catch (e) { }
                }
            };
        })();

        // Global ESC handler registration for Blazor pages
        (function () {
            var dotRef = null;
            function onKeyDown(e) {
                try {
                    // Always handle Escape: hide numeric keypad and notify .NET
                    if (e.key === 'Escape') {
                        try { if (window.numericKeypad && typeof window.numericKeypad.hide === 'function') window.numericKeypad.hide(); } catch (ex) { }
                        if (dotRef) {
                            try { dotRef.invokeMethodAsync('OnEscapePressed'); } catch { }
                        }
                        return;
                    }
                } catch (ex) { }

                try {
                    // ignore other keys when typing in inputs/textareas/selects
                    var tag = (document.activeElement && document.activeElement.tagName) ? document.activeElement.tagName.toUpperCase() : '';
                    if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT' || tag === 'OPTION') return;
                } catch (ex) { }

                // detect plus: main keyboard '+' (Shift+'='), Numpad add
                var isPlus = false;
                try {
                    if (e.key === '+') isPlus = true;
                    if (e.code === 'NumpadAdd') isPlus = true;
                    if (e.key === 'Add') isPlus = true;
                    if (e.key === '=' && e.shiftKey) isPlus = true;
                } catch (ex) { }

                if (isPlus && dotRef) {
                    try {
                        // prevent browser from inserting the '+' character into any focused input
                        try { e.preventDefault(); } catch (ex) { }
                        dotRef.invokeMethodAsync('OnPlusPressed');
                    } catch { }
                }
            }
            window.addGlobalEscHandler = function (dref) {
                try {
                    dotRef = dref;
                    window.addEventListener('keydown', onKeyDown);
                } catch { }
            };
            window.removeGlobalEscHandler = function () {
                try {
                    window.removeEventListener('keydown', onKeyDown);
                    dotRef = null;
                } catch { }
            };
        // helper to focus the last blank descricao textarea (prefer the most recently added)
        window.focusFirstBlankDescricao = function () {
            try {
                var els = document.querySelectorAll("textarea[placeholder='Descrição']");
                if (els && els.length) {
                    var el = els[els.length - 1];
                    // remove a leading '+' that may have been typed while adding the item
                    try {
                        if (el.value && el.value.length > 0 && el.value.charAt(0) === '+') {
                            el.value = el.value.replace(/^\+/, '');
                            // notify Blazor of the change
                            el.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    } catch (e) { }
                    el.focus();
                    try { el.scrollIntoView({ block: 'center', behavior: 'smooth' }); } catch (e) { }
                }
            } catch (e) { }
        };
        })();

        // Numeric keypad implementation removed for iOS compatibility.
        // Provide a safe no-op shim so any remaining calls from components or global handlers do not fail.
        window.numericKeypad = window.numericKeypad || {
            _target: null,
            show: function (elementId) { try { /* no-op */ } catch (e) { } },
            hide: function () { try { /* no-op */ } catch (e) { } },
            insert: function (elementId, ch) { try { /* no-op */ } catch (e) { } },
            backspace: function (elementId) { try { /* no-op */ } catch (e) { } },
            commit: function (elementId) { try { /* no-op */ } catch (e) { } }
        };
    </script>

    <script>
        // Register service worker only when supported. Wrap in try/catch to avoid
        // breaking the app on browsers (or hosting environments) that reject
        // service worker registration (e.g. some mobile browsers or GitHub Pages setups).
        try {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js').catch(function (err) {
                    console.warn('Service worker registration failed:', err);
                });
            }
        } catch (e) {
            console.warn('Service worker registration error:', e);
        }
    </script>
</body>

</html>
