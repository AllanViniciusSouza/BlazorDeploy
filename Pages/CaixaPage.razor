@page "/"
@page "/caixa"
@inject ApiService _apiService
@inject AuthService AuthService
@inject IJSRuntime JS
@inject IValidator Validator
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using System.Globalization

@inject NavigationManager Navigation

<PageTitle>Caixa</PageTitle>

@if (!string.IsNullOrEmpty(initializationError))
{
    <div class="alert alert-danger mb-3">Erro ao inicializar página: @initializationError</div>
}

@* Debug panel removed *@



@* compact vendor + client inputs shown at bottom (rendered near cart) *@


    <div class="card shadow-sm p-3 mb-4 bg-dark text-white">
    <div class="d-flex align-items-center justify-content-between mb-2">
        <h4 class="fw-bold text-white mb-0">Produtos</h4>
        <button class="btn btn-sm btn-outline-primary ms-2" title="Abrir Leitor (câmera)" @onclick="OpenScanner" aria-label="Abrir leitor de códigos">
            <!-- simple camera SVG icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                <path d="M10.5 2a.5.5 0 0 1 .5.5V3h1.5A1.5 1.5 0 0 1 14 4.5v7A1.5 1.5 0 0 1 12.5 13H3.5A1.5 1.5 0 0 1 2 11.5v-7A1.5 1.5 0 0 1 3.5 3H5v-.5a.5.5 0 0 1 .5-.5h5zM8 5a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>
                <path d="M8 6.5a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3z"/>
            </svg>
        </button>
    </div>

                @* removed explicit cart-selection radios; products always add to active cart *@

    <div class="row g-3 mb-3">
        <div class="col-12">
            @if (string.IsNullOrEmpty(selectedMarca))
            {
                <input id="searchInput" class="form-control form-control-lg"
                       placeholder="Pesquisar por nome ou código de barras"
                       value="@searchTerm"
                       @oninput="@(e => { searchTerm = e?.Value?.ToString() ?? string.Empty; _ = SearchProducts(e); })"
                       @onkeydown="OnSearchKeyDown" />
            }

@* keyboard handlers moved into @code block to avoid rendering as text *@

@* Numeric keypad removed — iOS issues suspected. *@

@code {
    private string GetDataPagamentoPrazoClass() => dataPagamentoPrazo.HasValue ? "form-control w-auto border-3 border-primary" : "form-control w-auto border-3 border-danger";
    private string GetDataPagamentoPrazo2Class() => dataPagamentoPrazo2.HasValue ? "form-control w-auto border-3 border-primary" : "form-control w-auto border-3 border-secondary";
    private DotNetObjectReference<object>? _escDotRef;
    private bool focusSearchRequested = false;

    [JSInvokable]
    public async Task OnProductNumberShortcut(int number)
    {
        // Only works when product list is visible
        if (!showProductList || !filteredProdutos.Any()) return;

        if (number >= 1 && number <= filteredProdutos.Count)
        {
            try 
            { 
                await JS.InvokeVoidAsync("console.log", $"OnProductNumberShortcut: Selecting product at index {number}"); 
            } 
            catch { }
            
            var selectedProduto = filteredProdutos[number - 1];
            OpenQuantityModal(selectedProduto);
            await InvokeAsync(StateHasChanged);
        }
    }

    [JSInvokable]
    public async Task OnPaymentShortcut(string formaPagamento)
    {
        await SetFormaPagamento(formaPagamento);
        await InvokeAsync(StateHasChanged);
    }

    private void CloseAllModals()
    {
        showQuantityModal = false;
        showCreateProductModal = false;
        StateHasChanged();
    }

    private bool pointerLoggingEnabled = false;
    private async Task TogglePointerLogging()
    {
        pointerLoggingEnabled = !pointerLoggingEnabled;
        if (pointerLoggingEnabled)
        {
            try
            {
                await JS.InvokeVoidAsync("eval", @"(function(){ window._copilotPointerLogger = function(e){ try{ console.log('pointerdown target=', e.target, 'x=', e.clientX, 'y=', e.clientY); }catch{} }; window.addEventListener('pointerdown', window._copilotPointerLogger); })();");
            }
            catch { }
        }
        else
        {
            try
            {
                await JS.InvokeVoidAsync("eval", @"(function(){ try{ window.removeEventListener('pointerdown', window._copilotPointerLogger); }catch(e){} window._copilotPointerLogger = null; })();");
            }
            catch { }
        }
        StateHasChanged();
    }

    private void ClearAllFilters()
    {
        selectedMarca = null;
        selectedSize = null;
        flavorsForSelection.Clear();
        flavorToProduct.Clear();
        searchTerm = string.Empty;
        filteredProdutos = maisVendidos ?? new();
        showProductList = filteredProdutos.Any();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Aguardar um pouco para garantir que o JavaScript está carregado
                await Task.Delay(100);
                
                _escDotRef ??= DotNetObjectReference.Create((object)this);
                await JS.InvokeVoidAsync("addGlobalEscHandler", _escDotRef);
                
                // Log para debug (visível no console do navegador)
                await JS.InvokeVoidAsync("console.log", "[Blazor] Global keyboard handlers registered successfully");
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("console.error", $"[Blazor] Failed to register keyboard handlers: {ex.Message}");
            }
            // request focus for search input on first render
            focusSearchRequested = true;
        }

        if (focusSearchRequested)
        {
            focusSearchRequested = false;
            try { await JS.InvokeVoidAsync("eval", "document.getElementById('searchInput')?.focus()"); } catch { }
        }
    }

    [JSInvokable]
    public async Task OnEscapePressed()
    {
        try { await JS.InvokeVoidAsync("console.log", $"[C#] OnEscapePressed called - showQuantityModal={showQuantityModal}, showCreateProductModal={showCreateProductModal}"); } catch { }
        
        // If quantity modal is open, close it instead of clearing filters
        if (showQuantityModal)
        {
            try { await JS.InvokeVoidAsync("console.log", "[C#] Closing quantity modal, preserving filters"); } catch { }
            CloseModal();
            await InvokeAsync(StateHasChanged);
            return;
        }

        // If create product modal is open, close it instead of clearing filters
        if (showCreateProductModal)
        {
            try { await JS.InvokeVoidAsync("console.log", "[C#] Closing create product modal, preserving filters"); } catch { }
            CancelCreateProduct();
            await InvokeAsync(StateHasChanged);
            return;
        }

        // No modals open - clear filters normally
        try { await JS.InvokeVoidAsync("console.log", "[C#] No modals open, clearing filters"); } catch { }
        ClearAllFilters();
        try { await JS.InvokeVoidAsync("numericKeypad.hide"); } catch { }
        await InvokeAsync(StateHasChanged);
        
        // Return focus to search input after clearing filters
        await Task.Delay(50); // give UI time to update
        try 
        { 
            await JS.InvokeVoidAsync("eval", "document.getElementById('searchInput')?.focus()"); 
        } 
        catch { }
    }

    [JSInvokable]
    public async Task OnTemperatureShortcut(string? temperatura)
    {
        // Only works when quantity modal is open
        if (!showQuantityModal) return;

        selectedTemperatura = temperatura;
        await InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public async Task OnVendedorShortcut(string vendedor)
    {
        OnVendedorSelected(vendedor);
        await InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public async Task OnStatusShortcut(string status)
    {
        PedidoStatus = status;
        await InvokeAsync(StateHasChanged);
    }

    [JSInvokable]
    public async Task OnEnterToFinalize()
    {
        // Only finalize if button is visible (all conditions met)
        if (CanShowFinalizeButton())
        {
            await FinalizePurchase();
            await InvokeAsync(StateHasChanged);
        }
    }

    private bool CanShowFinalizeButton()
    {
        var effectiveForma = !string.IsNullOrEmpty(activeCart.FormaPagamentoSelecionada) ? activeCart.FormaPagamentoSelecionada : formaPagamentoSelecionada;
        var effectiveVendedor = !string.IsNullOrEmpty(activeCart.VendedorNome) ? activeCart.VendedorNome : vendedorNome;
        var effectivePedido = !string.IsNullOrEmpty(activeCart.PedidoStatus) ? activeCart.PedidoStatus : pedidoStatus;

        bool canShowFinalize = activeCart.Items.Any()
            && !string.IsNullOrEmpty(effectiveForma)
            && !string.IsNullOrEmpty(effectivePedido)
            && !isProcessing
            && !string.IsNullOrEmpty(effectiveVendedor);

        if (string.Equals(effectiveForma, "A Prazo", StringComparison.OrdinalIgnoreCase))
        {
            var due = activeCart.DataPagamentoPrazo ?? dataPagamentoPrazo;
            var cliente = !string.IsNullOrWhiteSpace(activeCart.ClienteNome) ? activeCart.ClienteNome : clienteNome;
            canShowFinalize = canShowFinalize && due.HasValue && !string.IsNullOrWhiteSpace(cliente);
        }

        if (canShowFinalize)
        {
            var totalCarrinho = activeCart.Items.Sum(p => p.Total);
            var valorPag1 = activeCart.Pagamento1 ?? 0m;
            var valorPag2 = activeCart.UsarPagamento2 ? (activeCart.Pagamento2 ?? 0m) : 0m;
            var somaPagamentos = valorPag1 + valorPag2;
            
            canShowFinalize = somaPagamentos >= totalCarrinho;
        }

        return canShowFinalize;
    }

    private void PrevCart()
    {
        if (carts.Count <= 1) return;
        var next = activeCartIndex - 1;
        if (next < 0) next = carts.Count - 1; // wrap
        _ = SwitchToCart(next);
    }

    private void NextCart()
    {
        if (carts.Count <= 1) return;
        var next = (activeCartIndex + 1) % carts.Count;
        _ = SwitchToCart(next);
    }

    [JSInvokable]
    public async Task OnPlusPressed()
    {
        // add blank item and focus description
        await AddBlankCartItem();
        await InvokeAsync(async () => {
            StateHasChanged();
            try { await JS.InvokeVoidAsync("focusFirstBlankDescricao"); } catch { }
        });
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("removeGlobalEscHandler");
        }
        catch { }
        try { _escDotRef?.Dispose(); } catch { }
    }
}
        </div>
    </div>

    @* Brand quick-filter cards - only show when search is empty *@
    @if (marcas != null && marcas.Any() && string.IsNullOrEmpty(searchTerm))
    {
        <div class="mb-3">
            <label class="form-label fw-bold">Marcas</label>
            <div class="brand-list" style="font-size:0.85rem;">
                @if (string.IsNullOrEmpty(selectedMarca))
                {
                    <div class="d-flex flex-row flex-wrap" style="gap:1rem; align-items:flex-start;">
                        @foreach (var group in marcas.GroupBy(m => char.ToUpperInvariant((!string.IsNullOrWhiteSpace(m) ? m.Trim()[0] : '?'))).OrderBy(g => g.Key))
                        {
                            <div style="min-width:90px;">
                                <div class="fw-bold text-white mb-1">@group.Key</div>
                                @foreach (var m in group.OrderBy(x => x))
                                {
                                    <button class="brand-item text-white text-start p-0 mb-1" style="background:none; border:none; display:block; width:100%; padding:0.12rem 0;" @onclick="() => OnSelectMarca(m)">@m</button>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div>
                        <span class="fw-bold text-white">@selectedMarca</span>
                        <button class="btn btn-sm btn-outline-secondary ms-2" @onclick="() => OnSelectMarca(null)">Limpar</button>
                    </div>
                }
            </div>
        </div>
    }

    @* Size options for selected brand - only show when search is empty *@
    @if (!string.IsNullOrEmpty(selectedMarca) && sizesForMarca != null && sizesForMarca.Any() && string.IsNullOrEmpty(searchTerm))
    {
        <div class="mb-3">
            <label class="form-label fw-bold">Opções para @selectedMarca</label>
            <div class="d-flex flex-wrap gap-2">
                @foreach (var size in sizesForMarca)
                {
                    <div class="card p-2 bg-dark text-white" style="min-width:140px; cursor:pointer;" @onclick="() => OnSelectSize(size)">
                        <div class="fw-bold">@size</div>
                    </div>
                }
            </div>
        </div>
    }

    @* Flavor cards shown after selecting size (if available) - only show when search is empty *@
    @if (flavorsForSelection != null && flavorsForSelection.Any() && string.IsNullOrEmpty(searchTerm))
    {
        <div class="mb-3">
            <label class="form-label fw-bold">Sabores para @selectedMarca @selectedSize</label>
            <div class="d-flex flex-wrap gap-2">
                @foreach (var f in flavorsForSelection)
                {
                    <div class="card p-2 bg-dark text-white" style="min-width:120px; cursor:pointer;" @onclick="() => OnSelectFlavor(f)">
                        <div class="fw-bold">@f</div>
                    </div>
                }
                <button class="btn btn-sm btn-outline-secondary" @onclick="() => ClearFlavors()">Limpar</button>
            </div>
        </div>
    }

    @if (showProductList)
    {
        <div style="max-height: 480px; overflow-y: auto;">
            <div class="row row-cols-2 row-cols-sm-3 row-cols-md-6 g-2">
                @for (int i = 0; i < filteredProdutos.Count; i++)
                {
                    var Produto = filteredProdutos[i];
                    var index = i + 1;
                    var hasShortcut = index >= 1 && index <= 9;
                    <div class="col">
                    <div class="card h-100 shadow-sm small" style="cursor:pointer; position:relative; @(!hasShortcut ? "opacity:0.7;" : "")">
                            <div class="card-body p-2 d-flex flex-column" @onclick="() => OpenQuantityModal(Produto)">
                                <div class="card-title mb-2" title="@Produto.Nome" style="font-size:0.95rem; white-space:normal; font-weight:600; color:#212529;">@Produto.Nome</div>
                                <div class="d-flex gap-3 mt-auto justify-content-center">
                                    <div class="text-center">
                                        <div class="small mb-1" style="font-size:0.75rem; font-weight:600; color:#6c757d; text-transform:uppercase; letter-spacing:0.5px;">Quente</div>
                                        <div class="fw-bold" style="font-size:1.15rem; color:#dc3545;">R$ @(Produto.PrecoQuente > 0 ? Produto.PrecoQuente.ToString("0.00") : GetProdutoDisplayPrice(Produto).ToString("0.00"))</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="small mb-1" style="font-size:0.75rem; font-weight:600; color:#6c757d; text-transform:uppercase; letter-spacing:0.5px;">Gelado</div>
                                        <div class="fw-bold" style="font-size:1.15rem; color:#0d6efd;">R$ @(Produto.PrecoGelada > 0 ? Produto.PrecoGelada.ToString("0.00") : GetProdutoDisplayPrice(Produto).ToString("0.00"))</div>
                                    </div>
                                </div>
                            </div>
                            @if (hasShortcut)
                            {
                                <div style="position:absolute; bottom:4px; right:4px; z-index:10;">
                                    <span class="badge bg-primary" style="font-size:0.9rem; font-weight:bold; padding:0.35rem 0.5rem;">@index</span>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>
@* create-from-barcode modal *@
@if (showCreateProductModal)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block">
        <div class="modal-dialog modal-md mt-5">
            <div class="modal-content p-4 shadow-lg">
                <h5 class="fw-bold text-center">Cadastrar Produto (código: @newProductForBarcode.Barcode)</h5>

                <div class="mb-3">
                    <label class="form-label">Nome</label>
                    <input class="form-control" @bind="newProductForBarcode.Nome" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Preço (padrão)</label>
                    <input type="number" step="0.01" class="form-control" @bind="newProductForBarcode.Preco" />
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Preço Quente (opcional)</label>
                        <input type="number" step="0.01" class="form-control" @bind="newProductForBarcode.PrecoQuente" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Preço Gelada (opcional)</label>
                        <input type="number" step="0.01" class="form-control" @bind="newProductForBarcode.PrecoGelada" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Preço Custo (opcional)</label>
                        <input type="number" step="0.01" class="form-control" @bind="newProductForBarcode.PrecoCusto" />
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-3">
                    <button class="btn btn-secondary btn-lg" @onclick="CancelCreateProduct">Cancelar</button>
                    <button class="btn btn-primary btn-lg" @onclick="CreateProductFromBarcode">Cadastrar e Adicionar</button>
                </div>
            </div>
        </div>
    </div>
}


<div class="card shadow-sm p-3 mb-4 bg-dark text-white">
    <div class="d-flex align-items-center justify-content-between">
        <h4 class="fw-bold text-white mb-0">Carrinho @(activeCartIndex + 1)</h4>
@*         <span class="badge bg-secondary ms-2">Ativo: @(activeCartIndex + 1)</span>
 *@        <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-sm btn-outline-light" @onclick="PrevCart">Anterior</button>
            <div class="text-white">Carrinho <strong>@(activeCartIndex + 1)</strong> / @carts.Count</div>
            <button type="button" class="btn btn-sm btn-outline-light" @onclick="NextCart">Próximo</button>
            <button type="button" class="btn btn-sm btn-success ms-2" title="Adicionar novo carrinho" @onclick="@(async () => await AddNewCart())">+</button>
        </div>
    </div>
    
    @* Fixed vertical cart switcher on right side (high z-index) - visible and clickable even with dark background. *@
    @* Simplified cart controls (removed fixed vertical switcher that caused click issues) *@

    <table class="table table-bordered table-striped align-middle mt-2">
        <thead class="table-dark">
            <tr>
                <th>Produto</th>
                <th>Valor Unit.</th>
                <th>Qtd</th>
                <th>Total</th>
                <th class="text-center">&nbsp;</th>
            </tr>
        </thead>
    <tbody>
                @for (int i = 0; i < activeCart.Items.Count; i++)
            {
                var item = activeCart.Items[i];
                var idx = i;
                <tr>
                    <td>
                        @if (item.Produto == null || item.Produto.Id == 0)
                        {
                            // use a textarea so text wraps as user types
                            <textarea class="form-control form-control-sm" placeholder="Descrição"
                                      style="width:100%; min-width:0; white-space:pre-wrap; overflow-wrap:break-word; resize:vertical;"
                                      rows="2"
                                      @bind="item.Produto.Nome" @bind:event="oninput"></textarea>
                        }
                        else
                        {
                            <span class="fw-bold">@item.Produto.Nome</span>
                        }
                    </td>

                    <td>
                        @if (item.Produto == null || item.Produto.Id == 0)
                        {
                            <input id="price_@idx" type="text" inputmode="decimal" pattern="[0-9.,]*"
                                   class="form-control form-control-sm text-end"
                                   value="@(idx >= 0 && idx < priceInputs.Count ? priceInputs[idx] : string.Empty)"
                                   @oninput="@(e => OnPrecoUnitarioTyping(idx, e))"
                                   @onchange="@(e => OnPrecoUnitarioCommit(idx, e))"
                                   @onfocus:preventDefault @onblur:preventDefault />
                        }
                        else
                        {
                            <input id="price_@idx" type="number" step="0.01" class="form-control form-control-sm text-end"
                                   @bind="activeCart.Items[idx].PrecoUnitario" @bind:event="oninput" @bind:after="UpdateCartTotals"
                                   @onfocus:preventDefault @onblur:preventDefault />
                        }
                    </td>

                    <td>
                        <input id="qty_@idx" type="number" min="1"
                               class="form-control form-control-sm text-center"
                               @bind="item.Quantidade" @bind:after="UpdateCartTotals"
                               @onfocus:preventDefault @onblur:preventDefault />
                    </td>

                    <td class="fw-bold">R$ @item.Total.ToString("0.00")</td>

                    <td>
                        <button class="btn btn-danger btn-sm"
                                @onclick="@(() => RemoveFromCart(item))">
                            X
                        </button>
                    </td>
                </tr>
            }
            <!-- add-row: keeps the add-blank-item button always below the last cart row -->
            <tr>
                <td colspan="5" class="text-center">
                    <button class="btn btn-success btn-sm" title="Adicionar item livre" @onclick="AddBlankCartItemAndFocus">+</button>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="row g-3 mb-3">
        @* Coluna 1: Vendedor e Status *@
        <div class="col-md-4 order-md-1">
                    <!-- Vendedores -->
                    <div class="mb-3">
                        <label class="form-label fw-bold text-white" style="font-size:0.9rem;">Vendedor</label>
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                            @if (vendedores != null && vendedores.Any())
                            {
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="vendedor_inline" id="v_inline_Ronaldo" @onchange='() => OnVendedorSelected("Ronaldo")' checked="@(activeCart.VendedorNome == "Ronaldo")" />
                                    <label class="form-check-label ms-1 text-white" for="v_inline_Ronaldo" style="font-size:0.85rem;">R - Ronaldo</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="vendedor_inline" id="v_inline_Nathan" @onchange='() => OnVendedorSelected("Nathan")' checked="@(activeCart.VendedorNome == "Nathan")" />
                                    <label class="form-check-label ms-1 text-white" for="v_inline_Nathan" style="font-size:0.85rem;">N - Nathan</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="vendedor_inline" id="v_inline_Carlinhos" @onchange='() => OnVendedorSelected("Carlinhos")' checked="@(activeCart.VendedorNome == "Carlinhos")" />
                                    <label class="form-check-label ms-1 text-white" for="v_inline_Carlinhos" style="font-size:0.85rem;">E - Carlinhos</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="vendedor_inline" id="v_inline_Allan" @onchange='() => OnVendedorSelected("Allan")' checked="@(activeCart.VendedorNome == "Allan")" />
                                    <label class="form-check-label ms-1 text-white" for="v_inline_Allan" style="font-size:0.85rem;">V - Allan</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="vendedor_inline" id="v_inline_Beatriz" @onchange='() => OnVendedorSelected("Beatriz")' checked="@(activeCart.VendedorNome == "Beatriz")" />
                                    <label class="form-check-label ms-1 text-white" for="v_inline_Beatriz" style="font-size:0.85rem;">S - Beatriz</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="vendedor_inline" id="v_inline_Kayke" @onchange='() => OnVendedorSelected("Kayke")' checked="@(activeCart.VendedorNome == "Kayke")" />
                                    <label class="form-check-label ms-1 text-white" for="v_inline_Kayke" style="font-size:0.85rem;">K - Kayke</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="vendedor_inline" id="v_inline_outro" @onchange="() => OnOtherVendedorSelected()" checked="@activeCart.IsOtherVendedorSelected" />
                                    <label class="form-check-label ms-1 text-white" for="v_inline_outro" style="font-size:0.85rem;">Outro</label>
                                </div>
                                @if (activeCart.IsOtherVendedorSelected)
                                {
                                    <input class="form-control form-control-sm" @bind="activeCart.VendedorNome" placeholder="Digite o nome" style="font-size:0.85rem; width: 150px;" />
                                }
                            }
                        </div>
                    </div>

                    @* Status do Pedido *@
                    <div class="mb-3">
                        <label class="form-label fw-bold text-white" style="font-size:0.9rem;">Status</label>
                        <div class="d-flex flex-wrap gap-2 align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="statusPedido" id="status_finalizado" value="Finalizado" checked='@(PedidoStatus == "Finalizado")' @onclick='() => PedidoStatus = "Finalizado"' />
                                <label class="form-check-label ms-1 text-white" for="status_finalizado" style="font-size:0.85rem;">F - Finalizado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="statusPedido" id="status_retirada" value="Retirada" checked='@(PedidoStatus == "Retirada")' @onclick='() => PedidoStatus = "Retirada"' />
                                <label class="form-check-label ms-1 text-white" for="status_retirada" style="font-size:0.85rem;">T - Retirada</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="statusPedido" id="status_entrega" value="Em entrega" checked='@(PedidoStatus == "Em entrega")' @onclick='() => PedidoStatus = "Em entrega"' />
                                <label class="form-check-label ms-1 text-white" for="status_entrega" style="font-size:0.85rem;">M - Em entrega</label>
                            </div>
                        </div>
                    </div>
                </div>

        @* Coluna 2: Forma de Pagamento *@
        <div class="col-md-4 order-md-2">
                    <div class="card p-2 bg-transparent border-0">
                        <label class="form-label fw-bold text-white" style="font-size:0.9rem;">Forma de Pagamento</label>
                        <div class="d-flex flex-column gap-1 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="pag1" value="Dinheiro" checked='@(formaPagamentoSelecionada == "Dinheiro")' @onclick='() => SetFormaPagamento("Dinheiro")' />
                                <label class="form-check-label ms-1 text-white" for="pag1_dinheiro" style="font-size:0.85rem;">D - Dinheiro</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="pag1" value="Credito" checked='@(formaPagamentoSelecionada == "Credito")' @onclick='() => SetFormaPagamento("Credito")' />
                                <label class="form-check-label ms-1 text-white" style="font-size:0.85rem;">C - Crédito</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="pag1" value="Debito" checked='@(formaPagamentoSelecionada == "Debito")' @onclick='() => SetFormaPagamento("Debito")' />
                                <label class="form-check-label ms-1 text-white" style="font-size:0.85rem;">B - Débito</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="pag1" value="Pix" checked='@(formaPagamentoSelecionada == "Pix")' @onclick='() => SetFormaPagamento("Pix")' />
                                <label class="form-check-label ms-1 text-white" style="font-size:0.85rem;">P - Pix</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="pag1" value="A Prazo" checked='@(formaPagamentoSelecionada == "A Prazo")' @onclick='() => SetFormaPagamento("A Prazo")' />
                                <label class="form-check-label ms-1 text-white" style="font-size:0.85rem;">A - A Prazo</label>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(activeCart.FormaPagamentoSelecionada))
                        {
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="usar_pag2" @bind="activeCart.UsarPagamento2" @bind:after="OnUsarPagamento2Changed" />
                                <label class="form-check-label ms-1 text-white" for="usar_pag2" style="font-size:0.8rem;">+ Pagamento 2</label>
                            </div>
                        }

                        @if (activeCart.FormaPagamentoSelecionada == "A Prazo")
                        {
                            <div class="mb-2">
                                <label class="text-white" style="font-size:0.85rem;">Data Prazo</label>
                                <InputDate @bind-Value="activeCart.DataPagamentoPrazo"
                                           class="@(GetDataPagamentoPrazoClass() + " form-control-sm")"
                                           style="transition: border-color .15s ease, box-shadow .15s ease; font-size:0.85rem;" />
                            </div>
                        }

                        @if (activeCart.UsarPagamento2)
                        {
                            <div class="mt-2">
                                <label class="form-label fw-bold text-white" style="font-size:0.85rem;">Pagamento 2</label>
                                <div class="d-flex flex-column gap-1 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="pag2" value="Credito" checked='@(activeCart.FormaPagamento2 == "Credito")' @onclick='() => SetFormaPagamento2("Credito")' />
                                        <label class="form-check-label ms-1 text-white" style="font-size:0.8rem;">Crédito</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="pag2" value="Debito" checked='@(formaPagamento2 == "Debito")' @onclick='() => SetFormaPagamento2("Debito")' />
                                        <label class="form-check-label ms-1 text-white" style="font-size:0.8rem;">Débito</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="pag2" value="Pix" checked='@(formaPagamento2 == "Pix")' @onclick='() => SetFormaPagamento2("Pix")' />
                                        <label class="form-check-label ms-1 text-white" style="font-size:0.8rem;">Pix</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="pag2" value="A Prazo" checked='@(formaPagamento2 == "A Prazo")' @onclick='() => SetFormaPagamento2("A Prazo")' />
                                        <label class="form-check-label ms-1 text-white" style="font-size:0.8rem;">A Prazo</label>
                                    </div>
                                </div>
                                
                                @if (formaPagamento2 == "A Prazo")
                                {
                                    <div class="mt-2">
                                        <label class="text-white" style="font-size:0.85rem;">Data Prazo 2</label>
                                        <InputDate @bind-Value="dataPagamentoPrazo2"
                                                   class="@(GetDataPagamentoPrazo2Class() + " form-control-sm")"
                                                   style="transition: border-color .15s ease, box-shadow .15s ease; font-size:0.85rem;" />
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>

        @* Coluna 3: Total, Valores e Troco *@
        <div class="col-md-4 order-md-3">
            <div class="d-flex flex-column align-items-end">
                <h3 class="fw-bold text-success mb-1" style="font-size:1.25rem;">Total: R$ @activeCart.Items.Sum(p => p.Total).ToString("0.00")</h3>
                
                @* Valor de pagamento 1 - com input *@
                @if (string.Equals(activeCart.FormaPagamentoSelecionada, "Dinheiro", StringComparison.OrdinalIgnoreCase) || activeCart.UsarPagamento2)
                {
                    <div class="d-flex align-items-center mb-1 w-100 justify-content-end">
                        <label class="text-white me-2 mb-0" style="font-size:1.05rem; font-weight:600;">Valor Pagamento 1:</label>
                        <input id="pag1_input" type="text" inputmode="decimal" pattern="[0-9.,]*" class="form-control form-control-sm text-end payment-input-shortcut" placeholder="Valor" @bind="Pagamento1Text" disabled="@((!activeCart.UsarPagamento2) && !string.Equals(activeCart.FormaPagamentoSelecionada, "Dinheiro", StringComparison.OrdinalIgnoreCase))" @onfocus="OnPagamento1Focus" @onfocus:preventDefault @onblur:preventDefault style="font-size:0.95rem; max-width: 150px;" />
                    </div>
                }

                @* Valor de pagamento 2 - calculado automaticamente *@
                @if (activeCart.UsarPagamento2)
                {
                    var valorPagamento2 = CalcularValorPagamento2();
                    <h5 class="fw-bold mb-1 text-end text-white" style="font-size:1.05rem;">
                        Valor Pagamento 2: R$ @valorPagamento2.ToString("0.00")
                    </h5>
                }
                
                @* Troco *@
                @if (string.Equals(formaPagamentoSelecionada, "Dinheiro", StringComparison.OrdinalIgnoreCase))
                {
                    var troco = trocoDinheiro;
                    var trocoClass = troco > 0 ? "text-danger" : "text-white";
                    <h5 class="fw-bold mb-1 text-end @trocoClass" style="font-size:1.05rem;">
                        Troco: R$ @troco.ToString("0.00")
                    </h5>
                }

                @* Botão Finalizar Compra - logo abaixo do troco *@
                @{ 
                    // derive effective values from activeCart falling back to local UI vars so the check is robust
                    var effectiveForma = !string.IsNullOrEmpty(activeCart.FormaPagamentoSelecionada) ? activeCart.FormaPagamentoSelecionada : formaPagamentoSelecionada;
                    var effectiveVendedor = !string.IsNullOrEmpty(activeCart.VendedorNome) ? activeCart.VendedorNome : vendedorNome;
                    var effectivePedido = !string.IsNullOrEmpty(activeCart.PedidoStatus) ? activeCart.PedidoStatus : pedidoStatus;

                    bool canShowFinalize = activeCart.Items.Any()
                        && !string.IsNullOrEmpty(effectiveForma)
                        && !string.IsNullOrEmpty(effectivePedido)
                        && !isProcessing
                        && !string.IsNullOrEmpty(effectiveVendedor);

                    // when payment is 'A Prazo' require a selected due date and a client name before showing the button
                    if (string.Equals(effectiveForma, "A Prazo", StringComparison.OrdinalIgnoreCase))
                    {
                        var due = activeCart.DataPagamentoPrazo ?? dataPagamentoPrazo;
                        var cliente = !string.IsNullOrWhiteSpace(activeCart.ClienteNome) ? activeCart.ClienteNome : clienteNome;
                        canShowFinalize = canShowFinalize && due.HasValue && !string.IsNullOrWhiteSpace(cliente);
                    }

                    // Verificar se a soma dos pagamentos é maior ou igual ao total do carrinho
                    if (canShowFinalize)
                    {
                        var totalCarrinho = activeCart.Items.Sum(p => p.Total);
                        var valorPag1 = activeCart.Pagamento1 ?? 0m;
                        var valorPag2 = activeCart.UsarPagamento2 ? (activeCart.Pagamento2 ?? 0m) : 0m;
                        var somaPagamentos = valorPag1 + valorPag2;
                        
                        // Só mostra o botão se a soma dos pagamentos for >= total
                        canShowFinalize = somaPagamentos >= totalCarrinho;
                    }
                }

                @if (canShowFinalize)
                {
                    <button class="btn btn-success btn-lg w-100 mt-2" @onclick="FinalizePurchase">
                        <span>Finalizar Compra (ENTER)</span>
                    </button>
                }
            </div>
        </div>
    </div>

    @* Segunda linha: Cliente *@
    <div class="row g-3">
        @* Cliente *@
        <div class="col-12">
                    @* Cliente inputs *@
                    <div class="mb-3">
                        <label class="form-label fw-bold text-white" style="font-size:0.9rem;">Cliente</label>
                        <div class="row g-2">
                            <div class="col-12">
                                <input type="text" class="form-control form-control-sm" @bind="activeCart.ClienteNome" @oninput="BuscarSugestoesComanda" placeholder="Nome" style="font-size:0.85rem;" />
                            </div>
                            @if (string.Equals(formaPagamentoSelecionada, "A Prazo", StringComparison.OrdinalIgnoreCase) || (UsarPagamento2 && string.Equals(formaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase)))
                            {
                                <div class="col-md-6">
                                    <input type="text" class="form-control form-control-sm" @bind="activeCart.EntryTelefone" placeholder="Telefone" style="font-size:0.85rem;" />
                                </div>
                                <div class="col-md-6">
                                    <input type="text" class="form-control form-control-sm" @bind="activeCart.EntryEndereco" placeholder="Endereço" style="font-size:0.85rem;" />
                                </div>
                            }
                            <div class="col-12">
                                <input type="text" class="form-control form-control-sm" @bind="observacoes" placeholder="Observações" style="font-size:0.85rem;" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
</div>




@if (showQuantityModal)
{
    <div class="modal-backdrop fade show"></div>

    <div class="modal d-block">
        <div class="modal-dialog modal-sm mt-5">
            <div class="modal-content p-4 shadow-lg">
                <h5 class="fw-bold text-center">@selectedProduct?.Nome</h5>

                <div class="mb-3">
                    <input id="quantity_input" type="text" inputmode="numeric" pattern="[0-9xX]*" class="form-control form-control-lg text-center"
                           placeholder="Quantidade (ex: 9x24 ou 216)" value="@selectedQuantityBuffer" @oninput="OnQuantityInput" @onkeydown="OnQuantityKeyDown" @onkeypress="OnQuantityKeyPress" />
                    <div class="small text-muted mt-1">Quantidade final: @RenderComputedQuantity()</div>
                </div>

                <div class="mb-2 d-flex flex-wrap gap-2 justify-content-center">
                    @for (int n = 0; n <= 9; n++)
                    {
                        var digit = n; /* capture loop variable to avoid closure issue */
                        <button class="btn btn-outline-secondary btn-lg" @onclick="() => OnNumericPadClick(digit)">@digit</button>
                    }
                    <button class="btn btn-outline-secondary btn-lg" title="Multiplicar (ex: 9x24)" @onclick="OnInsertMultiply">×</button>
                    <button class="btn btn-outline-danger btn-lg" title="Apagar" @onclick="OnNumericBackspace">⌫</button>
                </div>

                <div class="mb-3">
                    <label class="form-label">Temperatura</label>
                    <div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="temp" id="temp_none" checked="@(string.IsNullOrEmpty(selectedTemperatura))" @onchange="() => OnSelectTemperatura(null)" />
                            <label class="form-check-label ms-2" for="temp_none">N - Nenhuma</label>
                            <div class="small text-muted ms-4">Preço: R$ @(GetProdutoDisplayPrice(selectedProduct).ToString("0.00"))</div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="temp" id="temp_quente" checked='@(selectedTemperatura == "Quente")' @onchange='() => OnSelectTemperatura("Quente")' />
                            <label class="form-check-label ms-2" for="temp_quente">Q - Quente</label>
                            <div class="small text-muted ms-4">Preço: R$ @(selectedProduct != null && selectedProduct.PrecoQuente > 0 ? selectedProduct.PrecoQuente.ToString("0.00") : GetProdutoDisplayPrice(selectedProduct).ToString("0.00"))</div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="temp" id="temp_gelada" checked='@(selectedTemperatura == "Gelada")' @onchange='() => OnSelectTemperatura("Gelada")' />
                            <label class="form-check-label ms-2" for="temp_gelada">G - Gelada</label>
                            <div class="small text-muted ms-4">Preço: R$ @(selectedProduct != null && selectedProduct.PrecoGelada > 0 ? selectedProduct.PrecoGelada.ToString("0.00") : GetProdutoDisplayPrice(selectedProduct).ToString("0.00"))</div>
                        </div>
                    </div>
                </div>

                <div class="d-flex mt-3 justify-content-around">
                    <button class="btn btn-secondary btn-lg" @onclick="CloseModal">Cancelar</button>
                    <button class="btn btn-primary btn-lg" @onclick="ConfirmAddToCart">OK</button>
                </div>
            </div>
        </div>
    </div>
}



@* html *@
@code {
    //c#
    private string searchNome = string.Empty;
    private string searchBarcode = string.Empty;
    private string searchTerm = string.Empty;
    private bool showProductList = false;
    private string clienteNome = string.Empty;
    private string vendedorNome = string.Empty;
    private List<Produto> filteredProdutos = new();
    private List<string> marcas = new();
    private string? selectedMarca = null;
    private List<string> sizesForMarca = new();
    private List<Produto> allProdutos = new();
    private string? selectedSize = null;
    private List<string> flavorsForSelection = new();
    private Dictionary<string, Produto> flavorToProduct = new(StringComparer.OrdinalIgnoreCase);
    // snapshot to preserve product filters while modal is open
    private List<Produto>? _snapshotFilteredProdutos;
    private string? _snapshotSelectedMarca;
    private string? _snapshotSelectedSize;
    private List<string>? _snapshotFlavorsForSelection;
    private bool? _snapshotShowProductList;
    private string? _snapshotSearchTerm;

    private void PopulateMarcasFromProdutos(List<Produto> produtos)
    {
        // crude brand list by scanning product.Nome/Detalhe
        var known = new[] { "Brahma", "Skol", "Antarctica", "Original", "Xereta", "Coca Cola", "Coca-Cola", "Fanta", "Heineken", "Budweiser", "Red Bull", "Gaterade", "Petra", "Pepsi",
        "Sukita", "Corona", "Tubaina", "Lacta", "Eisenbahn", "Baianinha", "Chapinha", "Askov", "Stella", "Monster", "Amstel", "Red label", "Del valle", "Sprite", "Fanta", "Imperio", "Baly",
        "Crystal", "Gorillaz"};
        var found = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        foreach (var p in produtos)
        {
            var txt = (p.Nome ?? string.Empty) + " " + (p.Detalhe ?? string.Empty);
            foreach (var k in known)
            {
                if (!found.Contains(k) && txt.IndexOf(k, StringComparison.OrdinalIgnoreCase) >= 0)
                    found.Add(k);
            }
        }
        // normalize certain brand variants (e.g. "Coca Cola" / "Coca-Cola" -> "Coca-cola")
        if (found.Remove("Coca Cola") | found.Remove("Coca-Cola"))
        {
            found.Add("Coca-cola");
        }
        marcas = found.OrderBy(m => m).ToList();
    }

    // return true if the given text contains the brand, accepting orthographic variants
    private bool BrandMatch(string text, string brand)
    {
        if (string.IsNullOrEmpty(text) || string.IsNullOrEmpty(brand)) return false;

        string NormalizeForMatch(string s)
        {
            if (string.IsNullOrEmpty(s)) return string.Empty;
            var lower = s.ToLowerInvariant();
            var formD = lower.Normalize(System.Text.NormalizationForm.FormD);
            var sb = new System.Text.StringBuilder();
            foreach (var ch in formD)
            {
                var cat = System.Globalization.CharUnicodeInfo.GetUnicodeCategory(ch);
                if (cat != System.Globalization.UnicodeCategory.NonSpacingMark)
                    sb.Append(ch);
            }
            var cleaned = sb.ToString();
            cleaned = cleaned.Replace('\u00A0', ' ');
            cleaned = cleaned.Replace('-', ' ');
            cleaned = cleaned.Replace('_', ' ');
            cleaned = System.Text.RegularExpressions.Regex.Replace(cleaned, "\\s+", " ").Trim();
            return cleaned;
        }

        var nText = NormalizeForMatch(text);
        var nBrand = NormalizeForMatch(brand);
        if (nText.Contains(nBrand, StringComparison.OrdinalIgnoreCase)) return true;

        var noSepText = nText.Replace(" ", string.Empty);
        var noSepBrand = nBrand.Replace(" ", string.Empty);
        if (!string.IsNullOrEmpty(noSepBrand) && noSepText.Contains(noSepBrand, StringComparison.OrdinalIgnoreCase)) return true;

        return false;
    }

    private void OnSelectMarca(string? marca)
    {
        selectedMarca = marca;
        sizesForMarca.Clear();
        // if clearing brand, reset dependent UI (sizes, flavors, products)
        if (string.IsNullOrEmpty(marca))
        {
            selectedSize = null;
            flavorsForSelection.Clear();
            flavorToProduct.Clear();
            filteredProdutos = new List<Produto>();
            showProductList = false;
            return;
        }

        // collect sizes from product names like '600ml', '350ml', '1L', '2L', 'dose'
        var sizes = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        foreach (var p in allProdutos ?? new List<Produto>())
        {
            if (p.Disponivel && BrandMatch((p.Nome ?? string.Empty) + " " + (p.Detalhe ?? string.Empty), marca))
            {
                var s = ExtractSizeFromName(p.Nome) ?? ExtractSizeFromName(p.Detalhe);
                if (!string.IsNullOrEmpty(s)) sizes.Add(s);
            }
        }

        // add some common sizes if nothing found
        if (!sizes.Any())
        {
            sizes.UnionWith(new[] { "600ml", "350ml", "1L", "2L", "269ml", "dose" });
        }

        sizesForMarca = sizes.OrderBy(s => s).ToList();

        // set filtered products to this brand (apenas disponíveis)
        filteredProdutos = (allProdutos ?? new List<Produto>())
            .Where(p => p.Disponivel && BrandMatch((p.Nome ?? string.Empty) + " " + (p.Detalhe ?? string.Empty), marca))
            .ToList();
        showProductList = filteredProdutos.Any();
    }

    private Produto? FindProductForBrandAndSize(string marca, string size)
    {
        return (allProdutos ?? new List<Produto>()).FirstOrDefault(p =>
            p.Disponivel &&
            BrandMatch(((p.Nome ?? string.Empty) + " " + (p.Detalhe ?? string.Empty)), marca)
            && (((p.Nome ?? string.Empty).IndexOf(size, StringComparison.OrdinalIgnoreCase) >= 0) || ((p.Detalhe ?? string.Empty).IndexOf(size, StringComparison.OrdinalIgnoreCase) >= 0))
        );
    }

    private string? ExtractSizeFromName(string? text)
    {
        if (string.IsNullOrEmpty(text)) return null;
        // simple regex-like checks
        var lower = text.ToLowerInvariant();
        var candidates = new[] { "600ml", "350ml", "269ml", "1l", "2l", "500ml", "dose", "300ml", "250ml", "200ml", "330ml", "330 ml", "2000ml", "20g", "1kg", "35g", "880ml", "1.5L", "473ml",
        "275ml", "355ml"};
        foreach (var c in candidates)
        {
            if (lower.Contains(c)) return c.ToUpperInvariant();
        }
        return null;
    }

    private void OnSelectSize(Produto? produto)
    {
        // When user selects a size card we want to check if there are flavor variants for this brand+size.
        // If flavors exist show flavor cards; otherwise open quantity modal for the product (quick add).
        selectedSize = null;
        flavorsForSelection.Clear();
        flavorToProduct.Clear();

        if (produto == null)
            return;

        // determine size string by inspecting product name/detail (fallback to previously selected size heuristics)
        selectedSize = ExtractSizeFromName(produto.Nome) ?? ExtractSizeFromName(produto.Detalhe);

        // collect flavors for same brand and size
        if (!string.IsNullOrEmpty(selectedMarca))
        {
            foreach (var p in allProdutos ?? new List<Produto>())
            {
                if (!p.Disponivel || !BrandMatch(((p.Nome ?? string.Empty) + " " + (p.Detalhe ?? string.Empty)), selectedMarca ?? string.Empty))
                    continue;

                // match size
                var s = ExtractSizeFromName(p.Nome) ?? ExtractSizeFromName(p.Detalhe);
                if (string.IsNullOrEmpty(selectedSize) || string.IsNullOrEmpty(s) || !string.Equals(s, selectedSize, StringComparison.OrdinalIgnoreCase))
                    continue;

                var f = ExtractFlavorFromName(p.Nome) ?? ExtractFlavorFromName(p.Detalhe);
                if (!string.IsNullOrEmpty(f) && !flavorToProduct.ContainsKey(f))
                {
                    flavorToProduct[f] = p;
                    flavorsForSelection.Add(f);
                }
            }
        }

        if (flavorsForSelection.Any())
        {
            // show flavor cards (UI reads flavorsForSelection)
            StateHasChanged();
            return;
        }

        // no flavors -> proceed to modal for the selected product
        OpenQuantityModal(produto);
        selectedQuantity = 1;
        selectedQuantityBuffer = "1";
    }

    // overload for clicking a size card when we only have the size string
    private void OnSelectSize(string size)
    {
        selectedSize = size;
        // filter products by brand+size (apenas disponíveis)
        filteredProdutos = (allProdutos ?? new List<Produto>())
            .Where(p => p.Disponivel && BrandMatch((p.Nome ?? string.Empty) + " " + (p.Detalhe ?? string.Empty), selectedMarca ?? string.Empty)
                && (((p.Nome ?? string.Empty).IndexOf(size, StringComparison.OrdinalIgnoreCase) >= 0) || ((p.Detalhe ?? string.Empty).IndexOf(size, StringComparison.OrdinalIgnoreCase) >= 0)))
            .ToList();

        showProductList = filteredProdutos.Any();

        // repopulate flavors (only if there are any)
        var flavors = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        foreach (var p in filteredProdutos)
        {
            var f = ExtractFlavorFromName(p.Nome) ?? ExtractFlavorFromName(p.Detalhe);
            if (!string.IsNullOrEmpty(f)) flavors.Add(f);
        }
        flavorsForSelection = flavors.Any() ? flavors.OrderBy(f => f).ToList() : new List<string>();
        flavorToProduct.Clear();
        foreach (var f in flavorsForSelection)
        {
            var match = filteredProdutos.FirstOrDefault(p => (((p.Nome ?? string.Empty).IndexOf(f, StringComparison.OrdinalIgnoreCase) >= 0)
                || ((p.Detalhe ?? string.Empty).IndexOf(f, StringComparison.OrdinalIgnoreCase) >= 0)));
            if (match != null && !flavorToProduct.ContainsKey(f)) flavorToProduct[f] = match;
        }
    }

    private void OnSelectFlavor(string flavor)
    {
        if (string.IsNullOrEmpty(flavor)) return;
        // filter products for current brand + size + flavor (apenas disponíveis)
        filteredProdutos = (allProdutos ?? new List<Produto>())
            .Where(p => p.Disponivel && BrandMatch((p.Nome ?? string.Empty) + " " + (p.Detalhe ?? string.Empty), selectedMarca ?? string.Empty)
                && (string.IsNullOrEmpty(selectedSize) || ((p.Nome ?? string.Empty).IndexOf(selectedSize ?? string.Empty, StringComparison.OrdinalIgnoreCase) >= 0) || ((p.Detalhe ?? string.Empty).IndexOf(selectedSize ?? string.Empty, StringComparison.OrdinalIgnoreCase) >= 0))
                && (((p.Nome ?? string.Empty).IndexOf(flavor, StringComparison.OrdinalIgnoreCase) >= 0) || ((p.Detalhe ?? string.Empty).IndexOf(flavor, StringComparison.OrdinalIgnoreCase) >= 0)))
            .ToList();

        // do not open modal when selecting a flavor — only filter products
        // keep flavor buttons visible until user clears
        showProductList = filteredProdutos.Any();
        StateHasChanged();
    }

    private void ClearFlavors()
    {
        flavorsForSelection.Clear();
        flavorToProduct.Clear();
        // when clearing flavors, if a size is selected, keep filteredProdutos to brand+size (apenas disponíveis)
        if (!string.IsNullOrEmpty(selectedMarca) && !string.IsNullOrEmpty(selectedSize))
        {
            filteredProdutos = (allProdutos ?? new List<Produto>())
                .Where(p => p.Disponivel && BrandMatch((p.Nome ?? string.Empty) + " " + (p.Detalhe ?? string.Empty), selectedMarca ?? string.Empty)
                    && (((p.Nome ?? string.Empty).IndexOf(selectedSize ?? string.Empty, StringComparison.OrdinalIgnoreCase) >= 0) || ((p.Detalhe ?? string.Empty).IndexOf(selectedSize ?? string.Empty, StringComparison.OrdinalIgnoreCase) >= 0)))
                .ToList();
        }
        else if (!string.IsNullOrEmpty(selectedMarca))
        {
            filteredProdutos = (allProdutos ?? new List<Produto>())
                .Where(p => p.Disponivel && BrandMatch((p.Nome ?? string.Empty) + " " + (p.Detalhe ?? string.Empty), selectedMarca ?? string.Empty))
                .ToList();
        }
        StateHasChanged();
    }

    private string? ExtractFlavorFromName(string? text)
    {
        if (string.IsNullOrEmpty(text)) return null;
        var lower = text.ToLowerInvariant();
        var candidates = new[] { "uva", "maçã", "maca", "laranja", "limão", "limao", "morango", "abacaxi", "cajú", "caju", "guaraná", "guarana", 
        "cola", "baunilha", "chocolate", "melancia", "morango-maracuja", "zero", "sem açúcar", "maracuja", "Limonada", "Tanjerina", "black", "Tradicional", "Tropical", "maca verde",
        "f vermelhas", "manga", "morango e pêssego", "Maça verde", "Mango loco", "Pipeline" };
        foreach (var c in candidates)
        {
            if (lower.Contains(c)) return CultureInfo.CurrentCulture.TextInfo.ToTitleCase(c.Replace("ç","c"));
        }
        return null;
    }
    private List<Produto> maisVendidos = new();
    // support multiple carts with independent state
    private class CartState
    {
        public List<CartItem> Items { get; set; } = new List<CartItem>();
        public string ClienteNome { get; set; } = string.Empty;
        public string VendedorNome { get; set; } = string.Empty;
        public bool IsOtherVendedorSelected { get; set; } = false;
        public string FormaPagamentoSelecionada { get; set; } = string.Empty;
        public string FormaPagamento2 { get; set; } = string.Empty;
        public decimal? Pagamento1 { get; set; }
        public decimal? Pagamento2 { get; set; }
        public string Pagamento1Text { get; set; } = string.Empty;
        public bool UsarPagamento2 { get; set; } = false;
        public bool SecondaryCalculated { get; set; } = false;
        public DateTime? DataPagamentoPrazo { get; set; }
        public DateTime? DataPagamentoPrazo2 { get; set; }
        public string PedidoStatus { get; set; } = "Finalizado";
        public string Observacoes { get; set; } = string.Empty;
        public string EntryTelefone { get; set; } = string.Empty;
        public string EntryEndereco { get; set; } = string.Empty;
        public decimal ValorRecebidoDinheiro { get; set; }
        public decimal ValorRecebidoDinheiro2 { get; set; }
    }

    private List<CartState> carts = new() { new CartState() };
    private int activeCartIndex = 0;
    // keep a single priceInputs list that maps to the active cart rows; will be resynced when switching carts
    private List<string> priceInputs = new();

    private CartState activeCart => carts[activeCartIndex];
    private List<ItemComanda> itensComanda = new();
    private int idcomanda;
    private bool isProcessing = false;
    private string formaPagamentoSelecionada = string.Empty;
    private List<Comanda> todasComandasAbertas = new();
    private List<Comanda> sugestoesComanda = new();
    private string entryTelefone;
    private string entryEndereco;
    private bool imprimirNaCozinha = false;
    private DateTime? dataPagamentoPrazo;
    private DateTime? dataPagamentoPrazo2;

    private bool showQuantityModal = false;
    private bool showCreateProductModal = false;
    private Produto newProductForBarcode = new Produto();
private Produto selectedProduct;
private int? selectedQuantity = null;
private string selectedQuantityBuffer = string.Empty;
private string? selectedTemperatura = null;
    private string observacoes = string.Empty;
    private bool showDebugImages = false;
    private List<string> debugImageSources = new();
    private bool showCartDebug = false;
    private string formaPagamento2 = string.Empty;
    private decimal? pagamento1;
    private decimal? pagamento2;
    private List<string> vendedores = new();
    private bool isOtherVendedorSelected = false;
    private string pagamento1Text = string.Empty;
    private bool UsarPagamento2 = false;
    private bool SecondaryCalculated = false;
    private string initializationError = string.Empty;
    private string pedidoStatus = "Finalizado";
    private string PedidoStatus
    {
        get => pedidoStatus;
        set
        {
            if (pedidoStatus != value)
            {
                pedidoStatus = value;
                // Only update the status; do not change item prices here
                StateHasChanged();
            }
        }
    }
    
    private void SelectVendedor(string nome) => vendedorNome = nome;
    private void SelectStatus(string status) => pedidoStatus = status;

    private void OnVendedorSelected(string v)
    {
        vendedorNome = v;
        // keep activeCart in sync so validation/visibility use correct values
        try { activeCart.VendedorNome = v ?? string.Empty; activeCart.IsOtherVendedorSelected = false; } catch { }
        isOtherVendedorSelected = false;
    }

    private void OnOtherVendedorSelected()
    {
        vendedorNome = string.Empty;
        try { activeCart.VendedorNome = string.Empty; activeCart.IsOtherVendedorSelected = true; } catch { }
        isOtherVendedorSelected = true;
    }

    private async Task SetFormaPagamento(string forma)
    {
        formaPagamentoSelecionada = forma;
        try { activeCart.FormaPagamentoSelecionada = forma; } catch { }
        EnsurePagamento1State();
        StateHasChanged();
        
        // If Dinheiro is selected, focus the payment input after state update
        if (forma == "Dinheiro")
        {
            await Task.Delay(100); // give UI time to render/enable the input
            try 
            { 
                await JS.InvokeVoidAsync("eval", "document.getElementById('pag1_input')?.focus()"); 
                await JS.InvokeVoidAsync("console.log", "Focused pag1_input after Dinheiro selection");
            } 
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("console.error", $"Failed to focus pag1_input: {ex.Message}");
            }
        }
        // If A Prazo is selected, focus and click the date input to open calendar
        else if (forma == "A Prazo")
        {
            await Task.Delay(100); // give UI time to render the date input
            try 
            { 
                await JS.InvokeVoidAsync("eval", @"
                    var dateInput = document.querySelector('input[type=""date""]');
                    if (dateInput) {
                        dateInput.focus();
                        dateInput.click();
                        dateInput.showPicker && dateInput.showPicker();
                    }
                ");
                await JS.InvokeVoidAsync("console.log", "Opened date picker after A Prazo selection");
            } 
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("console.error", $"Failed to open date picker: {ex.Message}");
            }
        }
    }

    private void SetFormaPagamento2(string forma)
    {
        formaPagamento2 = forma;
        try { activeCart.FormaPagamento2 = forma; } catch { }
        RecalculateSecondary();
        StateHasChanged();
    }

    private async Task OnPagamento1Focus(FocusEventArgs e)
    {
        // Select all text when the payment input receives focus
        try
        {
            await Task.Delay(10); // small delay to ensure input is ready
            await JS.InvokeVoidAsync("eval", "document.getElementById('pag1_input')?.select()");
        }
        catch { }
    }

    private string Pagamento1Text
    {
        get => activeCart.Pagamento1Text;
        set
        {
            activeCart.Pagamento1Text = value ?? string.Empty;
            if (string.IsNullOrWhiteSpace(activeCart.Pagamento1Text))
            {
                activeCart.Pagamento1 = null;
            }
            else if (TryParseDecimalFlexible(activeCart.Pagamento1Text, out var v))
            {
                activeCart.Pagamento1 = Math.Round(v, 2);
            }
            // Atualizar Pagamento2 automaticamente
            if (activeCart.UsarPagamento2)
            {
                activeCart.Pagamento2 = CalcularValorPagamento2();
            }
            RecalculateSecondary();
        }
    }

    private decimal CalcularValorPagamento2()
    {
        var total = activeCart.Items.Sum(p => p.Total);
        var pagamento1Valor = activeCart.Pagamento1 ?? 0m;
        var valorRestante = total - pagamento1Valor;
        return Math.Max(0m, Math.Round(valorRestante, 2));
    }

    private string Pagamento2Text
    {
        get => activeCart.Pagamento2?.ToString("0.00", CultureInfo.CurrentCulture) ?? string.Empty;
        set
        {
            if (string.IsNullOrWhiteSpace(value))
            {
                activeCart.Pagamento2 = null;
            }
            else if (TryParseDecimalFlexible(value, out var v))
            {
                activeCart.Pagamento2 = Math.Round(v, 2);
            }
            RecalculateSecondary();
        }
    }

    // scanner interop fields moved into code-behind section
    private DotNetObjectReference<object>? _dotNetRef;


    private void CancelCreateProduct()
    {
        showCreateProductModal = false;
    }

    private async Task CreateProductFromBarcode()
    {
        try
        {
            // Basic validation and defaults required by backend
            if (string.IsNullOrWhiteSpace(newProductForBarcode.Nome))
            {
                await ShowAlert("Por favor informe o nome do produto antes de cadastrar.");
                return;
            }

            // PrecoCusto is required by backend. If not provided, fallback to Preco or a small non-zero value.
            if (newProductForBarcode.PrecoCusto <= 0)
            {
                if (newProductForBarcode.Preco > 0)
                    newProductForBarcode.PrecoCusto = newProductForBarcode.Preco;
                else
                    newProductForBarcode.PrecoCusto = 0.01m;
            }

            // CategoriaId may be required; pick a sensible default if not set
            if (newProductForBarcode.CategoriaId == 0)
            {
                var (cats, _) = await _apiService.GetCategorias();
                if (cats != null && cats.Any())
                    newProductForBarcode.CategoriaId = cats.First().Id;
                else
                    newProductForBarcode.CategoriaId = 1; // fallback
            }

            // ✅ Marcar produto como disponível por padrão
            newProductForBarcode.Disponivel = true;

            // call API to create product
            var response = await _apiService.AdicionarProdutoAsync(newProductForBarcode);
            if (!string.IsNullOrEmpty(response.ErrorMessage))
            {
                await ShowAlert("Falha ao criar produto: " + response.ErrorMessage);
                return;
            }

            // reload products and add created product to cart
            var (todosProdutos, err) = await _apiService.GetTodosProdutos();
            var created = todosProdutos?.FirstOrDefault(p => p.Barcode == newProductForBarcode.Barcode) ?? newProductForBarcode;
            // open quantity modal for the newly created product
            showCreateProductModal = false;
            OpenQuantityModal(created);
        }
        catch (Exception ex)
        {
            await ShowAlert("Erro ao criar produto: " + ex.Message);
        }
    }

    private decimal GetProdutoDisplayPrice(Produto p)
    {
        if (p == null) return 0m;
        if (p.PrecoRetirar > 0) return p.PrecoRetirar;
        if (p.PrecoEntrega > 0) return p.PrecoEntrega;
        if (p.PrecoQuente > 0) return p.PrecoQuente;
        if (p.PrecoGelada > 0) return p.PrecoGelada;
        return p.Preco;
    }

    private void ToggleDebugImages()
    {
        showDebugImages = !showDebugImages;
        if (showDebugImages)
        {
            debugImageSources = filteredProdutos.Select(p => p.CaminhoImagem ?? p.UrlImagem ?? "(none)").ToList();
        }
    }

    private async Task OpenScanner()
    {
        _dotNetRef ??= DotNetObjectReference.Create((object)this);
        await JS.InvokeVoidAsync("barcodeScanner.start", _dotNetRef, "barcode-scanner-container");
    }

    private async Task OpenNativeScanner()
    {
        // call JS helper that tries to open ZXing or Intent
        await JS.InvokeVoidAsync("barcodeScanner.openScannerApp");
    }

    [JSInvokable]
    public async Task OnBarcodeScanned(string code)
    {
        searchTerm = code;
        await SearchProducts(null);
        StateHasChanged();
        await ProcessBarcode(code);
    }

    private async Task OnSearchKeyDown(KeyboardEventArgs e)
    {
        // Only handle Enter to process barcode
        if (e.Key == "Enter")
        {
            await ProcessBarcode(searchTerm);
        }
    }

    private async Task SearchProducts(ChangeEventArgs e)
    {
        // unify name or barcode search into single input
        if (e != null)
            searchTerm = e.Value?.ToString() ?? string.Empty;
        else
        {
            // when used from JSInvokable or code, searchTerm already set
        }

        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredProdutos = new List<Produto>();
            showProductList = false;
            return;
        }

        // attempt exact barcode match first (apenas disponíveis)
        var (todosProdutos, _) = await _apiService.GetTodosProdutos();
        if (todosProdutos == null)
        {
            filteredProdutos = new();
            showProductList = false;
            return;
        }

        var byBarcode = todosProdutos.Where(p => p.Disponivel && !string.IsNullOrWhiteSpace(p.Barcode) && p.Barcode.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();
        if (byBarcode.Any())
        {
            filteredProdutos = byBarcode;
            showProductList = true;
            return;
        }

        // fallback to name search (apenas disponíveis)
        filteredProdutos = todosProdutos.Where(p => p.Disponivel && p.Nome != null && p.Nome.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();
        showProductList = filteredProdutos.Any();
    }

    private async Task OnBarcodeKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            var code = searchBarcode?.Trim();
            await JS.InvokeVoidAsync("console.log", $"OnBarcodeKeyDown Enter pressed, code='" + (code ?? "(null)") + "'");
            if (string.IsNullOrEmpty(code))
            {
                await JS.InvokeVoidAsync("console.warn", "Barcode input empty on Enter");
                return;
            }
            await ProcessBarcode(code);
            StateHasChanged();
        }
    }

    private async Task OnBarcodeKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            var code = searchBarcode?.Trim();
            await JS.InvokeVoidAsync("console.log", $"OnBarcodeKeyUp Enter pressed, code='" + (code ?? "(null)") + "'");
            if (string.IsNullOrEmpty(code))
            {
                await JS.InvokeVoidAsync("console.warn", "Barcode input empty on Enter (keyup)");
                return;
            }

            await ProcessBarcode(code);
            StateHasChanged();
        }
    }

    private async Task ProcessBarcode(string code)
    {
        try
        {
            // 1) Check backend product DB first
            var (todosProdutos, errorMessage) = await _apiService.GetTodosProdutos();

            if (todosProdutos == null || !todosProdutos.Any())
            {
                await JS.InvokeVoidAsync("console.warn", "ProcessBarcode: GetTodosProdutos returned no items: " + (errorMessage ?? "(no error msg)"));
            }

            string Normalize(string? s) => string.IsNullOrWhiteSpace(s) ? string.Empty : new string(s.Where(char.IsDigit).ToArray());
            var normalizedCode = Normalize(code);

            Produto? produto = null;
            if (!string.IsNullOrEmpty(normalizedCode))
            {
                produto = (todosProdutos ?? new List<Produto>())
                    .FirstOrDefault(p => !string.IsNullOrWhiteSpace(p.Barcode) && Normalize(p.Barcode) == normalizedCode);
            }
            if (produto == null)
            {
                produto = (todosProdutos ?? new List<Produto>())
                    .FirstOrDefault(p => string.Equals(p.Barcode?.Trim(), code?.Trim(), StringComparison.OrdinalIgnoreCase));
            }

            if (produto != null)
            {
                // product exists in DB -> open quantity modal
                OpenQuantityModal(produto);
                return;
            }
            // 2) Not in DB -> open modal immediately with barcode, then prefill asynchronously
            try
            {
                // set minimal barcode and clear other fields on the existing instance so bindings show immediately
                newProductForBarcode.Barcode = code;
                newProductForBarcode.Nome = null;
                newProductForBarcode.Preco = 0m;
                newProductForBarcode.Detalhe = null;
                newProductForBarcode.UrlImagem = null;
                newProductForBarcode.PrecoCusto = 0m;
                newProductForBarcode.PrecoQuente = 0m;
                newProductForBarcode.PrecoGelada = 0m;
                newProductForBarcode.PrecoEntrega = 0m;
                newProductForBarcode.PrecoRetirar = 0m;
                newProductForBarcode.CategoriaId = 0;

                showCreateProductModal = true;
                StateHasChanged();

                // Prefill in background so UI is responsive
                _ = PrefillProductFromLookup(code);
                return;
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("console.error", "Barcode lookup exception: " + ex.Message);
                newProductForBarcode.Barcode = code;
                showCreateProductModal = true;
                StateHasChanged();
                return;
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Erro em ProcessBarcode: " + ex.Message);
            newProductForBarcode = new Produto { Barcode = code };
            showCreateProductModal = true;
            StateHasChanged();
        }
    }

    private class CaixaStateDto
    {
        public List<object>? Cart { get; set; }
        public string? ClienteNome { get; set; }
        public string? VendedorNome { get; set; }
        public string? FormaPagamentoSelecionada { get; set; }
        public string? FormaPagamento2 { get; set; }
        public decimal? Pagamento1 { get; set; }
        public decimal? Pagamento2 { get; set; }
        public string? PedidoStatus { get; set; }
        public decimal ValorRecebido { get; set; }
    }

    private async Task SaveCaixaStateAsync()
    {
        try
        {
            // save active cart state only
            var dto = new CaixaStateDto
            {
                Cart = activeCart.Items.Select(i => new {
                    ProdutoId = i.Produto?.Id,
                    i.Produto?.Nome,
                    i.Produto?.Barcode,
                    PrecoUnitario = i.PrecoUnitario,
                    Quantidade = i.Quantidade,
                    Temperatura = i.Temperatura
                }).Cast<object>().ToList(),
                ClienteNome = activeCart.ClienteNome,
                VendedorNome = activeCart.VendedorNome,
                FormaPagamentoSelecionada = activeCart.FormaPagamentoSelecionada,
                FormaPagamento2 = activeCart.FormaPagamento2,
                Pagamento1 = activeCart.Pagamento1,
                Pagamento2 = activeCart.Pagamento2,
                PedidoStatus = activeCart.PedidoStatus,
                ValorRecebido = activeCart.ValorRecebidoDinheiro
            };

            var json = System.Text.Json.JsonSerializer.Serialize(dto);
            await JS.InvokeVoidAsync("sessionStorage.setItem", "caixaState", json);
        }
        catch (Exception ex)
        {
            Console.WriteLine("Erro ao salvar estado do caixa: " + ex.Message);
        }
    }

    private async Task RestoreCaixaStateIfAnyAsync()
    {
        try
        {
            var json = await JS.InvokeAsync<string>("sessionStorage.getItem", "caixaState");
            if (string.IsNullOrWhiteSpace(json)) return;

            var dto = System.Text.Json.JsonSerializer.Deserialize<CaixaStateDto>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            if (dto == null) return;

            // restore into active cart
            activeCart.ClienteNome = dto.ClienteNome ?? activeCart.ClienteNome;
            activeCart.VendedorNome = dto.VendedorNome ?? activeCart.VendedorNome;
            activeCart.FormaPagamentoSelecionada = dto.FormaPagamentoSelecionada ?? activeCart.FormaPagamentoSelecionada;
            activeCart.FormaPagamento2 = dto.FormaPagamento2 ?? activeCart.FormaPagamento2;
            activeCart.Pagamento1 = dto.Pagamento1 ?? activeCart.Pagamento1;
            activeCart.Pagamento2 = dto.Pagamento2 ?? activeCart.Pagamento2;
            activeCart.PedidoStatus = dto.PedidoStatus ?? activeCart.PedidoStatus;
            activeCart.ValorRecebidoDinheiro = dto.ValorRecebido;

            // restore cart: we need to fetch products and match ids
            if (dto.Cart != null && dto.Cart.Any())
            {
                var (todosProdutos, err) = await _apiService.GetTodosProdutos();
                var prodList = todosProdutos ?? new List<Produto>();
                var newCart = new List<CartItem>();
                foreach (var itemObj in dto.Cart)
                {
                    // parse with JsonElement
                    var elem = itemObj as System.Text.Json.JsonElement?;
                    System.Text.Json.JsonElement je;
                    if (itemObj is System.Text.Json.JsonElement)
                        je = (System.Text.Json.JsonElement)itemObj;
                    else
                        je = (System.Text.Json.JsonElement)System.Text.Json.JsonSerializer.SerializeToElement(itemObj);

                    int? prodId = null;
                    try { if (je.TryGetProperty("ProdutoId", out var p1) && p1.ValueKind == System.Text.Json.JsonValueKind.Number) prodId = p1.GetInt32(); } catch { }
                    string nome = null;
                    try { if (je.TryGetProperty("Nome", out var p2) && p2.ValueKind == System.Text.Json.JsonValueKind.String) nome = p2.GetString(); } catch { }
                    decimal preco = 0;
                    try { if (je.TryGetProperty("PrecoUnitario", out var p3) && p3.ValueKind == System.Text.Json.JsonValueKind.Number) preco = p3.GetDecimal(); } catch { }
                    int quantidade = 1;
                    try { if (je.TryGetProperty("Quantidade", out var p4) && p4.ValueKind == System.Text.Json.JsonValueKind.Number) quantidade = p4.GetInt32(); } catch { }
                    string temperatura = null;
                    try { if (je.TryGetProperty("Temperatura", out var p5) && p5.ValueKind == System.Text.Json.JsonValueKind.String) temperatura = p5.GetString(); } catch { }

                    Produto? prod = null;
                    if (prodId.HasValue) prod = prodList.FirstOrDefault(p => p.Id == prodId.Value);
                    if (prod == null && !string.IsNullOrEmpty(nome)) prod = prodList.FirstOrDefault(p => p.Nome == nome);

                    if (prod != null)
                    {
                        newCart.Add(new CartItem { Produto = prod, Quantidade = quantidade, PrecoUnitario = preco, Temperatura = temperatura });
                    }
                }

                    if (newCart.Any()) activeCart.Items = newCart;
                SyncPriceInputs();
            }

            // remove saved state
            await JS.InvokeVoidAsync("sessionStorage.removeItem", "caixaState");
            EnsurePagamento1State();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Erro ao restaurar estado do caixa: " + ex.Message);
        }
    }

    private void EnsurePagamento1State()
    {
        // If second payment not used, primary should be cart total and disabled
        if (!activeCart.UsarPagamento2)
        {
            activeCart.Pagamento1 = Math.Round(activeCart.Items.Sum(p => p.Total), 2);
            activeCart.Pagamento1Text = activeCart.Pagamento1.HasValue ? activeCart.Pagamento1.Value.ToString("0.00", CultureInfo.CurrentCulture) : string.Empty;
        }
        // if UsarPagamento2 is true, do not overwrite user input
    }

    [JSInvokable]
    public async Task OnBarcodeError(string message)
    {
        await ShowAlert("Erro no leitor: " + message);
    }

void OpenQuantityModal(Produto produto)
{
    selectedProduct = produto;
    // start empty so user can type a value without having to delete a default
    selectedQuantity = null;
    selectedQuantityBuffer = string.Empty;
    // default temperature to null
    selectedTemperatura = null;
    // take snapshot so UI filters are not lost if other code mutates them
    _snapshotFilteredProdutos = filteredProdutos?.ToList();
    _snapshotSelectedMarca = selectedMarca;
    _snapshotSelectedSize = selectedSize;
    _snapshotFlavorsForSelection = flavorsForSelection?.ToList();
    _snapshotShowProductList = showProductList;
    _snapshotSearchTerm = searchTerm;
    showQuantityModal = true;
    // focus the quantity input after modal is shown
    _ = Task.Run(async () => {
        await Task.Delay(50); // allow modal to render
        try { await JS.InvokeVoidAsync("eval", "document.getElementById('quantity_input')?.focus()"); } catch { }
    });
}

void CloseModal()
{
    showQuantityModal = false;
    // restore snapshot in case filters were modified elsewhere while modal was open
    if (_snapshotFilteredProdutos != null) filteredProdutos = _snapshotFilteredProdutos;
    selectedMarca = _snapshotSelectedMarca;
    selectedSize = _snapshotSelectedSize;
    if (_snapshotFlavorsForSelection != null) flavorsForSelection = _snapshotFlavorsForSelection;
    if (_snapshotShowProductList.HasValue) showProductList = _snapshotShowProductList.Value;
    if (_snapshotSearchTerm != null) searchTerm = _snapshotSearchTerm;
    // clear snapshots
    _snapshotFilteredProdutos = null;
    _snapshotSelectedMarca = null;
    _snapshotSelectedSize = null;
    _snapshotFlavorsForSelection = null;
    _snapshotShowProductList = null;
    _snapshotSearchTerm = null;
    SyncPriceInputs();
    StateHasChanged();
    
    // Return focus to search input after modal closes
    _ = Task.Run(async () => {
        await Task.Delay(50); // allow UI to update
        try { await JS.InvokeVoidAsync("eval", "document.getElementById('searchInput')?.focus()"); } catch { }
    });
}

// snapshot helper removed - modal must not alter filters

    private void SyncPriceInputs()
    {
        priceInputs = new List<string>(activeCart.Items.Count);
        for (int i = 0; i < activeCart.Items.Count; i++)
        {
            priceInputs.Add(activeCart.Items[i].PrecoUnitario > 0 ? activeCart.Items[i].PrecoUnitario.ToString("0.00") : string.Empty);
        }
    }

void OnSelectTemperatura(string? temp)
{
    selectedTemperatura = temp;
    StateHasChanged();
}

void OnNumericPadClick(int n)
{
    // append digit to buffer and update parsed quantity
    if (selectedQuantityBuffer == "0") selectedQuantityBuffer = string.Empty;
    selectedQuantityBuffer += n.ToString();
    if (int.TryParse(selectedQuantityBuffer, out var v)) selectedQuantity = v; else selectedQuantity = null;
    StateHasChanged();
}

void OnQuantityInput(ChangeEventArgs e)
{
    selectedQuantityBuffer = e?.Value?.ToString() ?? string.Empty;
    // if buffer represents a multiplication like 9x24, use computed result; otherwise try parse as integer
    var computed = ComputeQuantityFromBuffer();
    if (computed > 0)
    {
        selectedQuantity = computed;
    }
    else if (int.TryParse(selectedQuantityBuffer, out var v))
    {
        selectedQuantity = v;
    }
    else
    {
        selectedQuantity = null;
    }
}

void OnInsertMultiply()
{
    // insert 'x' if not present, or remove if already the last char
    if (string.IsNullOrEmpty(selectedQuantityBuffer))
    {
        selectedQuantityBuffer = "x";
    }
    else
    {
        if (selectedQuantityBuffer.EndsWith("x", StringComparison.OrdinalIgnoreCase))
            selectedQuantityBuffer = selectedQuantityBuffer.Substring(0, selectedQuantityBuffer.Length - 1);
        else
            selectedQuantityBuffer += "x";
    }
}

int ComputeQuantityFromBuffer()
{
    if (string.IsNullOrWhiteSpace(selectedQuantityBuffer)) return 0;
    var s = selectedQuantityBuffer.Trim();
    // support formats like "9x24", "9X24", "216"
    if (s.IndexOf('x') >= 0 || s.IndexOf('X') >= 0)
    {
        var parts = s.Split(new[] { 'x', 'X' }, StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 2 && int.TryParse(parts[0].Trim(), out var a) && int.TryParse(parts[1].Trim(), out var b))
            return a * b;
        return 0;
    }
    if (int.TryParse(s, out var v)) return v;
    return 0;
}

string RenderComputedQuantity()
{
    var q = ComputeQuantityFromBuffer();
    return q > 0 ? q.ToString() : "-";
}

void OnNumericBackspace()
{
    if (string.IsNullOrEmpty(selectedQuantityBuffer)) return;
    selectedQuantityBuffer = selectedQuantityBuffer.Length <= 1 ? string.Empty : selectedQuantityBuffer.Substring(0, selectedQuantityBuffer.Length - 1);
    // update selectedQuantity from buffer (supports multiplication)
    var computed = ComputeQuantityFromBuffer();
    if (computed > 0)
        selectedQuantity = computed;
    else if (int.TryParse(selectedQuantityBuffer, out var v))
        selectedQuantity = v;
    else
        selectedQuantity = null;

    StateHasChanged();
}

    private void EnsurePriceInputsMatchCart()
    {
        // make sure priceInputs has exactly one entry per cart item to avoid index errors
        while (priceInputs.Count < activeCart.Items.Count)
        {
            var idx = priceInputs.Count;
            priceInputs.Add(idx < activeCart.Items.Count && activeCart.Items[idx].PrecoUnitario > 0 ? activeCart.Items[idx].PrecoUnitario.ToString("0.00") : string.Empty);
        }
        while (priceInputs.Count > activeCart.Items.Count)
        {
            priceInputs.RemoveAt(priceInputs.Count - 1);
        }
    }

    private bool TryParseDecimalFlexible(string? s, out decimal value)
    {
        value = 0m;
        if (string.IsNullOrWhiteSpace(s)) return false;
        s = s.Trim();

        // Normalize common number formats: handle both comma and dot as decimal separators,
        // and possible thousand separators. Strategy:
        // - If string contains both '.' and ',', assume the last one is the decimal separator.
        //   Remove the other characters (thousand separators) and replace the decimal separator with '.'.
        // - If contains only ',', replace it with '.' and parse with invariant culture.
        // - Otherwise try invariant parse.

        string normalized = s;
        bool hasDot = s.IndexOf('.') >= 0;
        bool hasComma = s.IndexOf(',') >= 0;

        if (hasDot && hasComma)
        {
            // Decide which is decimal separator by last index
            int lastDot = s.LastIndexOf('.');
            int lastComma = s.LastIndexOf(',');
            if (lastComma > lastDot)
            {
                // comma is decimal separator
                normalized = s.Replace(".", string.Empty).Replace(',', '.');
            }
            else
            {
                // dot is decimal separator
                normalized = s.Replace(",", string.Empty);
            }
        }
        else if (hasComma && !hasDot)
        {
            // treat comma as decimal separator
            normalized = s.Replace(',', '.');
        }
        else
        {
            // only dot or neither -> keep as-is
            normalized = s;
        }

        if (decimal.TryParse(normalized, NumberStyles.Number, CultureInfo.InvariantCulture, out var result))
        {
            value = result;
            return true;
        }

        // Fallback: try current culture as last resort
        if (decimal.TryParse(s, NumberStyles.Number, CultureInfo.CurrentCulture, out result))
        {
            value = result;
            return true;
        }

        return false;
    }

private async Task ConfirmAddToCart()
{
    // prefer computed quantity from buffer if present
    var computed = ComputeQuantityFromBuffer();
    if (computed > 0)
        selectedQuantity = computed;

    var qty = selectedQuantity ?? 1; // default 1 if user leaves empty

    // always add to active cart
    var targetCart = activeCart.Items;

    // consider product identity + temperatura when merging items
    try { _ = JS.InvokeVoidAsync("console.log", $"ConfirmAddToCart -> active={activeCartIndex} selectedProductId={selectedProduct?.Id} qty={qty}"); } catch { }
    var existing = targetCart.FirstOrDefault(c => c.Produto.Id == selectedProduct.Id && (c.Temperatura ?? string.Empty) == (selectedTemperatura ?? string.Empty));

    if (existing == null)
    {
            var precoUnit = selectedProduct.Preco;
            // treat 'Nenhuma' (null) as Quente — prefer PrecoQuente when available
            var temp = selectedTemperatura ?? "Quente";
            if (temp == "Quente")
            {
                if (selectedProduct.PrecoQuente > 0) precoUnit = selectedProduct.PrecoQuente;
            }
            else if (temp == "Gelada")
            {
                if (selectedProduct.PrecoGelada > 0) precoUnit = selectedProduct.PrecoGelada;
            }
            else
            {
                // fallback: if order status indicates retirada/entrega, use those prices
                if (pedidoStatus == "Retirada" && selectedProduct.PrecoRetirar > 0) precoUnit = selectedProduct.PrecoRetirar;
                if (pedidoStatus == "Em entrega" && selectedProduct.PrecoEntrega > 0) precoUnit = selectedProduct.PrecoEntrega;
            }

        // If current order status is delivery, apply surcharge to the price we add
        var cartItem = new CartItem
        {
            Produto = selectedProduct,
            Quantidade = qty,
            PrecoUnitario = precoUnit,
            Temperatura = selectedTemperatura,
            DeliverySurchargeApplied = false
        };

        // do not modify prices when adding; only change PedidoStatus should alter prices elsewhere

        targetCart.Add(cartItem);
        SyncPriceInputs();
    }
    else
    {
        // same product and temperature -> increment quantity
        existing.Quantidade += qty;
        SyncPriceInputs();
    }

    showQuantityModal = false;
    // do not clear product filters or search when closing modal; keep current product list visible
    UpdateCartTotals();
    StateHasChanged();
    
    // Return focus to search input after adding to cart
    await Task.Delay(50); // allow UI to update
    try 
    { 
        await JS.InvokeVoidAsync("eval", "document.getElementById('searchInput')?.focus()"); 
    } 
    catch { }
}

private async Task OnQuantityKeyDown(KeyboardEventArgs e)
{
    if (e.Key == "Enter")
    {
        await ConfirmAddToCart();
    }
    else if (e.Key == "Escape")
    {
        CloseModal();
    }
}

private void OnQuantityKeyPress(KeyboardEventArgs e)
{
    // Only allow numbers (0-9) and 'x' or 'X' for multiplication
    var key = e.Key;
    
    // Allow numbers 0-9
    if (key.Length == 1 && char.IsDigit(key[0]))
    {
        return;
    }
    
    // Allow 'x' or 'X' for multiplication
    if (key == "x" || key == "X")
    {
        return;
    }
    
    // Block all other keys (including letters like n, q, g)
    // Note: This won't prevent the keystroke in Blazor WASM, but combined with JS preventDefault it will work
}

void UpdateCartTotals()
{
    EnsurePagamento1State();
    RecalculateSecondary();
    // debug: log totals so we can see in browser console when this runs
    try
    {
        _ = JS.InvokeVoidAsync("console.log", $"UpdateCartTotals called: cartTotal={activeCart.Items.Sum(p => p.Total)} items={activeCart.Items.Count}");
    }
    catch { }
    StateHasChanged();
}

private void OnPrecoUnitarioChanged(CartItem item, ChangeEventArgs e)
{
    var s = e?.Value?.ToString();
    if (string.IsNullOrWhiteSpace(s))
    {
        item.PrecoUnitario = 0m;
    }
    else if (decimal.TryParse(s, out var v))
    {
        item.PrecoUnitario = Math.Round(v, 2);
    }

    UpdateCartTotals();
}

    private async Task OnPrecoUnitarioTyping(int index, ChangeEventArgs e)
    {
        var s = e?.Value?.ToString() ?? string.Empty;
        EnsurePriceInputsMatchCart();
        if (index < 0 || index >= activeCart.Items.Count)
            return;

        if (index >= 0 && index < priceInputs.Count)
            priceInputs[index] = s;

        // tolerant parse: if user types trailing separator, append 0 so parsing succeeds
        var sForParse = s.Trim();
        if (sForParse.EndsWith(",") || sForParse.EndsWith("."))
            sForParse += "0";

        if (TryParseDecimalFlexible(sForParse, out var v))
        {
            // update model value but DO NOT rewrite the user's typed string while typing
            activeCart.Items[index].PrecoUnitario = Math.Round(v, 2);
            // priceInputs[index] is left as the raw user input to avoid interfering with typing/caret
        }
        else if (string.IsNullOrWhiteSpace(s))
        {
            activeCart.Items[index].PrecoUnitario = 0m;
        }

        UpdateCartTotals();
        await JS.InvokeVoidAsync("console.log", $"OnPrecoUnitarioTyping idx={index} input='{s}' price={activeCart.Items[index].PrecoUnitario} total={activeCart.Items[index].Total} cartTotal={activeCart.Items.Sum(p => p.Total)}");
        StateHasChanged();
    }

    private async Task OnPrecoUnitarioCommit(int index, ChangeEventArgs e)
    {
        var s = e?.Value?.ToString();
        if (index < 0 || index >= activeCart.Items.Count) return;
        var item = activeCart.Items[index];

        if (string.IsNullOrWhiteSpace(s))
        {
            item.PrecoUnitario = 0m;
            if (index >= 0 && index < priceInputs.Count) priceInputs[index] = string.Empty;
        }
        else if (TryParseDecimalFlexible(s, out var v))
        {
            item.PrecoUnitario = Math.Round(v, 2);
            if (index >= 0 && index < priceInputs.Count) priceInputs[index] = item.PrecoUnitario.ToString("0.00", CultureInfo.CurrentCulture);
        }

        UpdateCartTotals();
        await JS.InvokeVoidAsync("console.log", $"OnPrecoUnitarioCommit idx={index} input='{s}' price={item.PrecoUnitario} total={item.Total} cartTotal={activeCart.Items.Sum(p => p.Total)}");
        StateHasChanged();
    }

    private void OnPriceInputChanged(int index)
    {
        EnsurePriceInputsMatchCart();
        if (index < 0 || index >= activeCart.Items.Count) return;
        var s = priceInputs[index] ?? string.Empty;
        // tolerant parse
        var sForParse = s.Trim();
        if (sForParse.EndsWith(",") || sForParse.EndsWith(".")) sForParse += "0";
        if (TryParseDecimalFlexible(sForParse, out var v))
        {
            activeCart.Items[index].PrecoUnitario = Math.Round(v, 2);
            // normalize display
            priceInputs[index] = activeCart.Items[index].PrecoUnitario.ToString("0.00", CultureInfo.CurrentCulture);
        }
        else if (string.IsNullOrWhiteSpace(s))
        {
            activeCart.Items[index].PrecoUnitario = 0m;
            priceInputs[index] = string.Empty;
        }
        UpdateCartTotals();
        // debug log
        _ = JS.InvokeVoidAsync($"console.log", $"OnPriceInputChanged idx={index} input='{s}' parsed={activeCart.Items[index].PrecoUnitario} lineTotal={activeCart.Items[index].Total} cartTotal={activeCart.Items.Sum(p => p.Total)}");
        StateHasChanged();
    }

    private void OnPagamento1Input(ChangeEventArgs e)
    {
        var s = e?.Value?.ToString() ?? string.Empty;
        pagamento1Text = s;
        if (string.IsNullOrWhiteSpace(s))
        {
            pagamento1 = null;
        }
        else if (TryParseDecimalFlexible(s, out var v))
        {
            pagamento1 = Math.Round(v, 2);
        }

        RecalculateSecondary();
    }

private void OnUsarPagamento2Changed()
{
    // If enabling payment2, clear pagamento1 so user can enter a custom value
    if (activeCart.UsarPagamento2)
    {
        activeCart.Pagamento1 = null;
        activeCart.Pagamento1Text = string.Empty;
        // Calcular automaticamente o valor do pagamento 2
        activeCart.Pagamento2 = CalcularValorPagamento2();
    }
    else
    {
        // If disabling payment2, set pagamento1 to cart total and lock it
        activeCart.Pagamento1 = Math.Round(activeCart.Items.Sum(p => p.Total), 2);
        activeCart.Pagamento1Text = activeCart.Pagamento1.Value.ToString("0.00", CultureInfo.CurrentCulture);
        activeCart.Pagamento2 = null;
    }

    RecalculateSecondary();
}

    private decimal valorRecebidoDinheiro;
    private decimal valorRecebidoDinheiro2;

    private decimal trocoDinheiro => ComputeTrocoPrimary();
    private decimal trocoDinheiro2 => ComputeTrocoSecondary();

    private decimal ComputeTrocoPrimary()
    {
        var total = activeCart.Items.Sum(p => p.Total);

        // use effective forms (cart-first, fallback to UI-local)
        var effectiveForma = !string.IsNullOrEmpty(activeCart.FormaPagamentoSelecionada) ? activeCart.FormaPagamentoSelecionada : formaPagamentoSelecionada;
        var usingPagamento2 = activeCart.UsarPagamento2 || UsarPagamento2;

        // Determine how much was paid as primary cash (prefer explicit cart fields)
        decimal paidPrimary = 0m;
        if (string.Equals(effectiveForma, "Dinheiro", StringComparison.OrdinalIgnoreCase))
        {
            if (activeCart.Pagamento1.HasValue && activeCart.Pagamento1.Value > 0) paidPrimary = activeCart.Pagamento1.Value;
            else if (activeCart.ValorRecebidoDinheiro > 0) paidPrimary = activeCart.ValorRecebidoDinheiro;
            else if (pagamento1.HasValue && pagamento1.Value > 0) paidPrimary = pagamento1.Value;
            else paidPrimary = valorRecebidoDinheiro;
        }

        // Determine how much was paid as secondary cash (if any and if it's cash)
        decimal paidSecondary = 0m;
        if (usingPagamento2)
        {
            var effectiveForma2 = !string.IsNullOrEmpty(activeCart.FormaPagamento2) ? activeCart.FormaPagamento2 : formaPagamento2;
            if (string.Equals(effectiveForma2, "Dinheiro", StringComparison.OrdinalIgnoreCase))
            {
                if (activeCart.Pagamento2.HasValue && activeCart.Pagamento2.Value > 0) paidSecondary = activeCart.Pagamento2.Value;
                else if (activeCart.ValorRecebidoDinheiro2 > 0) paidSecondary = activeCart.ValorRecebidoDinheiro2;
                else if (pagamento2.HasValue && pagamento2.Value > 0) paidSecondary = pagamento2.Value;
                else paidSecondary = valorRecebidoDinheiro2;
            }
        }

        // Secondary cash covers up to paidSecondary; remaining amount is covered by primary
        var remainingForPrimary = Math.Max(0m, total - paidSecondary);
        var assignedToPrimary = Math.Min(paidPrimary, remainingForPrimary);

        var troco = paidPrimary - assignedToPrimary;
        return Math.Round(troco, 2);
    }

    private decimal ComputeTrocoSecondary()
    {
        var total = activeCart.Items.Sum(p => p.Total);

        var usingPagamento2 = activeCart.UsarPagamento2 || UsarPagamento2;
        var effectiveForma2 = !string.IsNullOrEmpty(activeCart.FormaPagamento2) ? activeCart.FormaPagamento2 : formaPagamento2;
        if (!(usingPagamento2 && string.Equals(effectiveForma2, "Dinheiro", StringComparison.OrdinalIgnoreCase)))
            return 0m;

        // determine paid secondary (cart-first)
        decimal paidSecondary = 0m;
        if (activeCart.Pagamento2.HasValue && activeCart.Pagamento2.Value > 0) paidSecondary = activeCart.Pagamento2.Value;
        else if (activeCart.ValorRecebidoDinheiro2 > 0) paidSecondary = activeCart.ValorRecebidoDinheiro2;
        else if (pagamento2.HasValue && pagamento2.Value > 0) paidSecondary = pagamento2.Value;
        else paidSecondary = valorRecebidoDinheiro2;

        // determine paid primary (cart-first)
        decimal paidPrimary = 0m;
        var effectiveForma = !string.IsNullOrEmpty(activeCart.FormaPagamentoSelecionada) ? activeCart.FormaPagamentoSelecionada : formaPagamentoSelecionada;
        if (string.Equals(effectiveForma, "Dinheiro", StringComparison.OrdinalIgnoreCase))
        {
            if (activeCart.Pagamento1.HasValue && activeCart.Pagamento1.Value > 0) paidPrimary = activeCart.Pagamento1.Value;
            else if (activeCart.ValorRecebidoDinheiro > 0) paidPrimary = activeCart.ValorRecebidoDinheiro;
            else if (pagamento1.HasValue && pagamento1.Value > 0) paidPrimary = pagamento1.Value;
            else paidPrimary = valorRecebidoDinheiro;
        }

        var remainingForSecondary = Math.Max(0m, total - paidPrimary);
        var assignedToSecondary = Math.Min(paidSecondary, remainingForSecondary);

        var troco = paidSecondary - assignedToSecondary;
        return Math.Round(troco, 2);
    }

    private int? NumeroComanda => int.TryParse(activeCart.ClienteNome, out int num) ? num : (int?)null;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // try to restore previous caixa state if any
            await RestoreCaixaStateIfAnyAsync();

            // If opened via external scanner app it may include ?scanned=CODE in the URL -> handle it
            try
            {
                var uri = Navigation.Uri;
                var marker = "?scanned=";
                var idx = uri.IndexOf(marker, StringComparison.OrdinalIgnoreCase);
                if (idx >= 0)
                {
                    var code = Uri.UnescapeDataString(uri.Substring(idx + marker.Length));
                    if (!string.IsNullOrWhiteSpace(code))
                    {
                        // remove query part from URL and process
                        var baseUri = uri.Substring(0, idx);
                        // navigate to base to remove query (keeps app state)
                        Navigation.NavigateTo(baseUri, replace: true);
                        await ProcessBarcode(code);
                    }
                }
            }
            catch { }

            var nome = await JS.InvokeAsync<string>("sessionStorage.getItem", "Email");

            if (string.IsNullOrEmpty(nome))
            {
                Navigation.NavigateTo("login");
                return;
            }

            var (produtosMaisVendidos, errorMessage) = await _apiService.GetProdutosMaisVendidos();
            // Filtrar apenas produtos disponíveis
            filteredProdutos = (produtosMaisVendidos ?? new List<Produto>()).Where(p => p.Disponivel).ToList();

            // load all products once for brand/size quick filters (apenas disponíveis)
            var (all, errAll) = await _apiService.GetTodosProdutos();
            allProdutos = (all ?? new List<Produto>()).Where(p => p.Disponivel).ToList();
            PopulateMarcasFromProdutos(allProdutos);

            // Preencher lista de vendedores aqui (OnInitializedAsync) e selecionar o primeiro por padrão
            if (vendedores == null || !vendedores.Any())
            {
                vendedores = new List<string> { "Ronaldo", "Nathan", "Carlinhos", "Allan", "Beatriz", "Kayke" };
            }
            try
            {
                var last = await JS.InvokeAsync<string>("sessionStorage.getItem", "lastVendedor");
                if (!string.IsNullOrEmpty(last))
                {
                    vendedorNome = last;
                    isOtherVendedorSelected = !vendedores.Contains(vendedorNome);
                }
                // restore last used primary payment form if present
                try
                {
                    var lastFp = await JS.InvokeAsync<string>("sessionStorage.getItem", "lastFormaPagamento1");
                    if (!string.IsNullOrEmpty(lastFp))
                    {
                        formaPagamentoSelecionada = lastFp;
                    }
                }
                catch { }
            }
            catch { }
        }
        catch (Exception ex)
        {
            initializationError = ex.Message;
            try { await JS.InvokeVoidAsync("console.error", "CaixaPage OnInitializedAsync error: " + ex.Message); } catch { }
        }
    }

    private async Task BuscarSugestoesComanda(ChangeEventArgs e)
    {
        activeCart.ClienteNome = e.Value.ToString();

        if (string.IsNullOrWhiteSpace(clienteNome))
        {
            sugestoesComanda.Clear();
            return;
        }

        // Se ainda não carregou todas as comandas abertas
        if (!todasComandasAbertas.Any())
        {
            var (lista, erro) = await _apiService.GetComandas();
            todasComandasAbertas = lista ?? new();
        }

        sugestoesComanda = todasComandasAbertas
            .Where(c => c.Nome.Contains(activeCart.ClienteNome, StringComparison.OrdinalIgnoreCase))
            .Take(5) // Limita sugestões
            .ToList();
    }

    private void SelecionarSugestaoComanda(string idSelecionado)
    {
        activeCart.ClienteNome = idSelecionado;
        sugestoesComanda.Clear();
    }

    private string GetProdutoImageSrc(Produto produto)
    {
        // Prefer Produto.CaminhoImagem (already includes AppConfig.BaseUrl) when available
        if (!string.IsNullOrEmpty(produto.CaminhoImagem))
            return produto.CaminhoImagem;

        // Fallback to UrlImagem if it's already an absolute URL
        if (!string.IsNullOrEmpty(produto.UrlImagem) && produto.UrlImagem.StartsWith("http", StringComparison.OrdinalIgnoreCase))
            return produto.UrlImagem;

        return string.Empty;
    }

    private async Task SearchByNome(ChangeEventArgs e)
    {
        searchBarcode = string.Empty; // Limpa a pesquisa por código de barras
        searchNome = e.Value.ToString();
        if (string.IsNullOrWhiteSpace(searchNome))
        {
            var (maisVendidos, errorMessage) = await _apiService.GetProdutosMaisVendidos();
            filteredProdutos = maisVendidos;
        }
        else
        {
            var (todosProdutos, errorMessage) = await _apiService.GetTodosProdutos();
            filteredProdutos = todosProdutos
                                .Where(c => c.Nome.IndexOf(searchNome, StringComparison.OrdinalIgnoreCase) >= 0)
                                .ToList();
        }
    }

    private async Task SearchByBarcode(ChangeEventArgs e)
    {
        searchNome = string.Empty; // Limpa a pesquisa por nome
        searchBarcode = e.Value.ToString();
        if (string.IsNullOrWhiteSpace(searchBarcode))
        {
            var (todosProdutos, errorMessage) = await _apiService.GetTodosProdutos();
            filteredProdutos = todosProdutos;
        }
        else
        {
            var (todosProdutos, errorMessage) = await _apiService.GetTodosProdutos();
            filteredProdutos = todosProdutos
                                .Where(c => c.Barcode == searchBarcode)
                                .ToList();
        }
    }

    private async Task OnBarcodeInput(ChangeEventArgs e)
    {
        // keep behavior consistent with SearchByBarcode
        searchNome = string.Empty;
        searchBarcode = e?.Value?.ToString();

        if (string.IsNullOrWhiteSpace(searchBarcode))
        {
            var (todosProdutos, errorMessage) = await _apiService.GetTodosProdutos();
            filteredProdutos = todosProdutos ?? new List<Produto>();
        }
        else
        {
            var (todosProdutos, errorMessage) = await _apiService.GetTodosProdutos();
            filteredProdutos = (todosProdutos ?? new List<Produto>())
                                .Where(c => string.Equals(c.Barcode, searchBarcode, StringComparison.OrdinalIgnoreCase))
                                .ToList();
        }
    }

    // private void AddToCart(Produto Produto)
    // {
    //     var newItem = new CartItem
    //     {
    //         Produto = Produto,
    //         Quantidade = 1
    //     };
    //     cart.Add(Produto);
    // }

    private void RemoveFromCart(CartItem  Produto)
    {
        activeCart.Items.Remove(Produto);
        EnsurePagamento1State();
        SyncPriceInputs();
        EnsurePriceInputsMatchCart();
        StateHasChanged();
    }

    private async Task AddBlankCartItem()
    {
        var blank = new Produto { Id = 0, Nome = string.Empty, Preco = 0m, PrecoCusto = 0.01m, CategoriaId = 1 };
        var item = new CartItem { Produto = blank, Quantidade = 1, PrecoUnitario = 0m };
        activeCart.Items.Add(item);
        EnsurePagamento1State();
        SyncPriceInputs();
        EnsurePriceInputsMatchCart();
        UpdateCartTotals();
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task AddBlankCartItemAndFocus()
    {
        await AddBlankCartItem();
        // give Blazor a moment to render the new row
        await Task.Delay(30);
        try {
            await JS.InvokeVoidAsync("focusFirstBlankDescricao");
        } catch { }
    }

    private async Task SwitchToCart(int index)
    {
        if (index < 0 || index >= carts.Count) return;
        // ensure any modals/backdrops are closed so buttons are clickable
        showQuantityModal = false;
        showCreateProductModal = false;
        // remove any lingering modal-backdrop elements that may block clicks
        try { await JS.InvokeVoidAsync("eval", "document.querySelectorAll('.modal-backdrop').forEach(e=>e.remove())"); } catch { }
        activeCartIndex = index;
        // sync commonly used UI-local variables from the newly active cart so the UI reflects it
        try
        {
            formaPagamentoSelecionada = activeCart.FormaPagamentoSelecionada ?? string.Empty;
            formaPagamento2 = activeCart.FormaPagamento2 ?? string.Empty;
            pagamento1 = activeCart.Pagamento1;
            pagamento2 = activeCart.Pagamento2;
            pagamento1Text = activeCart.Pagamento1Text ?? string.Empty;
            UsarPagamento2 = activeCart.UsarPagamento2;
            vendedorNome = activeCart.VendedorNome ?? string.Empty;
            clienteNome = activeCart.ClienteNome ?? string.Empty;
            pedidoStatus = activeCart.PedidoStatus ?? "Finalizado";
        }
        catch { }
        // resync priceInputs for the newly active cart
        SyncPriceInputs();
        EnsurePriceInputsMatchCart();
        try { _ = JS.InvokeVoidAsync("console.log", $"SwitchToCart -> active={activeCartIndex} items={activeCart.Items.Count}"); } catch { }
        await InvokeAsync(StateHasChanged);
    }

    private async Task AddNewCart()
    {
        // limit to a reasonable number (e.g., 4) to avoid UI clutter
        if (carts.Count >= 4) return;
        // close modals/backdrops first
        showQuantityModal = false;
        showCreateProductModal = false;
        try { await JS.InvokeVoidAsync("eval", "document.querySelectorAll('.modal-backdrop').forEach(e=>e.remove())"); } catch { }
        carts.Add(new CartState());
        activeCartIndex = carts.Count - 1;
        // sync UI-local variables to the new cart (defaults)
        try
        {
            formaPagamentoSelecionada = activeCart.FormaPagamentoSelecionada ?? string.Empty;
            formaPagamento2 = activeCart.FormaPagamento2 ?? string.Empty;
            pagamento1 = activeCart.Pagamento1;
            pagamento2 = activeCart.Pagamento2;
            pagamento1Text = activeCart.Pagamento1Text ?? string.Empty;
            UsarPagamento2 = activeCart.UsarPagamento2;
            vendedorNome = activeCart.VendedorNome ?? string.Empty;
            clienteNome = activeCart.ClienteNome ?? string.Empty;
            pedidoStatus = activeCart.PedidoStatus ?? "Finalizado";
        }
        catch { }
        SyncPriceInputs();
        EnsurePriceInputsMatchCart();
        try { _ = JS.InvokeVoidAsync("console.log", $"AddNewCart -> count={carts.Count} active={activeCartIndex}"); } catch { }
        await InvokeAsync(StateHasChanged);
    }

    private async Task FinalizePurchase()
    {
        // validate using activeCart values (fallback to local UI variables)
        var effectiveVendedor = !string.IsNullOrWhiteSpace(activeCart.VendedorNome) ? activeCart.VendedorNome : vendedorNome;
        if (string.IsNullOrWhiteSpace(effectiveVendedor))
        {
            await ShowAlert("Por favor selecione ou digite o nome do vendedor antes de finalizar a compra.");
            return;
        }

        var effectivePedido = !string.IsNullOrWhiteSpace(activeCart.PedidoStatus) ? activeCart.PedidoStatus : pedidoStatus;
        if (string.IsNullOrWhiteSpace(effectivePedido))
        {
            await ShowAlert("Por favor selecione o status do pedido antes de finalizar a compra.");
            return;
        }

        var effectiveForma = !string.IsNullOrEmpty(activeCart.FormaPagamentoSelecionada) ? activeCart.FormaPagamentoSelecionada : formaPagamentoSelecionada;
        var effectiveCliente = !string.IsNullOrWhiteSpace(activeCart.ClienteNome) ? activeCart.ClienteNome : clienteNome;
        var effectiveDataPrazo = activeCart.DataPagamentoPrazo ?? dataPagamentoPrazo;

        if (string.Equals(effectiveForma, "A Prazo", StringComparison.OrdinalIgnoreCase))
        {
            if (!effectiveDataPrazo.HasValue)
            {
                await ShowAlert("Para pagamento a prazo, informe a data de pagamento (prazo).");
                return;
            }
            if (string.IsNullOrWhiteSpace(effectiveCliente))
            {
                await ShowAlert("Para pagamento a prazo (forma 1), informe o nome do cliente.");
                return;
            }
        }

        var usingPagamento2 = activeCart.UsarPagamento2 || UsarPagamento2;
        var effectiveForma2 = !string.IsNullOrEmpty(activeCart.FormaPagamento2) ? activeCart.FormaPagamento2 : formaPagamento2;
        if (usingPagamento2 && string.Equals(effectiveForma2, "A Prazo", StringComparison.OrdinalIgnoreCase))
        {
            if (string.IsNullOrWhiteSpace(effectiveCliente))
            {
                await ShowAlert("Para pagamento a prazo (forma 2), informe o nome do cliente.");
                return;
            }
        }
        // Build DTO matching backend PedidoDetalheDTO for items
        var itensDto = activeCart.Items.Select(item => new
        {
            ProdutoId = item.Produto.Id,    
            ProdutoNome = item.Produto.Nome,
            ProdutoImagem = item.Produto.UrlImagem ?? item.Produto.CaminhoImagem,
            Quantidade = item.Quantidade,
            ProdutoPreco = item.PrecoUnitario,
            SubTotal = item.Total,
            CaminhoImagem = item.Produto.CaminhoImagem ?? (item.Produto.UrlImagem != null ? AppConfig.BaseUrl + item.Produto.UrlImagem : null)
        }).ToList();

        var pedidoDto = new
        {
            Endereco = activeCart.EntryEndereco ?? entryEndereco,
            VendedorNome = effectiveVendedor,
            ClienteNome = effectiveCliente,
            ValorTotal = activeCart.Items.Sum(p => p.Total),
            DataPedido = DateTime.Now,
            FormaPagamento = effectiveForma,
            ValorPago1 = activeCart.Pagamento1 ?? pagamento1,
            FormaPagamento2 = effectiveForma2,
            ValorPago2 = activeCart.Pagamento2 ?? pagamento2,
            Status = effectivePedido,
            DataPagamentoPrazo = activeCart.DataPagamentoPrazo ?? dataPagamentoPrazo,
            DataPagamentoPrazo2 = activeCart.DataPagamentoPrazo2 ?? dataPagamentoPrazo2,
            Observacoes = activeCart.Observacoes ?? observacoes,
            Itens = itensDto
        };

        // serialize and post directly to API
        var json = System.Text.Json.JsonSerializer.Serialize(pedidoDto);
        var content = new System.Net.Http.StringContent(json, System.Text.Encoding.UTF8, "application/json");

        var response = await _apiService.PostRequest("api/Pedidos", content);

        if (!response.IsSuccessStatusCode)
        {
            await ShowAlert($"Falha ao confirmar pedido: {response.ReasonPhrase}");
            return;
        }

        // registrar movimentações de estoque
        foreach (var item in activeCart.Items)
        {
            var movimentacao = new MovimentacaoEstoque()
            {
                ProdutoId = item.Produto.Id,
                Tipo = TipoMovimentacao.Venda,
                Quantidade = 1,
                DataMovimentacao = DateTime.Now
            };
            await _apiService.MovimentarEstoqueAsync(movimentacao);
        }

        // If payment includes cash, open cash drawer via print service
        if (string.Equals(formaPagamentoSelecionada, "Dinheiro", StringComparison.OrdinalIgnoreCase)
            || (UsarPagamento2 && string.Equals(formaPagamento2, "Dinheiro", StringComparison.OrdinalIgnoreCase)))
        {
            try
            {
                var resp = await _apiService.AbrirGavetaAsync("192.168.1.51", 9100);
                if (!resp.Data)
                {
                    try { await JS.InvokeVoidAsync("console.warn", "Falha ao abrir gaveta: " + (resp.ErrorMessage ?? "unknown")); } catch { }
                }
            }
            catch (Exception ex)
            {
                try { await JS.InvokeVoidAsync("console.error", "Erro ao solicitar abertura de gaveta: " + ex.Message); } catch { }
            }
        }

        // clear active cart and its payment fields
        activeCart.Items.Clear();
        activeCart.FormaPagamentoSelecionada = string.Empty;
        activeCart.FormaPagamento2 = string.Empty;
        activeCart.Pagamento1 = null;
        activeCart.Pagamento2 = null;
        activeCart.Pagamento1Text = string.Empty;
        activeCart.UsarPagamento2 = false;
        activeCart.SecondaryCalculated = false;
        activeCart.ValorRecebidoDinheiro = 0m;
        activeCart.ValorRecebidoDinheiro2 = 0m;
        activeCart.ClienteNome = string.Empty;
        activeCart.VendedorNome = effectiveVendedor; // keep last vendedor stored on cart
        activeCart.PedidoStatus = "Finalizado";
        activeCart.EntryTelefone = string.Empty;
        activeCart.EntryEndereco = string.Empty;
        activeCart.Observacoes = string.Empty;
        activeCart.DataPagamentoPrazo = null;
        activeCart.DataPagamentoPrazo2 = null;

        // remember last primary formaPagamentoSelecionada and persist it (use effectiveForma)
        try { await JS.InvokeVoidAsync("sessionStorage.setItem", "lastFormaPagamento1", effectiveForma ?? string.Empty); } catch { }
        // persist last vendedor so it can be restored on next load
        try { await JS.InvokeVoidAsync("sessionStorage.setItem", "lastVendedor", effectiveVendedor ?? string.Empty); } catch { }

        // also clear local UI variables so UI resets
        formaPagamentoSelecionada = string.Empty;
        formaPagamento2 = string.Empty;
        UsarPagamento2 = false;
        pagamento1 = null;
        pagamento2 = null;
        valorRecebidoDinheiro = 0m;
        valorRecebidoDinheiro2 = 0m;
        clienteNome = string.Empty;
        pedidoStatus = "Finalizado";
        entryTelefone = string.Empty;
        entryEndereco = string.Empty;
        observacoes = string.Empty;
        dataPagamentoPrazo = null;
        dataPagamentoPrazo2 = null;

        StateHasChanged(); // Atualiza a UI
        Console.WriteLine("Compra finalizada!");
    }

    private void RecalculateSecondary()
    {
        try
        {
            if (!UsarPagamento2)
            {
                SecondaryCalculated = false;
                return;
            }

            var total = activeCart.Items.Sum(p => p.Total);

            // if primary provided, allocate remaining to secondary
            var primaryValue = pagamento1 ?? 0m;

            var remaining = total - primaryValue;
            if (remaining <= 0)
            {
                pagamento2 = 0m;
            }
            else
            {
                pagamento2 = Math.Round(remaining, 2);
            }

            SecondaryCalculated = true;
        }
        catch { }
    }

    private async Task CreateComanda()
    {
        if (isProcessing)
            return;

        if (string.IsNullOrEmpty(clienteNome))
            return;

        isProcessing = true;

        try
        {
            if (!string.IsNullOrEmpty(entryTelefone))
            {
            var (existeCliente, errorMessage) = await _apiService.GetClienteByPhoneAsync(entryTelefone);
            if (existeCliente == null)
            {
                var novoCliente = new Clientes
                    {
                        Nome = clienteNome,
                        Telefone = entryTelefone,
                        Endereco = entryEndereco
                    };
                var respondeCliente = await _apiService.AddClienteAsync(novoCliente);
            }
        }
            var (comandaExistente, erro) = await _apiService.GetComandaPorNome(clienteNome);

            if (comandaExistente != null)
            {
                var produtosCart = activeCart.Items.Select(p => new Produto
                {
                    Id = p.Produto.Id,
                    Nome = p.Produto.Nome,
                    Preco = p.Produto.Preco,
                    UrlImagem = p.Produto.UrlImagem
                }).ToList();

                // Comanda já existe, adicionar produtos do carrinho a ela
                await AdicionarProdutosAComanda(comandaExistente.Nome, produtosCart);
                await AtualizarValorComanda(comandaExistente.Nome);
            }
            else
            {
                // Comanda não existe, criar uma nova
                var comandaId = await CriarNovaComanda(clienteNome, itensComanda);
                var produtosCart = activeCart.Items.Select(p => new Produto
                {
                    Id = p.Produto.Id,
                    Nome = p.Produto.Nome,
                    Preco = p.Produto.Preco,
                    UrlImagem = p.Produto.UrlImagem
                }).ToList();

                if (!(comandaId == 0))
                {
                    await AdicionarProdutosAComanda(clienteNome, produtosCart);
                    await AtualizarValorComanda(clienteNome);
                }
            }
            activeCart.Items.Clear();
            itensComanda.Clear();
            clienteNome = string.Empty;
            entryTelefone = string.Empty;
            StateHasChanged(); // Atualiza a UI
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao criar ou atualizar comanda: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task AdicionarProdutosAComanda(string nome, List<Produto> carrinho)
    {
        //adicionar os itens na comanda
        foreach (var produto in carrinho)
        {
            var itemComanda = new ItemComanda
            {
                Nome = nome,
                PrecoUnitario = produto.Preco,
                Quantidade = 1,
                ProdutoId = produto.Id,
                NomeProduto = produto.Nome,
                UrlImagem = produto.UrlImagem
            };
            var responseAddItem = await _apiService.AdicionaItemNaComanda(itemComanda);
            if (responseAddItem.Data)
            {
                // await ShowAlert("Item adicionado na comanda !");
            }
            else
            {
                await ShowAlert($"Falha ao adicionar item: {responseAddItem.ErrorMessage}");
            }
            var movimentacao = new MovimentacaoEstoque()
            {
                ProdutoId = produto.Id,
                Tipo = TipoMovimentacao.Venda,
                Quantidade = 1,
                DataMovimentacao = DateTime.Now
            };
            var responseMovimetacao = await _apiService.MovimentarEstoqueAsync(movimentacao);
            if (responseMovimetacao.Data)
            {
                // await ShowAlert("Item adicionado na comanda !");
            }
            else
            {
                // await ShowAlert($"Falha ao movimentar estoque: {responseAddItem.ErrorMessage}");
            }
        }
    }

    private async Task<int> CriarNovaComanda(string nome, List<ItemComanda> carrinho)
    {
        var dto = carrinho.Select(i => new ItemComandaDTO
        {
            Id = i.Id,
            Nome = i.Nome,
            ProdutoId = i.ProdutoId,
            NomeProduto = i.NomeProduto,
            Quantidade = i.Quantidade,
            PrecoUnitario = i.PrecoUnitario
        }).ToList();

        // Verifica se o carrinho tem produtos da categoria 99 (Cozinha)
        var temProdutosDeCozinha = dto.Any(p => p.CategoriaId == 22 || p.CategoriaId == 18);

        // Define o status com base nisso
        var statusComanda = temProdutosDeCozinha ? "Aguardando Impressao" : "Aberta";

        // Cria a nova comanda com o status adequado
        var novaComanda = new Comanda()
        {
            DataAbertura = DateTime.Now,
            Nome = nome,
            ValorTotal = carrinho.Sum(p => p.ValorTotal),
            Itens = carrinho,
            Status = statusComanda
        };


        var responseComanda = await _apiService.CriarComanda(novaComanda);
        if (responseComanda.Data != null)
        {
            // await ShowAlert("Comanda criada!");
            return responseComanda.Data;
        }
        else
        {
            await ShowAlert($"Falha ao criar comanda: {responseComanda.ErrorMessage}");
            return 0;
        }
    }

    private async Task AtualizarValorComanda(string nome)
    {
        var (itensComanda, errorMessage) = await _apiService.GetItensComanda(nome);

        //atualizar o valor da comanda
        var (comanda, errorMessageComanda) = await _apiService.GetComandaPorNome(nome);

        comanda.ValorTotal = itensComanda.Sum(p => p.Quantidade * p.PrecoUnitario);

        // ??? Enviar a comanda atualizada para a API para persistência no banco
        var responseUpdateComanda = await _apiService.AtualizarComanda(comanda);
        // if (!responseUpdateComanda.HasError)
        // {
        //     //await DisplayAlert("Sucesso", "Comanda atualizada!", "OK");
        //     await Navigation.PopAsync();
        // }
        // else
        // {
        //     await ShowAlert($"Falha ao criar comanda: {responseComanda.ErrorMessage}");
        // }
    }

    private async Task ShowAlert(string message)
    {
        await JS.InvokeVoidAsync("alert", message);
    }

    private async Task PrefillProductFromLookup(string code)
    {
        try
        {
            await JS.InvokeVoidAsync("console.log", "PrefillProductFromLookup: calling GetProdutoPorBarcodeLookup for: " + code);
            var (produtoLookup, errLookup) = await _apiService.GetProdutoPorBarcodeLookup(code);

            if (!string.IsNullOrEmpty(errLookup))
            {
                await JS.InvokeVoidAsync("console.warn", "GetProdutoPorBarcodeLookup returned error: " + errLookup);
            }

            if (produtoLookup != null)
            {
                newProductForBarcode.Nome = produtoLookup.Nome;
                newProductForBarcode.Preco = produtoLookup.Preco;
                newProductForBarcode.Detalhe = produtoLookup.Detalhe;
                newProductForBarcode.UrlImagem = produtoLookup.UrlImagem;
                newProductForBarcode.PrecoCusto = produtoLookup.PrecoCusto;
                newProductForBarcode.PrecoQuente = produtoLookup.PrecoQuente;
                newProductForBarcode.PrecoGelada = produtoLookup.PrecoGelada;
                newProductForBarcode.PrecoEntrega = produtoLookup.PrecoEntrega;
                newProductForBarcode.PrecoRetirar = produtoLookup.PrecoRetirar;
                newProductForBarcode.CategoriaId = produtoLookup.CategoriaId;

                try { await JS.InvokeVoidAsync("console.log", "PrefillProductFromLookup: filled -> " + System.Text.Json.JsonSerializer.Serialize(newProductForBarcode)); } catch { }

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "PrefillProductFromLookup exception: " + ex.Message);
        }
    }

}
