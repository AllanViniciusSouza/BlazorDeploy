@page "/inventario"
@using BlazorDeploy.DTOs
@using Microsoft.AspNetCore.Components.Forms
@inject ApiService _apiService
@inject AuthService AuthService
@inject IJSRuntime JS
@inject NavigationManager Navigation

<div class="row g-3">
    <div class="col-md-6">
        <div class="card p-3 mb-3">
            <h5>Registrar Movimentação</h5>

            <label class="form-label">Produto (nome ou código de barras)</label>
            <input class="form-control mb-2" value="@searchTerm" @oninput="OnProductSearchInput" placeholder="Pesquisar por nome ou código" />

            @if (produtosFiltrados.Any() && !string.IsNullOrWhiteSpace(searchTerm))
            {
                <div class="list-group mb-2" style="max-height:200px; overflow:auto;">
                    @foreach (var p in produtosFiltrados)
                    {
                        <button class="list-group-item list-group-item-action" @onclick="() => SelecionarProduto(p)">@p.Nome (@p.Barcode)</button>
                    }
                </div>
            }

            @if (produtoSelecionado != null)
            {
                <div class="mb-2"><strong>Selecionado:</strong> @produtoSelecionado.Nome</div>
            }

            <label>Quantidade</label>
            <input type="number" class="form-control mb-2" @bind="movimentacao.Quantidade" />

            <label>Tipo de Movimentação</label>
            <select class="form-select mb-2" @bind="movimentacao.Tipo">
                <option value="Compra">Entrada (Compra)</option>
                <option value="Venda">Saída (Venda)</option>
            </select>

            <label>Preço de Custo</label>
            <input type="number" step="0.01" class="form-control mb-2" @bind="movimentacao.PrecoCusto" />

            <button class="btn btn-primary w-100" @onclick="RegistrarMovimentacao">Registrar</button>
            @if (!string.IsNullOrEmpty(mensagem))
            {
                <div class="mt-2">@mensagem</div>
            }
        </div>
    </div>

    <div class="col-md-6">
        <div class="card p-3 mb-3">
            <h5>Upload de XML (Notas)</h5>
            <InputFile OnChange="OnFileSelected" accept=".xml" />
            <div class="mt-2 d-flex gap-2">
                <button class="btn btn-success" @onclick="UploadXml" disabled="@(!hasSelectedFile || isUploading)">
                    @(isUploading ? "Enviando..." : "Enviar XML")
                </button>
                <button class="btn btn-secondary" @onclick="() => { selectedFile = null; hasSelectedFile = false; }">Limpar</button>
            </div>
        </div>

        <div class="card p-3">
            <h5>Últimas Notas</h5>
            @if (latestNotas == null)
            {
                <p>Carregando...</p>
            }
            else if (!latestNotas.Any())
            {
                <p>Nenhuma nota encontrada.</p>
            }
            else
            {
                <div class="row row-cols-1 g-2">
                    @foreach (var inv in latestNotas)
                    {
                        <div class="col">
                            <div class="card p-2 shadow-sm" style="cursor:pointer;" @onclick="() => LoadInvoiceItems(inv.Id.ToString(), inv.NumeroNota)">
                                <div class="d-flex justify-content-between">
                                    <div><strong>@inv.NumeroNota</strong></div>
                                    <div class="text-muted">@inv.DataEmissao.ToString("yyyy-MM-dd")</div>
                                </div>
                                <div class="small text-muted">Fornecedor: @(inv.Fornecedor ?? "-")</div>
                                <div class="small text-muted">Valor: R$ @inv.ValorTotal.ToString("0.00")</div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <div class="col-12">
        @if (selectedItems != null)
        {
            <h5 class="mt-3">Itens da Nota: @selectedInvoiceNumber</h5>
            <div class="row row-cols-1 row-cols-md-3 g-3">
                @foreach (var it in selectedItems)
                {
                    <div class="col">
                        <div class="card p-2">
                            <div><strong>@(it.ProdutoNome ?? it.Nome ?? "-")</strong></div>
                            <div>Barcode: @(it.Barcode ?? "-")</div>
                            <div>Qtd: @it.Quantidade</div>
                            <div>Preço Custo: R$ @it.PrecoCusto.ToString("0.00")</div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private List<Produto> produtos = new();
    private List<Produto> produtosFiltrados = new();
    private MovimentacaoEstoque movimentacao = new();
    private string produtoBusca = "";
    private string searchTerm = string.Empty;
    private Produto? produtoSelecionado;
    private string mensagem = "";
    private bool isLoading = true;
    private bool isProcessing = false;
    private IBrowserFile? selectedFile;
    private bool hasSelectedFile = false;
    private bool isUploading = false;
    private List<NotaEntradaDto>? latestNotas;
    private List<NotaEntradaItemDto>? selectedItems;
    private string? selectedInvoiceNumber;


    protected override async Task OnInitializedAsync()
    {
        var nome = await JS.InvokeAsync<string>("sessionStorage.getItem", "Email");

        if (string.IsNullOrEmpty(nome))
        {
            Navigation.NavigateTo("login");
            return;
        }

        var (response, errorMessage) = await _apiService.GetTodosProdutos();
        produtos = response ?? new List<Produto>();

        // load notas via novo endpoint
        var (notas, notasErr) = await _apiService.GetNotasEntrada();
        latestNotas = notas ?? new List<NotaEntradaDto>();
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        hasSelectedFile = selectedFile != null;
    }

    private async Task UploadXml()
    {
        if (selectedFile == null) return;
        isUploading = true;
        var result = await _apiService.UploadInvoiceXml(selectedFile);
        if (result.Data)
        {
            await LoadLatestInvoices();
            await JS.InvokeVoidAsync("alert", "XML enviado com sucesso.");
        }
        else
        {
            await JS.InvokeVoidAsync("alert", $"Falha ao enviar XML: {result.ErrorMessage}");
        }
        isUploading = false;
    }

    private async Task LoadLatestInvoices()
    {
        var (list, err) = await _apiService.GetNotasEntrada();
        latestNotas = list ?? new List<NotaEntradaDto>();
    }

    private Task LoadInvoiceItems(string id, string number)
    {
        if (latestNotas == null)
            return Task.CompletedTask;

        NotaEntradaDto? nota = null;
        if (int.TryParse(id, out var iid))
            nota = latestNotas.FirstOrDefault(n => n.Id == iid || n.NumeroNota == number || n.NumeroNota == id);
        else
            nota = latestNotas.FirstOrDefault(n => n.NumeroNota == id || n.NumeroNota == number);

        if (nota != null)
        {
            selectedItems = nota.Itens ?? new List<NotaEntradaItemDto>();
            selectedInvoiceNumber = nota.NumeroNota;
        }

        return Task.CompletedTask;
    }

    private void FiltrarProdutos(ChangeEventArgs e)
    {
        produtoBusca = e.Value?.ToString() ?? "";

        var term = produtoBusca.Trim();
        if (string.IsNullOrEmpty(term))
        {
            produtosFiltrados.Clear();
            return;
        }

        // match either name or barcode
        produtosFiltrados = produtos
            .Where(p => (!string.IsNullOrEmpty(p.Nome) && p.Nome.Contains(term, StringComparison.OrdinalIgnoreCase))
                     || (!string.IsNullOrEmpty(p.Barcode) && p.Barcode.Contains(term, StringComparison.OrdinalIgnoreCase)))
            .Take(10)
            .ToList();
    }

    private void OnProductSearchInput(ChangeEventArgs e)
    {
        searchTerm = e?.Value?.ToString() ?? string.Empty;
        // reuse filter logic
        produtoBusca = searchTerm;
        FiltrarProdutos(new ChangeEventArgs { Value = produtoBusca });
    }

    private void SelecionarProduto(Produto produto)
    {
        produtoSelecionado = produto;
        movimentacao.ProdutoId = produto.Id;
        produtoBusca = produto.Nome;
        produtosFiltrados.Clear();
    }

    private async Task RegistrarMovimentacao()
    {
        var result = await _apiService.MovimentarEstoqueAsync(movimentacao);

        if (result.Data)
        {
            mensagem = "Movimentação registrada com sucesso!";
            movimentacao = new MovimentacaoEstoque();
            produtoBusca = "";
            produtoSelecionado = null;
        }
        else
        {
            mensagem = "Erro ao registrar movimentação.";
        }
    }
}
