@page "/inventario"
@using BlazorDeploy.DTOs
@using Microsoft.AspNetCore.Components.Forms
@inject ApiService _apiService
@inject AuthService AuthService
@inject IJSRuntime JS
@inject NavigationManager Navigation

<h3>Movimentação de Estoque</h3>

<div class="mb-3 position-relative">
    <label>Produto</label>
    <input type="text" class="form-control" @bind="produtoBusca" @oninput="FiltrarProdutos" placeholder="Digite o nome do produto" />

    @if (produtosFiltrados.Any() && !string.IsNullOrWhiteSpace(produtoBusca))
    {
        <ul class="list-group position-absolute w-100" style="z-index: 1000; max-height: 200px; overflow-y: auto;">
            @foreach (var produto in produtosFiltrados)
            {
                <li class="list-group-item list-group-item-action" @onclick="() => SelecionarProduto(produto)">
                    @produto.Nome
                </li>
            }
        </ul>
    }
</div>

@if (produtoSelecionado != null)
{
    <div class="alert alert-info p-2">
        <strong>Produto Selecionado:</strong> @produtoSelecionado.Nome
    </div>
}

<div class="mb-3">
    <label>Quantidade</label>
    <input type="number" @bind="movimentacao.Quantidade" class="form-control" />
</div>

<div class="mb-3">
    <label>Tipo de Movimentação</label>
    <select @bind="movimentacao.Tipo" class="form-control">
        <option value="Compra">Entrada (Compra)</option>
        <option value="Venda">Saída (Venda)</option>
    </select>
</div>

<div class="mb-3">
    <label>Preço de Custo</label>
    <input type="number" step="1.00" @bind="movimentacao.PrecoCusto" class="form-control" />
</div>

<button class="btn btn-primary" @onclick="RegistrarMovimentacao">Registrar</button>

<hr />

<h4>Upload de XML (Notas)</h4>
<InputFile OnChange="OnFileSelected" accept=".xml" />
<button class="btn btn-success mt-2" @onclick="UploadXml" disabled="@(!hasSelectedFile || isUploading)">
    @(isUploading ? "Enviando..." : "Enviar XML")
</button>

<h5 class="mt-4">Últimas Notas</h5>
@if (latestInvoices == null)
{
    <p>Carregando...</p>
}
else if (!latestInvoices.Any())
{
    <p>Nenhuma nota encontrada.</p>
}
else
{
    <ul class="list-group">
        @foreach (var inv in latestInvoices)
        {
            <li class="list-group-item list-group-item-action" style="cursor:pointer" @onclick="() => LoadInvoiceItems(inv.Id, inv.Number)">
                <div class="d-flex justify-content-between">
                    <div>@inv.Number</div>
                    <div>@inv.Date.ToString("yyyy-MM-dd")</div>
                </div>
            </li>
        }
    </ul>
}

@if (selectedItems != null)
{
    <h5 class="mt-3">Itens da Nota: @selectedInvoiceNumber</h5>
    <table class="table table-sm">
        <thead>
            <tr><th>Código</th><th>Descrição</th><th>Qtd</th><th>Preço Unit.</th></tr>
        </thead>
        <tbody>
            @foreach (var it in selectedItems)
            {
                <tr>
                    <td>@it.Code</td>
                    <td>@it.Description</td>
                    <td>@it.Quantity</td>
                    <td>@it.UnitPrice</td>
                </tr>
            }
        </tbody>
    </table>
}

@if (!string.IsNullOrEmpty(mensagem))
{
    <p class="mt-3">@mensagem</p>
}

@code {
    private List<Produto> produtos = new();
    private List<Produto> produtosFiltrados = new();
    private MovimentacaoEstoque movimentacao = new();
    private string produtoBusca = "";
    private Produto? produtoSelecionado;
    private string mensagem = "";
    private bool isLoading = true;
    private bool isProcessing = false;
    private IBrowserFile? selectedFile;
    private bool hasSelectedFile = false;
    private bool isUploading = false;
    private List<InvoiceSummary>? latestInvoices;
    private List<InvoiceItem>? selectedItems;
    private string? selectedInvoiceNumber;

    protected override async Task OnInitializedAsync()
    {
        var nome = await JS.InvokeAsync<string>("sessionStorage.getItem", "Email");

        if (string.IsNullOrEmpty(nome))
        {
            Navigation.NavigateTo("login");
            return;
        }

        var (response, errorMessage) = await _apiService.GetTodosProdutos();
        produtos = response ?? new List<Produto>();

        await LoadLatestInvoices();
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        hasSelectedFile = selectedFile != null;
    }

    private async Task UploadXml()
    {
        if (selectedFile == null) return;
        isUploading = true;
        var result = await _apiService.UploadInvoiceXml(selectedFile);
        if (result.Data)
        {
            await LoadLatestInvoices();
            await JS.InvokeVoidAsync("alert", "XML enviado com sucesso.");
        }
        else
        {
            await JS.InvokeVoidAsync("alert", $"Falha ao enviar XML: {result.ErrorMessage}");
        }
        isUploading = false;
    }

    private async Task LoadLatestInvoices()
    {
        var (list, err) = await _apiService.GetLatestInvoices();
        latestInvoices = list ?? new List<InvoiceSummary>();
    }

    private async Task LoadInvoiceItems(string id, string number)
    {
        var (items, err) = await _apiService.GetInvoiceItems(id);
        selectedItems = items ?? new List<InvoiceItem>();
        selectedInvoiceNumber = number;
    }

    private void FiltrarProdutos(ChangeEventArgs e)
    {
        produtoBusca = e.Value?.ToString() ?? "";

        produtosFiltrados = produtos
            .Where(p => p.Nome.Contains(produtoBusca, StringComparison.OrdinalIgnoreCase))
            .Take(10)
            .ToList();
    }

    private void SelecionarProduto(Produto produto)
    {
        produtoSelecionado = produto;
        movimentacao.ProdutoId = produto.Id;
        produtoBusca = produto.Nome;
        produtosFiltrados.Clear();
    }

    private async Task RegistrarMovimentacao()
    {
        var result = await _apiService.MovimentarEstoqueAsync(movimentacao);

        if (result.Data)
        {
            mensagem = "Movimentação registrada com sucesso!";
            movimentacao = new MovimentacaoEstoque();
            produtoBusca = "";
            produtoSelecionado = null;
        }
        else
        {
            mensagem = "Erro ao registrar movimentação.";
        }
    }
}
