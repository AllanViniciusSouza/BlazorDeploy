@page "/movimentacoes"
@inject ApiService _apiService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@using BlazorDeploy.Models

<PageTitle>Movimentações de Estoque</PageTitle>

<div class="d-flex align-items-center justify-content-between mb-3">
    <h3 class="mb-0">Histórico de Movimentações</h3>
    <button class="btn btn-outline-secondary" @onclick="CarregarMovimentacoes" title="Atualizar lista">
        ⟳ Atualizar
    </button>
</div>

@if (isLoading)
{
    <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-2">Carregando movimentações...</p>
    </div>
}
else if (movimentacoes == null || !movimentacoes.Any())
{
    <div class="alert alert-info">
        <strong>Nenhuma movimentação encontrada.</strong>
        <p class="mb-0">Não há registros de movimentação de estoque no sistema.</p>
    </div>
}
else
{
    <div class="mb-3">
        <input type="text" 
               class="form-control" 
               placeholder="Pesquisar por produto..." 
               @bind="termoPesquisa" 
               @bind:event="oninput" />
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 80px;">ID</th>
                            <th>Produto</th>
                            <th style="width: 120px;">Tipo</th>
                            <th style="width: 100px;" class="text-end">Quantidade</th>
                            <th style="width: 120px;" class="text-end">Preço Custo</th>
                            <th style="width: 180px;">Data</th>
                            <th>Observação</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var mov in MovimentacoesFiltradas)
                        {
                            <tr>
                                <td class="align-middle">
                                    <span class="badge bg-secondary">#@mov.Id</span>
                                </td>
                                <td class="align-middle">
                                    <strong>@GetProdutoNome(mov.ProdutoId)</strong>
                                </td>
                                <td class="align-middle">
                                    @if (mov.Tipo == TipoMovimentacao.Compra)
                                    {
                                        <span class="badge bg-success">
                                            <i class="bi bi-arrow-down-circle"></i> Entrada
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-danger">
                                            <i class="bi bi-arrow-up-circle"></i> Saída
                                        </span>
                                    }
                                </td>
                                <td class="align-middle text-end">
                                    <strong>@mov.Quantidade</strong>
                                </td>
                                <td class="align-middle text-end">
                                    @if (mov.PrecoCusto.HasValue && mov.PrecoCusto.Value > 0)
                                    {
                                        <span class="text-muted">R$ @mov.PrecoCusto.Value.ToString("F2")</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                                <td class="align-middle">
                                    <small class="text-muted">
                                        @mov.DataMovimentacao.ToString("dd/MM/yyyy HH:mm")
                                    </small>
                                </td>
                                <td class="align-middle">
                                    <small class="text-muted">
                                        @(string.IsNullOrWhiteSpace(mov.Observacao) ? "-" : mov.Observacao)
                                    </small>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <div class="alert alert-secondary d-flex justify-content-between align-items-center">
            <span>
                <strong>Total de movimentações:</strong> @MovimentacoesFiltradas.Count()
            </span>
            <span>
                <span class="badge bg-success me-2">
                    Entradas: @MovimentacoesFiltradas.Count(m => m.Tipo == TipoMovimentacao.Compra)
                </span>
                <span class="badge bg-danger">
                    Saídas: @MovimentacoesFiltradas.Count(m => m.Tipo == TipoMovimentacao.Venda)
                </span>
            </span>
        </div>
    </div>
}

@code {
    private List<MovimentacaoEstoque> movimentacoes = new();
    private Dictionary<int, Produto> produtosCache = new();
    private string termoPesquisa = string.Empty;
    private bool isLoading = true;

    private IEnumerable<MovimentacaoEstoque> MovimentacoesFiltradas
    {
        get
        {
            if (string.IsNullOrWhiteSpace(termoPesquisa))
                return movimentacoes.OrderByDescending(m => m.DataMovimentacao);

            return movimentacoes
                .Where(m => 
                {
                    var produto = GetProdutoFromCache(m.ProdutoId);
                    return produto != null && 
                           (produto.Nome?.Contains(termoPesquisa, StringComparison.OrdinalIgnoreCase) ?? false);
                })
                .OrderByDescending(m => m.DataMovimentacao);
        }
    }

    private Produto? GetProdutoFromCache(int produtoId)
    {
        if (produtosCache.TryGetValue(produtoId, out var produto))
            return produto;
        return null;
    }

    private string GetProdutoNome(int produtoId)
    {
        var produto = GetProdutoFromCache(produtoId);
        return produto?.Nome ?? "Produto não identificado";
    }

    protected override async Task OnInitializedAsync()
    {
        var email = await JS.InvokeAsync<string>("sessionStorage.getItem", "Email");
        if (string.IsNullOrEmpty(email))
        {
            Navigation.NavigateTo("login");
            return;
        }

        await CarregarMovimentacoes();
    }

    private async Task CarregarMovimentacoes()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // Carregar movimentações
            var (resultado, erro) = await _apiService.GetMovimentacoesAsync();
            
            if (!string.IsNullOrEmpty(erro))
            {
                await JS.InvokeVoidAsync("alert", $"Erro ao carregar movimentações: {erro}");
                movimentacoes = new List<MovimentacaoEstoque>();
            }
            else
            {
                movimentacoes = resultado ?? new List<MovimentacaoEstoque>();
                
                // Carregar todos os produtos de uma vez
                await CarregarProdutos();
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Erro inesperado: {ex.Message}");
            movimentacoes = new List<MovimentacaoEstoque>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task CarregarProdutos()
    {
        try
        {
            // Buscar todos os produtos de uma vez
            var (produtos, erro) = await _apiService.GetTodosProdutos();
            
            if (produtos != null && !string.IsNullOrEmpty(erro) == false)
            {
                // Criar cache de produtos por ID
                produtosCache = produtos.ToDictionary(p => p.Id, p => p);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao carregar produtos: {ex.Message}");
        }
    }
}
