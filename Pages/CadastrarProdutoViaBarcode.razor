@page "/cadastrar-produto"
@inject ApiService _apiService
@inject IJSRuntime JS

<PageTitle>Cadastrar Produto</PageTitle>

<div class="card p-3">
    <h4>Cadastrar Produto via Código de Barras</h4>

    <div class="mb-3">
        <label class="form-label">Código de Barras</label>
        <div class="d-flex gap-2">
            <input class="form-control" @bind="barcode" />
            <button class="btn btn-outline-primary" @onclick="ConsultarBarcode">Buscar</button>
            <button class="btn btn-outline-secondary" @onclick="AbrirScanner">Usar Câmera</button>
        </div>
    </div>

    @if (produtoEncontrado != null)
    {
        <div class="mb-3">
            <label class="form-label">Nome</label>
            <input class="form-control" @bind="produtoEncontrado.Nome" />
        </div>
        <div class="row">
            <div class="col-md-8">
                <div class="mb-3">
                    <label class="form-label">Preço</label>
                    <InputNumber @bind-Value="produtoEncontrado.Preco" class="form-control" step="0.01" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Categoria</label>
                    <InputSelect class="form-select" @bind-Value="produtoEncontrado.CategoriaId">
                        <option value="0">Selecione...</option>
                        @foreach (var c in categorias)
                        {
                            <option value="@c.Id">@c.Nome</option>
                        }
                    </InputSelect>
                </div>

                <div class="mb-3">
                    <label class="form-label">Descrição / Detalhe</label>
                    <textarea class="form-control" rows="4" @bind="produtoEncontrado.Detalhe"></textarea>
                </div>
            </div>

            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label">Imagem (URL)</label>
                    <input class="form-control mb-2" @bind="produtoEncontrado.UrlImagem" />
                    @if (!string.IsNullOrWhiteSpace(produtoEncontrado.UrlImagem))
                    {
                        <img src="@produtoEncontrado.UrlImagem" style="max-width:100%; max-height:160px; object-fit:cover;" />
                    }
                </div>

                @if (imagensDisponiveis != null && imagensDisponiveis.Any())
                {
                    <div class="mb-2">
                        <label class="form-label">Imagens encontradas</label>
                        <div class="d-flex flex-wrap gap-2">
                            @foreach (var img in imagensDisponiveis)
                            {
                                <img src="@img" @onclick="() => SelectImage(img)" style="width:64px; height:64px; object-fit:cover; cursor:pointer; border:1px solid #ddd;" />
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <div>
            <button class="btn btn-success" @onclick="SalvarProduto">Salvar Produto</button>
        </div>
    }

    @if (!string.IsNullOrEmpty(mensagem))
    {
        <div class="alert alert-info mt-3">@mensagem</div>
    }

</div>

@code {
    private string barcode = string.Empty;
    private Produto? produtoEncontrado;
    private string mensagem = string.Empty;
    private DotNetObjectReference<CadastrarProdutoViaBarcode>? dotNetRef;

    private async Task ConsultarBarcode()
    {
        if (string.IsNullOrWhiteSpace(barcode)) return;

        try
        {
            // call BarcodeLookup API via backend proxy to avoid exposing API key in client
            var dto = new { Barcode = barcode };
            var json = System.Text.Json.JsonSerializer.Serialize(dto);
            var content = new System.Net.Http.StringContent(json, System.Text.Encoding.UTF8, "application/json");

            // call backend proxy (Products controller) which normalizes BarcodeLookup/Cosmos/etc
            var response = await _apiService.PostRequest("api/Produtos/barcodelookup/consulta", content);
            if (!response.IsSuccessStatusCode)
            {
                mensagem = "Falha ao consultar serviço externo.";
                return;
            }

            var resp = await response.Content.ReadAsStringAsync();
            var result = System.Text.Json.JsonSerializer.Deserialize<BarcodeLookupResult>(resp, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            if (result != null)
            {
                produtoEncontrado = new Produto
                {
                    Nome = result.Title ?? result.ProductName ?? string.Empty,
                    Barcode = barcode,
                    UrlImagem = result.Images?.FirstOrDefault(),
                    Preco = result.Offers?.FirstOrDefault()?.Price ?? 0m,
                    Detalhe = result.Description,
                    Disponivel = true
                };

                // keep a local copy of available images for user selection
                imagensDisponiveis = result.Images ?? new List<string>();

                mensagem = "Produto preenchido a partir do banco de dados externo. Revise e salve.";
            }
            else
            {
                mensagem = "Produto não encontrado na base externa.";
            }
        }
        catch (Exception ex)
        {
            mensagem = "Erro: " + ex.Message;
        }
    }

    private List<string> imagensDisponiveis = new();

    private async Task SalvarProduto()
    {
        if (produtoEncontrado == null) return;

        var apiResp = await _apiService.AdicionarProdutoAsync(produtoEncontrado);
        if (apiResp.Data)
        {
            mensagem = "Produto salvo com sucesso.";
            produtoEncontrado = null;
            barcode = string.Empty;
        }
        else
        {
            mensagem = "Falha ao salvar: " + apiResp.ErrorMessage;
        }
    }

    private async Task AbrirScanner()
    {
        dotNetRef ??= DotNetObjectReference.Create(this);
        await JS.InvokeVoidAsync("barcodeScanner.start", dotNetRef, "barcode-scanner-container");
    }

    [JSInvokable]
    public async Task OnBarcodeScanned(string code)
    {
        barcode = code;
        await ConsultarBarcode();
        StateHasChanged();
    }

    // DTOs for BarcodeLookup minimal parsing
    private class BarcodeLookupResult
    {
        public string? Title { get; set; }
        public string? ProductName { get; set; }
        public string? Description { get; set; }
        public List<string>? Images { get; set; }
        public List<Offer>? Offers { get; set; }
    }

    private class Offer { public decimal? Price { get; set; } }

    private List<Categoria> categorias = new();

    protected override async Task OnInitializedAsync()
    {
        var (cats, err) = await _apiService.GetCategorias();
        categorias = cats ?? new List<Categoria>();
    }

    private void SelectImage(string img)
    {
        if (produtoEncontrado == null) return;
        produtoEncontrado.UrlImagem = img;
    }
}
