@page "/despesas"
@inject ApiService _apiService
@inject AuthService AuthService
@inject IJSRuntime JS
@inject NavigationManager Navigation

<h4 class="text-bg-primary text-center">
    Despesas
</h4>

@if (!exibirFormulario)
{
    <div class="text-center my-3">
        <button class="btn btn-success btn-lg rounded-circle" style="width:56px;height:56px;font-size:24px;" @onclick="MostrarFormularioAsync" aria-label="Adicionar nova despesa">+</button>
    </div>
}

@if (exibirFormulario)
{
    <EditForm Model="novaDespesa" OnValidSubmit="SalvarDespesa">
        <DataAnnotationsValidator/>
        @if (!string.IsNullOrEmpty(formError))
        {
            <div class="alert alert-danger">@formError</div>
        }
        <div class="form-group">
            <InputDate id="data" class="form-control" @bind-Value="novaDespesa.Data" placeholder="Data" />
            <ValidationMessage For="@(() => novaDespesa.Data)" />
        </div>
        <div class="form-group">
            <InputText id="descricao" class="form-control" @bind-Value="novaDespesa.Descricao" placeholder="Descrição" />
            @if (submitted && string.IsNullOrWhiteSpace(novaDespesa.Descricao))
            {
                <div class="text-danger small">Descrição é obrigatório.</div>
            }
        </div>
        <div class="form-group">
            <div class="mb-1">Categoria</div>
            @foreach (var cat in categorias)
            {
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="categoria" id="cat-@cat" value="@cat" @onclick="() => novaDespesa.Categoria = cat" checked="@(novaDespesa.Categoria == cat)" />
                    <label class="form-check-label" for="cat-@cat">@cat</label>
                </div>
            }
            <ValidationMessage For="@(() => novaDespesa.Categoria)" />
        </div>
        <div class="form-group">
            <div class="mb-1">Forma de pagamento</div>
            @foreach (var fm in formasPagamento)
            {
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="formaPagamento" id="fp-@fm" value="@fm" @onclick="() => novaDespesa.FormaPagamento = fm" checked="@(novaDespesa.FormaPagamento == fm)" />
                    <label class="form-check-label" for="fp-@fm">@fm</label>
                </div>
            }
            <ValidationMessage For="@(() => novaDespesa.FormaPagamento)" />
            @if (submitted && string.IsNullOrWhiteSpace(novaDespesa.FormaPagamento))
            {
                <div class="text-danger small">Forma de pagamento é obrigatório.</div>
            }
        </div>
        <div class="form-group">
            <input id="valor" type="number" step="0.01" inputmode="decimal" class="form-control" placeholder="Valor"
                   value="@(novaDespesa.Valor == 0m ? string.Empty : novaDespesa.Valor.ToString(System.Globalization.CultureInfo.InvariantCulture))"
                   @oninput="@(e => OnValorInput(e))" />
            <ValidationMessage For="@(() => novaDespesa.Valor)" />
            @if (submitted && novaDespesa.Valor <= 0m)
            {
                <div class="text-danger small">Valor deve ser maior que zero.</div>
            }
        </div>
        <div class="form-group">
            <input id="parcelas" type="number" class="form-control" placeholder="Parcelas"
                   value="@(novaDespesa.Parcelas == 0 ? string.Empty : novaDespesa.Parcelas.ToString())"
                   @oninput="@(e => OnParcelasInput(e))" />
            <ValidationMessage For="@(() => novaDespesa.Parcelas)" />
        </div>
        <div class="form-group">
            <InputText id="observacao" class="form-control" @bind-Value="novaDespesa.Observacao" placeholder="Observação" />
            <ValidationMessage For="@(() => novaDespesa.Observacao)" />
        </div>
        <button type="submit" class="btn btn-success" disabled="@(!IsFormValid())">
            Salvar
        </button>
        <button type="button" class="btn btn-secondary" @onclick="Cancelar">Cancelar</button>
    </EditForm>

    
}
@if (filteredDespesas is not null && filteredDespesas.Any())
{
    <h4 class="mt-5">Despesas</h4>

    <table class="table table-bordered mt-3">
        <thead>
            <tr>
                <th>Data</th>
                <th>Descrição</th>
                <th>Categoria</th>
                <th>Forma de pagamento</th>
                <th>Valor</th>
                <th>Parcela</th>
                <th>Observação</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var despesa in filteredDespesas.OrderByDescending(c => c.Data))
            {
                <tr>
        <td>
            @{
                // Show human-friendly date
                var display = DateTime.SpecifyKind(despesa.Data, DateTimeKind.Unspecified);
            }
            <div>@display.ToString("g")</div>
        </td>
                    <td>@despesa.Descricao</td>
                    <td>@despesa.Categoria</td>
                    <td>@despesa.FormaPagamento</td>
                    <td>R$@despesa.Valor.ToString("C2")</td>
                    <td>@despesa.Parcelas.ToString()</td>
                    <td>@despesa.Observacao</td>
                </tr>
            }
        </tbody>
    </table>
}

@* html desenohs *@
@code {
    //c# como funciona
    private bool estaMarcado = false;
    private Despesas novaDespesa = new Despesas();
    private bool exibirFormulario = false;
    private List<Despesas> filteredDespesas = new();
    private List<string> categorias = new() { "GastosFixos", "Funcionario", "Mercadoria", "Infraestrutura", "Caixa" };
    private List<string> formasPagamento = new() { "Dinheiro", "Credito", "Debito", "Pix" };
    private ElementReference descricaoRef;
    private bool focusDescricaoRequested = false;
    private bool submitted = false;
    private string formError = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var nome = await JS.InvokeAsync<string>("sessionStorage.getItem", "Email");

        if (string.IsNullOrEmpty(nome))
        {
            Navigation.NavigateTo("login");
        }

        var (todasDespesas, errorMessage) = await _apiService.GetDespesasAsync();
        // Do not force-kind or convert dates here. Display the server value as-is
        // to avoid double-conversion issues. If server provides UTC, it should
        // set Kind appropriately or the API should return an ISO string with Z.
        filteredDespesas = todasDespesas ?? new List<Despesas>();
    }

    private async Task MostrarFormularioAsync()
    {
        novaDespesa = new Despesas(); //criando um objeto
        exibirFormulario = true;
        focusDescricaoRequested = true;
        // allow render to complete, focus will be performed in OnAfterRenderAsync
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (focusDescricaoRequested && exibirFormulario)
        {
            focusDescricaoRequested = false;
            try
            {
                await JS.InvokeVoidAsync("eval", "document.getElementById('descricao')?.focus()");
            }
            catch { }
            StateHasChanged();
        }
    }

    private async Task SalvarDespesa()
    {
        submitted = true;
        formError = string.Empty;
        if (!IsFormValid())
        {
            formError = "Preencha os campos obrigatórios.";
            return;
        }
        int totalParcelas = Math.Max(novaDespesa.Parcelas, 1); // Garante pelo menos 1
        // combine selected date with current time so we send a full timestamp (UTC)
        var selectedDate = novaDespesa.Data.Date;
        var nowUtc = DateTime.UtcNow.TimeOfDay;

        for (int i = 0; i < totalParcelas; i++)
        {
            var nowLocal = DateTime.Now;
            var copia = new Despesas
            {
                // use local current time so server receives valid timestamp
                Data = nowLocal,
                Descricao = novaDespesa.Descricao + (totalParcelas > 1 ? $" (Parcela {i + 1}/{totalParcelas})" : ""),
                Categoria = novaDespesa.Categoria,
                FormaPagamento = novaDespesa.FormaPagamento,
                Valor = novaDespesa.Valor / totalParcelas, // ou o valor total se não quiser dividir
                Parcelas = totalParcelas,
                Observacao = novaDespesa.Observacao
            };

            await _apiService.AdicionarDespesaAsync(copia);
        }

        var (todasDespesas, errorMessage) = await _apiService.GetDespesasAsync();
        filteredDespesas = todasDespesas;
        exibirFormulario = false;
    }

    private void Cancelar()
    {
        exibirFormulario = false;
    }

    private void OnValorInput(ChangeEventArgs e)
    {
        var s = e?.Value?.ToString() ?? string.Empty;
        if (decimal.TryParse(s, out var v)) novaDespesa.Valor = v;
    }

    private void OnParcelasInput(ChangeEventArgs e)
    {
        var s = e?.Value?.ToString() ?? string.Empty;
        if (int.TryParse(s, out var v)) novaDespesa.Parcelas = v;
    }

    private bool IsFormValid()
    {
        if (string.IsNullOrWhiteSpace(novaDespesa.Descricao)) return false;
        if (string.IsNullOrWhiteSpace(novaDespesa.Categoria)) return false;
        if (string.IsNullOrWhiteSpace(novaDespesa.FormaPagamento)) return false;
        if (novaDespesa.Valor <= 0m) return false;
        return true;
    }
}
