@page "/estoque"
@inject ApiService _apiService
@inject AuthService AuthService
@inject IJSRuntime JS
@using System.Globalization
@inject NavigationManager Navigation

<div class="d-flex align-items-center justify-content-between mb-2">
    <h3 class="mb-0">Estoque</h3>
    <button class="btn btn-sm btn-outline-primary ms-2" title="Abrir leitor (câmera)" @onclick="OpenScanner" aria-label="Abrir leitor de códigos">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
            <path d="M10.5 2a.5.5 0 0 1 .5.5V3h1.5A1.5 1.5 0 0 1 14 4.5v7A1.5 1.5 0 0 1 12.5 13H3.5A1.5 1.5 0 0 1 2 11.5v-7A1.5 1.5 0 0 1 3.5 3H5v-.5a.5.5 0 0 1 .5-.5h5zM8 5a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>
            <path d="M8 6.5a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3z"/>
        </svg>
    </button>
</div>

<input @bind="_termoPesquisa"
       @bind:event="oninput"
       placeholder="Pesquisar por nome ou código de barras"
       class="form-control mb-3" />

@* Brand quick-filter grouped by initial letter (like CaixaPage) *@
@if (marcas != null && marcas.Any())
{
    <div class="mb-3">
        <label class="form-label fw-bold">Marcas</label>
        <div class="brand-list" style="font-size:0.85rem;">
            @if (string.IsNullOrEmpty(selectedMarca))
            {
                <div class="d-flex flex-row flex-wrap" style="gap:1rem; align-items:flex-start;">
                    @foreach (var group in marcas.GroupBy(m => char.ToUpperInvariant((!string.IsNullOrWhiteSpace(m) ? m.Trim()[0] : '?'))).OrderBy(g => g.Key))
                    {
                        <div style="min-width:90px;">
                            <div class="fw-bold mb-1">@group.Key</div>
                            @foreach (var m in group.OrderBy(x => x))
                            {
                                <button class="brand-item text-start p-0 mb-1" style="background:none; border:none; display:block; width:100%; padding:0.12rem 0;" @onclick="() => OnSelectMarca(m)">@m</button>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <div>
                    <span class="fw-bold">@selectedMarca</span>
                    <button class="btn btn-sm btn-outline-secondary ms-2" @onclick="() => OnSelectMarca(null)">Limpar</button>
                </div>
            }
        </div>
    </div>
}

@if (estoques is null)
{
    <p>Carregando estoque...</p>
}

    @if (showInventoryModal && inventoryEstoque != null)
    {
        <div class="modal-backdrop fade show"></div>
        <div class="modal d-block">
            <div class="modal-dialog modal-sm mt-5">
                <div class="modal-content p-3">
                    <h5 class="fw-bold">Ajustar Estoque - @inventoryEstoque.Produto.Nome</h5>

                    <div class="mb-2">
                        <label class="form-label small">Quantidade atual</label>
                        <div><strong>@inventoryEstoque.Quantidade</strong></div>
                    </div>

                    <div class="mb-2">
                        <label class="form-label small">Quantidade desejada</label>
                        <input class="form-control" @bind="inventoryDesiredQuantity" />
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button class="btn btn-secondary" @onclick="CancelInventoryModal">Cancelar</button>
                        <button class="btn btn-primary" @onclick="ApplyInventoryAdjustment">Aplicar</button>
                    </div>
                </div>
            </div>
        </div>
    }
 
else if (estoques.Count == 0)
{
    <p>Nenhum produto encontrado no estoque.</p>
}
 
else
{
    @if (produtosAbaixoMinimo.Any())
    {
        <h4 class="mt-5 text-danger">Produtos abaixo da quantidade mínima</h4>
        <table class="table table-bordered table-striped">
            <thead class="table-danger">
                <tr>
                    <th>Nome</th>
                    <th>Quantidade Atual</th>
                    <th>Quantidade Mínima</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var e in produtosAbaixoMinimo)
                {
                    <tr>
                        <td>@e.Produto.Nome</td>
                        <td>@e.Quantidade</td>
                        <td>@e.QuantidadeMinima</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
        @foreach (var e in estoquesFiltrados)
        {
            <div class="col">
                <div class="card h-100 bg-dark text-white" style="">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">@e.Produto?.Nome</h5>
                        <div class="mb-2 small text-light">Quantidade: <strong>@e.Quantidade</strong></div>

                        <div class="mb-2 d-flex align-items-center gap-2">
                            <div>
                                <label class="form-label small">Quantidade Mínima</label>
                                <input type="number" class="form-control form-control-sm" style="width:120px" value="@e.QuantidadeMinima" @oninput="@(async (ChangeEventArgs ev) => { if (int.TryParse(ev?.Value?.ToString(), out var v)) { e.QuantidadeMinima = v; } else { e.QuantidadeMinima = null; } })" @onchange="() => AtualizarEstoque(e)" />
                            </div>
                            <div class="ms-auto">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-light" @onclick:stopPropagation="true" @onclick="() => OpenEditPricesModal(e)">Editar preços</button>
                                    <button class="btn btn-sm btn-outline-primary" @onclick:stopPropagation="true" @onclick="() => OpenInventario(e.ProdutoId)">Inventário</button>
                                </div>
                            </div>
                        </div>

                        <div class="row g-2 mb-2 align-items-center">
                            <div class="col-auto">
                                <label class="form-label small">Custo (R$)</label>
                                <input type="number" step="0.01" class="form-control form-control-sm" style="width:120px" value="@(e.PrecoCusto?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "")" @oninput="@(ev => { if (decimal.TryParse(ev?.Value?.ToString(), System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var v)) { e.PrecoCusto = v; e.PrecoVenda = CalcularPrecoVenda(e); } else { e.PrecoCusto = null; } })" />
                            </div>

                            <div class="col-auto">
                                <label class="form-label small">Margem (%)</label>
                                <input type="number" step="1" class="form-control form-control-sm" style="width:120px" value="@(e.Margem?.ToString() ?? "")" @oninput="@(ev => OnMargemInput(e, ev))" @onchange="() => AtualizarEstoque(e)" />
                            </div>

                            <div class="col d-flex">
                                <div class="flex-grow-1 me-2">
                                    <label class="form-label small">Venda (R$)</label>
                                    <input type="number" step="0.01" class="form-control form-control-sm text-end" value="@(e.PrecoVenda?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? (CalcularPrecoVenda(e)?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? ""))" @oninput="@(ev => OnPrecoVendaInput(e, ev))" @onchange="() => AtualizarEstoque(e)" />
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        }
    </div>

    @* Edit prices modal *@
    @if (showEditPriceModal && modalProduct != null)
    {
        <div class="modal-backdrop fade show"></div>
        <div class="modal d-block">
            <div class="modal-dialog modal-sm mt-5">
                <div class="modal-content p-3">
                    <h5 class="fw-bold">Editar Preços - @modalProduct.Nome</h5>

                    <div class="mb-2">
                        <label class="form-label small">Preço Quente (R$)</label>
                        <InputNumber class="form-control" step="0.01" @bind-Value="modalProduct.PrecoQuente" />
                    </div>

                    <div class="mb-2">
                        <label class="form-label small">Preço Gelada (R$)</label>
                        <InputNumber class="form-control" step="0.01" @bind-Value="modalProduct.PrecoGelada" />
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <button class="btn btn-secondary" @onclick="CloseEditPricesModal">Cancelar</button>
                        <button class="btn btn-primary" @onclick="SalvarPrecosModal">Salvar</button>
                    </div>
                </div>
            </div>
        </div>
    }

}


@code {
    private List<Estoque> estoques = new();
    private List<string> marcas = new();
    private string? selectedMarca = null;
    private string _termoPesquisa = "";
    private bool isLoading = true;
    private bool isProcessing = false;
    private System.Globalization.CultureInfo uiCulture = System.Globalization.CultureInfo.CurrentCulture;
    private bool showEditPriceModal = false;
    private Produto? modalProduct = null;
    private DotNetObjectReference<object>? _dotNetRefEstoque;
    private bool showInventoryModal = false;
    private Estoque? inventoryEstoque = null;
    private string inventoryDesiredQuantity = string.Empty;

    [JSInvokable]
    public async Task OnBarcodeScanned(string code)
    {
        try
        {
            _termoPesquisa = code;
            // trigger UI update and filtering
            FiltrarEstoques(code);
            StateHasChanged();
        }
        catch { }
    }

    private async Task OpenScanner()
    {
        _dotNetRefEstoque ??= DotNetObjectReference.Create((object)this);
        await JS.InvokeVoidAsync("barcodeScanner.start", _dotNetRefEstoque, "barcode-scanner-container");
    }

    protected override async Task OnInitializedAsync()
    {
        var nome = await JS.InvokeAsync<string>("sessionStorage.getItem", "Email");

        if (string.IsNullOrEmpty(nome))
        {
            Navigation.NavigateTo("login");
        }
        var (response, errorMessage) = await _apiService.GetEstoque();
        estoques = response ?? new List<Estoque>();
        // populate brand list from loaded products in estoque
        var prods = estoques.Where(e => e.Produto != null).Select(e => e.Produto!).ToList();
        PopulateMarcasFromProdutos(prods);
    }

    private void PopulateMarcasFromProdutos(List<Produto> produtos)
    {
        if (produtos == null) { marcas = new List<string>(); return; }
        var known = new[] { "Brahma", "Skol", "Antarctica", "Original", "Xereta", "Coca Cola", "Coca-Cola", "Fanta", "Heineken", "Budweiser", "Red Bull", "Gaterade", "Petra", "Pepsi",
            "Sukita", "Corona", "Tubaina", "Lacta", "Eisenbahn", "Baianinha", "Chapinha", "Askov", "Stella", "Monster", "Amstel", "Red label", "Del valle", "Sprite", "Fanta", "Imperio", "Baly",
            "Crystal", "Gorillaz" };
        var found = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        foreach (var p in produtos)
        {
            var txt = (p.Nome ?? string.Empty) + " " + (p.Detalhe ?? string.Empty);
            foreach (var k in known)
            {
                if (!found.Contains(k) && txt.IndexOf(k, StringComparison.OrdinalIgnoreCase) >= 0)
                    found.Add(k);
            }
        }
        if (found.Remove("Coca Cola") | found.Remove("Coca-Cola"))
        {
            found.Add("Coca-cola");
        }
        marcas = found.OrderBy(m => m).ToList();
    }

    private void OnSelectMarca(string? marca)
    {
        selectedMarca = marca;
        if (string.IsNullOrEmpty(marca))
        {
            // clear filter
            _termoPesquisa = string.Empty;
        }
        else
        {
            // filter estoques to selected brand by product name/detalhe
            _termoPesquisa = string.Empty;
        }
        StateHasChanged();
    }

    private List<Estoque> produtosAbaixoMinimo => estoques
    .Where(e => (e.QuantidadeMinima ?? 0) > 0 && e.Quantidade < (e.QuantidadeMinima ?? 0))
    .ToList();


    private List<Estoque> estoquesFiltrados
    {
        get
        {
            var list = estoques ?? new List<Estoque>();
            // apply brand filter first if set
            if (!string.IsNullOrEmpty(selectedMarca))
            {
                list = list.Where(e => e.Produto != null && ((e.Produto.Nome ?? string.Empty) + " " + (e.Produto.Detalhe ?? string.Empty)).IndexOf(selectedMarca ?? string.Empty, StringComparison.OrdinalIgnoreCase) >= 0).ToList();
            }

            if (string.IsNullOrWhiteSpace(_termoPesquisa))
                return list.ToList();

            return list.Where(e =>
                e.Produto != null &&
                (
                    (e.Produto.Nome?.Contains(_termoPesquisa, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (e.Produto.Barcode?.Contains(_termoPesquisa, StringComparison.OrdinalIgnoreCase) ?? false)
                )
            ).ToList();
        }
    }

    private void FiltrarEstoques(string term)
    {
        _termoPesquisa = term ?? string.Empty;
        StateHasChanged();
    }
    

    // Cálculo local, para refletir imediatamente na interface
    private decimal? CalcularPrecoVenda(Estoque e)
    {
        if (e.PrecoCusto.HasValue && e.Margem.HasValue)
            return e.PrecoCusto.Value + (e.PrecoCusto.Value * e.Margem.Value / 100);
        return null;
    }

    private void OnMargemInput(Estoque e, ChangeEventArgs ev)
    {
        var s = ev?.Value?.ToString();
        if (int.TryParse(s, out var m))
        {
            e.Margem = m;
            e.PrecoVenda = CalcularPrecoVenda(e);
        }
        else
        {
            e.Margem = null;
            e.PrecoVenda = null;
        }
    }

    private void OnPrecoVendaInput(Estoque e, ChangeEventArgs ev)
    {
        var s = ev?.Value?.ToString();
        if (decimal.TryParse(s, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var pv))
        {
            e.PrecoVenda = pv;
            // recalc margem if custo available
            if (e.PrecoCusto.HasValue && e.PrecoCusto.Value > 0)
            {
                var margem = (int)Math.Round((pv - e.PrecoCusto.Value) / e.PrecoCusto.Value * 100);
                e.Margem = margem;
            }
        }
        else
        {
            e.PrecoVenda = null;
        }
    }

    // Você pode salvar no banco chamando sua API (opcional)
    private async Task AtualizarEstoque(Estoque estoque)
    {
        estoque.PrecoVenda = CalcularPrecoVenda(estoque);
        await _apiService.AtualizarEstoque(estoque); // Crie esse método na API se quiser persistir
    }

    private void NavigateToProduto(int produtoId)
    {
        Navigation.NavigateTo($"/produtos?id={produtoId}");
    }

    private void OpenInventario(int produtoId)
    {
        // open inline inventory modal to set desired real quantity
        inventoryEstoque = estoques.FirstOrDefault(e => e.ProdutoId == produtoId);
        if (inventoryEstoque != null)
        {
            inventoryDesiredQuantity = inventoryEstoque.Quantidade.ToString();
            showInventoryModal = true;
        }
    }

    private void CancelInventoryModal()
    {
        showInventoryModal = false;
        inventoryEstoque = null;
        inventoryDesiredQuantity = string.Empty;
    }

    private async Task ApplyInventoryAdjustment()
    {
        if (inventoryEstoque == null)
        {
            showInventoryModal = false;
            return;
        }

        if (!int.TryParse(inventoryDesiredQuantity, out var desired))
        {
            await JS.InvokeVoidAsync("alert", "Informe uma quantidade válida.");
            return;
        }

        var current = inventoryEstoque.Quantidade;
        var diff = desired - current;
        if (diff == 0)
        {
            // nothing to do
            CancelInventoryModal();
            return;
        }

        var movimentacao = new MovimentacaoEstoque()
        {
            ProdutoId = inventoryEstoque.ProdutoId,
            Quantidade = Math.Abs(diff),
            Tipo = diff > 0 ? TipoMovimentacao.Compra : TipoMovimentacao.Venda,
            DataMovimentacao = DateTime.Now,
            Observacao = "Ajuste via Inventário"
        };

        isProcessing = true;
        var resp = await _apiService.MovimentarEstoqueAsync(movimentacao);
        isProcessing = false;

        if (!resp.Data)
        {
            await JS.InvokeVoidAsync("alert", "Falha ao registrar movimentação: " + (resp.ErrorMessage ?? ""));
            return;
        }

        // refresh single estoque from API to get authoritative quantity
        try
        {
            var (fresh, err) = await _apiService.GetProdutoEstoque(inventoryEstoque.ProdutoId);
            if (fresh != null)
            {
                // update local list
                var idx = estoques.FindIndex(x => x.ProdutoId == fresh.ProdutoId);
                if (idx >= 0)
                {
                    estoques[idx] = fresh;
                }
                else
                {
                    // if not found, add
                    estoques.Add(fresh);
                }
            }
        }
        catch { }

        showInventoryModal = false;
        inventoryEstoque = null;
        inventoryDesiredQuantity = string.Empty;
        StateHasChanged();
    }

    private void OpenEditPricesModal(Estoque e)
    {
        // clone product to modal instance to avoid immediate changes
        // open modal with blank values so user doesn't need to delete zeros
        modalProduct = new Produto
        {
            Id = e.Produto.Id,
            Nome = e.Produto.Nome,
            PrecoQuente = 0m,
            PrecoGelada = 0m,
            CategoriaId = e.Produto.CategoriaId,
            Barcode = e.Produto.Barcode,
            UrlImagem = e.Produto.UrlImagem,
        };
        showEditPriceModal = true;
    }

    private void CloseEditPricesModal()
    {
        showEditPriceModal = false;
        modalProduct = null;
    }

    private async Task SalvarPrecosModal()
    {
        if (modalProduct == null) return;
        var success = await _apiService.AtualizarProduto(modalProduct.Id, modalProduct);
        if (success)
        {
            // refresh local estoque list
            var (resp, err) = await _apiService.GetEstoque();
            estoques = resp ?? new List<Estoque>();
            showEditPriceModal = false;
            modalProduct = null;
            StateHasChanged();
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Falha ao salvar preços");
        }
    }
}
