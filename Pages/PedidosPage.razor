@page "/pedidos"
@inject ApiService _apiService
@inject AuthService AuthService
@inject NavigationManager Navigation
@using System.Globalization
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JS

<PageTitle>Pedidos</PageTitle>

<style>
    .pedido-card { height: auto; min-height: 140px; max-width: 360px; width: 100%; border-radius: .5rem; }
    .pedido-card .card-body { padding: .5rem; display: flex; flex-direction: column; justify-content: space-between; }
    .pedido-card .card-title { font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .pedido-card .text-white-50.small { font-size: 0.75rem; }
    .pedido-img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; }
    @@media (max-width: 575.98px) {
        .pedido-card { max-width: 100%; min-height: 120px; }
        .pedido-card .card-body { padding: .375rem; }
    }
</style>

<div class="d-flex align-items-center mb-3">
    <label class="me-2 fw-bold">Selecionar Data:</label>
    <InputDate @bind-Value="dataSelecionada" class="form-control w-auto me-2" />
    <button class="btn btn-primary" @onclick="BuscarPedidosPorData">Buscar</button>
</div>

<div class="mb-3 d-flex align-items-center gap-3">
    <label class="fw-bold">Filtrar status:</label>
    <div>
        <select class="form-select form-select-sm" style="min-width:180px;" @onchange="@(e => SetStatusFilter(e.Value?.ToString()))" value="@statusFilter">
            <option value="">Todos</option>
            <option value="Em entrega">Em entrega</option>
            <option value="Retirada">Retirada</option>
            <option value="A Prazo">A Prazo</option>
            <option value="Finalizado">Finalizado</option>
        </select>
    </div>
</div>

    <h3 class="mt-4">Total Vendido: <span class="text-success">R$ @totalVendido.ToString("F2")</span></h3>

@if (pedidosHoje == null || !pedidosHoje.Any())
{
    <p>Nenhum pedido na data selecionada.</p>
}


    @* Finalize payment selection modal *@
    @if (showFinalizeModal)
    {
        <div class="modal-backdrop fade show"></div>
        <div class="modal d-block">
            <div class="modal-dialog modal-sm mt-5">
                <div class="modal-content p-3">
                    <h5 class="fw-bold">Finalizar Pedido #@finalizePedidoId</h5>
                    <p>Escolha a forma de pagamento:</p>
                    <div>
                        <InputRadioGroup class="" @bind-Value="SelectedFormaPagamento">
                            <div class="form-check">
                                <InputRadio id="fpDinheiro" class="form-check-input" Value='@("Dinheiro")' />
                                <label class="form-check-label" for="fpDinheiro">Dinheiro</label>
                            </div>
                            <div class="form-check">
                                <InputRadio id="fpPix" class="form-check-input" Value='@("Pix")' />
                                <label class="form-check-label" for="fpPix">Pix</label>
                            </div>
                            <div class="form-check">
                                <InputRadio id="fpDebito" class="form-check-input" Value='@("Debito")' />
                                <label class="form-check-label" for="fpDebito">Debito</label>
                            </div>
                            <div class="form-check">
                                <InputRadio id="fpCredito" class="form-check-input" Value='@("Credito")' />
                                <label class="form-check-label" for="fpCredito">Credito</label>
                            </div>
                        </InputRadioGroup>
                    </div>
                    <div class="d-flex justify-content-end mt-3">
                        <button class="btn btn-secondary me-2" @onclick="() => CloseFinalizeModal(false)">Cancelar</button>
                        <button class="btn btn-primary" @onclick="ConfirmFinalize">Ok</button>
                    </div>
                </div>
            </div>
        </div>
    }

@* Pedido detail modal *@
@if (showPedidoModal && currentPedido != null)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block">
        <div class="modal-dialog modal-lg mt-4">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pedido #@currentPedido.Id</h5>
                    @if (isEditingPedido)
                    {
                        <button class="btn btn-success ms-2" @onclick="SalvarEdicoes">Salvar</button>
                    }
                    <button type="button" class="btn-close" @onclick="ClosePedidoModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h5 class="mb-2">Dados do Cliente</h5>
                            <dl class="row small">
                                <dt class="col-4">Cliente</dt>
                                <dd class="col-8">
                                    @if (editingField == "ClienteNome")
                                    {
                                        <input class="form-control form-control-sm" @bind="editClienteNome" @onfocus="CancelScheduledSave" @onblur="ScheduleSaveOnBlur" />
                                    }
                                    else
                                    {
                                        <span style="cursor:pointer; text-decoration:underline;" @onclick='() => StartEdit("ClienteNome")'>@(string.IsNullOrEmpty(currentPedido?.ClienteNome) ? "(clique para editar)" : currentPedido.ClienteNome)</span>
                                    }
                                </dd>

                            <dt class="col-4">Telefone</dt>
                            <dd class="col-8">
                                @if (editingField == "Telefone")
                                {
                                    <input class="form-control form-control-sm" @bind="editTelefone" @onfocus="CancelScheduledSave" @onblur="ScheduleSaveOnBlur" />
                                }
                                else
                                {
                                    <span style="cursor:pointer; text-decoration:underline;" @onclick='() => StartEdit("Telefone")'>@(string.IsNullOrEmpty(currentPedido?.Telefone) ? "(clique para editar)" : currentPedido.Telefone)</span>
                                }
                            </dd>

                                <dt class="col-4">Endereço</dt>
                                <dd class="col-8 text-truncate">
                                    @if (editingField == "Endereco")
                                    {
                                        <input class="form-control form-control-sm" @bind="editEndereco" @onfocus="CancelScheduledSave" @onblur="ScheduleSaveOnBlur" />
                                    }
                                    else
                                    {
                                        <span style="cursor:pointer; text-decoration:underline;" @onclick='() => StartEdit("Endereco")'>@(string.IsNullOrEmpty(currentPedido?.Endereco) ? "(clique para editar)" : currentPedido.Endereco)</span>
                                    }
                                </dd>

                                <dt class="col-4">Observações</dt>
                                <dd class="col-8">
                                    @if (editingField == "Observacoes")
                                    {
                                        <input class="form-control form-control-sm" @bind="editObservacoes" @onfocus="CancelScheduledSave" @onblur="ScheduleSaveOnBlur" />
                                    }
                                    else
                                    {
                                        <span style="cursor:pointer; text-decoration:underline;" @onclick='() => StartEdit("Observacoes")'>@(string.IsNullOrEmpty(currentPedido?.Observacoes) ? "(clique para editar)" : currentPedido.Observacoes)</span>
                                    }
                                </dd>
                            </dl>
                        </div>

                        <div class="col-md-6">
                            <h5 class="mb-2">Resumo do Pedido</h5>
                            <dl class="row small text-end">
                                <dt class="col-6">Vendedor</dt>
                                <dd class="col-6">@currentPedido.VendedorNome</dd>

                                <dt class="col-6">Data</dt>
                                <dd class="col-6">@currentPedido.DataPedido?.ToString("dd/MM/yyyy HH:mm")</dd>

                                <dt class="col-6">Total</dt>
                                <dd class="col-6">R$ @currentPedido.ValorTotal.ToString("F2")</dd>

                                <dt class="col-6">Forma(s)</dt>
                                <dd class="col-6">
                                    @if (isEditingPedido)
                                    {
                                        <select class="form-select form-select-sm" @bind="editFormaPagamento">
                                            <option value="">(Nenhuma)</option>
                                            <option>Dinheiro</option>
                                            <option>Pix</option>
                                            <option>Debito</option>
                                            <option>Credito</option>
                                            <option>A Prazo</option>
                                            <option>Ifood</option>
                                        </select>
                                        <div class="mt-1">
                                            <InputDate class="form-control form-control-sm" @bind-Value="editDataPagamentoPrazo" />
                                        </div>
                                    }
                                    else
                                    {
                                        @currentPedido.FormaPagamento
                                        @if(!string.IsNullOrEmpty(currentPedido.FormaPagamento2)) { <text> / @currentPedido.FormaPagamento2</text> }
                                    }
                                </dd>

                                <dt class="col-6">Valor Pago</dt>
                                <dd class="col-6">R$ @(currentPedido.ValorPago1?.ToString("F2") ?? "0.00")
                                    @if (currentPedido.ValorPago2.HasValue && currentPedido.ValorPago2.Value > 0)
                                    {
                                        <div>R$ @currentPedido.ValorPago2.Value.ToString("F2")</div>
                                    }
                                </dd>
                                <dt class="col-6">Forma(s) 2</dt>
                                <dd class="col-6">
                                    @if (isEditingPedido)
                                    {
                                        <select class="form-select form-select-sm" @bind="editFormaPagamento2">
                                            <option value="">(Nenhuma)</option>
                                            <option>Dinheiro</option>
                                            <option>Pix</option>
                                            <option>Debito</option>
                                            <option>Credito</option>
                                            <option>A Prazo</option>
                                            <option>Ifood</option>
                                        </select>
                                        <div class="mt-1">
                                            <InputDate class="form-control form-control-sm" @bind-Value="editDataPagamentoPrazo2" />
                                        </div>
                                    }
                                    else
                                    {
                                        @if(!string.IsNullOrEmpty(currentPedido.FormaPagamento2)) { <text>@currentPedido.FormaPagamento2</text> }
                                    }
                                </dd>
                            </dl>

                            @* prazo dates *@
                            @if (currentPedido.DataPagamentoPrazo.HasValue && string.Equals(currentPedido.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase))
                            {
                                <div class="mt-2 small text-muted">Pagamento (forma 1): @currentPedido.DataPagamentoPrazo.Value.ToString("dd/MM/yyyy")</div>
                            }
                            @if (currentPedido.DataPagamentoPrazo2.HasValue && string.Equals(currentPedido.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase))
                            {
                                <div class="mt-1 small text-muted">Pagamento (forma 2): @currentPedido.DataPagamentoPrazo2.Value.ToString("dd/MM/yyyy")</div>
                            }
                        </div>
                    </div>

                    <h6 class="mb-2">Itens</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Produto</th>
                                    <th class="text-end">Qtd</th>
                                    <th class="text-end">Unit.</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (detalhes.TryGetValue(currentPedido.Id, out var pdItems) && pdItems != null && pdItems.Any())
                                {
                                    @foreach (var it in pdItems)
                                    {
                                        <tr>
                                            <td style="width:64px;">
                                                @{
                                                    var img = !string.IsNullOrEmpty(it.ProdutoImagem) ? AppConfig.BaseUrl + it.ProdutoImagem : it.CaminhoImagem;
                                                }
                                                @if (!string.IsNullOrEmpty(img))
                                                {
                                                    <img src="@img" class="pedido-img" />
                                                }
                                            </td>
                                            <td class="align-middle">@it.ProdutoNome</td>
                                            <td class="text-end align-middle">
                                                @if (isEditingPedido)
                                                {
                                                    <input type="number" min="1" class="form-control form-control-sm text-end" value="@it.Quantidade" @oninput="@(e => OnEditItemQuantity(currentPedido.Id, it, e))" @onfocus="CancelScheduledSave" @onblur="ScheduleSaveOnBlur" />
                                                }
                                                else
                                                {
                                                    <span style="cursor:pointer;" @onclick="() => EnableItemEditing()">@it.Quantidade</span>
                                                }
                                            </td>
                                            <td class="text-end align-middle">
                                                @if (isEditingPedido)
                                                {
                                                    <input type="number" step="0.01" class="form-control form-control-sm text-end" value="@it.ProdutoPreco.ToString("F2")" @oninput="@(e => OnEditItemPreco(currentPedido.Id, it, e))" @onfocus="CancelScheduledSave" @onblur="ScheduleSaveOnBlur" />
                                                }
                                                else
                                                {
                                                    <span style="cursor:pointer;" @onclick="() => EnableItemEditing()">R$ @it.ProdutoPreco.ToString("F2")</span>
                                                }
                                            </td>
                                            <td class="text-end align-middle">R$ @it.SubTotal.ToString("F2")</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr><td colspan="5">Sem detalhes disponíveis.</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>

                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="ClosePedidoModal">Fechar</button>
                    @if (!string.Equals(currentPedido.Status, "Cancelado", StringComparison.OrdinalIgnoreCase))
                    {
                        <button class="btn btn-primary" @onclick="() => ImprimirPedido(currentPedido.Id)">Imprimir</button>
                        @* Removed the direct "Cancelar" (cancel order) button from the modal footer to avoid accidental cancellations
                           Use the card-level Cancelar action instead (requires deliberate click). *@
                    }
                </div>
            </div>
        </div>
    </div>
}
else
{
    @if (pedidosHoje.Count > 0)
    {
        <div class="alert alert-info">
            <strong>Resumo por Forma de Pagamento:</strong><br />
            Débito: <strong>R$ @totalDebito.ToString("F2")</strong> |
            Crédito: <strong>R$ @totalCredito.ToString("F2")</strong> |
            Pix: <strong>R$ @totalPix.ToString("F2")</strong> |
            Dinheiro: <strong>R$ @totalDinheiro.ToString("F2")</strong> |
            A prazo: <strong>R$ @totalAPrazo.ToString("F2")</strong>
        </div>
    }

    <div>
        @* Build groups in requested order and render separators *@
        @{
            var displayed = pedidosExibidos.Where(p => !(string.Equals(p.Status, "Cancelado", StringComparison.OrdinalIgnoreCase) && dataSelecionada.Date != DateTime.Today)).ToList();

            var emEntrega = displayed.Where(p => string.Equals(EffectiveStatus(p), "Em entrega", StringComparison.OrdinalIgnoreCase)).ToList();
            var retirada = displayed.Where(p => string.Equals(EffectiveStatus(p), "Retirada", StringComparison.OrdinalIgnoreCase)).ToList();
            var aPrazo = displayed.Where(p => string.Equals(EffectiveStatus(p), "A Prazo", StringComparison.OrdinalIgnoreCase)).ToList();
            var finalizado = displayed.Where(p => string.Equals(EffectiveStatus(p), "Finalizado", StringComparison.OrdinalIgnoreCase)).ToList();
            // any others (not in the four groups)
            var others = displayed.Except(emEntrega).Except(retirada).Except(aPrazo).Except(finalizado).ToList();
        }

        @if (emEntrega.Any())
        {
            <h5 class="mt-3">Em entrega</h5>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                @foreach (var comanda in emEntrega)
                {
                    <div class="col">
                        <div class="card pedido-card bg-dark text-white @GetBorderClass(comanda)" style="cursor:pointer;" @onclick="() => ShowPedidoModal(comanda.Id)">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="card-title mb-1">
                                            @{
                                                var displayName = (!string.IsNullOrWhiteSpace(comanda.ClienteNome))
                                                    ? comanda.ClienteNome
                                                    : (string.Equals(comanda.Status, "Finalizado", StringComparison.OrdinalIgnoreCase) ? "Avulso" : comanda.ClienteNome);

                                                var hasAPrazo = string.Equals(comanda.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase)
                                                               || string.Equals(comanda.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase);
                                                var statusText = (string.Equals(comanda.Status, "Finalizado", StringComparison.OrdinalIgnoreCase) && hasAPrazo)
                                                    ? "A prazo"
                                                    : (comanda.Status ?? "");
                                            }
                                            @displayName
                                            <span class="badge @GetStatusBadgeClass(comanda) me-2">@statusText</span>
                                        </h5>
                                        <div class="text-white-50 small">@comanda.VendedorNome</div>
                                    </div>
                                <div class="text-end">
                                        <div class="fs-6 text-success">R$ @comanda.ValorTotal.ToString("F2")</div>
                                        <div class="text-white-50 small">Pagamento: @(comanda.DataPagamentoPrazo.HasValue ? comanda.DataPagamentoPrazo.Value.ToString("dd/MM/yyyy") : "-")</div>
                                        <div class="text-white-50 small">@(comanda.DataPedido?.ToString("dd/MM/yyyy HH:mm") ?? "-")</div>
                                        @* Finalizar button moved to card actions for alignment *@
                                    </div>
                                </div>

                                <p class="card-text mt-2 mb-1">Pagamento: <strong>@comanda.FormaPagamento</strong> (@(comanda.ValorPago1?.ToString("F2") ?? "0.00"))</p>
                                @if (!string.IsNullOrEmpty(comanda.FormaPagamento2))
                                {
                                    <p class="card-text small">Pagamento 2: @comanda.FormaPagamento2 (@(comanda.ValorPago2?.ToString("F2") ?? "0.00"))</p>
                                }
                                @if (comanda.DataPagamentoPrazo.HasValue)
                                {
                                    <p class="card-text small">Data Pagamento: @comanda.DataPagamentoPrazo.Value.ToString("dd/MM/yyyy")</p>
                                }
                                @if (!string.IsNullOrEmpty(comanda.Observacoes))
                                {
                                    <p class="card-text small">Obs: @comanda.Observacoes</p>
                                }
                    <div class="mt-3 d-flex gap-2 flex-wrap align-items-center">
                                    @if (!string.Equals(comanda.Status, "Cancelado", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button class="btn btn-sm btn-primary" @onclick:stopPropagation="true" @onclick="() => ImprimirPedido(comanda.Id)">Imprimir</button>
                                    }
                                    @{
                                        var isCancelled = string.Equals(comanda.Status, "Cancelado", StringComparison.OrdinalIgnoreCase);
                                        var isFinalizado = string.Equals(comanda.Status, "Finalizado", StringComparison.OrdinalIgnoreCase);
                                        var hasAPrazoBtn = string.Equals(comanda.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase)
                                                       || string.Equals(comanda.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase);
                                        var isRetiradaOrEntregaBtn = string.Equals(comanda.Status, "Retirada", StringComparison.OrdinalIgnoreCase)
                                                                 || string.Equals(comanda.Status, "Em entrega", StringComparison.OrdinalIgnoreCase);

                                        var showFinalize = !isCancelled && ((isFinalizado && hasAPrazoBtn) || (!isFinalizado && (hasAPrazoBtn || isRetiradaOrEntregaBtn)));
                                    }
                                    @if (showFinalize)
                                    {
                                        <button class="btn btn-sm btn-success" @onclick:stopPropagation="true" @onclick="() => OpenFinalizeModal(comanda.Id)">Finalizar Pedido</button>
                                    }
                                    @if (!string.Equals(comanda.Status, "Cancelado", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button class="btn btn-sm btn-danger ms-auto" @onclick:stopPropagation="true" @onclick="() => ConfirmarCancelar(comanda.Id)">Cancelar</button>
                                    }
                                </div>
                            </div>
                             </div>
                    </div>
                }
            </div>
            <hr />
        }

        @if (retirada.Any())
        {
            <h5 class="mt-3">Retirada</h5>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                @foreach (var comanda in retirada)
                {
                    <div class="col">
                        <div class="card pedido-card bg-dark text-white @GetBorderClass(comanda)" style="cursor:pointer;" @onclick="() => ShowPedidoModal(comanda.Id)">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="card-title mb-1">
                                            @{
                                                var displayName = (!string.IsNullOrWhiteSpace(comanda.ClienteNome))
                                                    ? comanda.ClienteNome
                                                    : (string.Equals(comanda.Status, "Finalizado", StringComparison.OrdinalIgnoreCase) ? "Avulso" : comanda.ClienteNome);

                                                var hasAPrazo = string.Equals(comanda.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase)
                                                               || string.Equals(comanda.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase);
                                                var statusText = (string.Equals(comanda.Status, "Finalizado", StringComparison.OrdinalIgnoreCase) && hasAPrazo)
                                                    ? "A prazo"
                                                    : (comanda.Status ?? "");
                                            }
                                            @displayName
                                            <span class="badge @GetStatusBadgeClass(comanda) me-2">@statusText</span>
                                        </h5>
                                        <div class="text-white-50 small">@comanda.VendedorNome</div>
                                    </div>
                                <div class="text-end">
                                        <div class="fs-6 text-success">R$ @comanda.ValorTotal.ToString("F2")</div>
                                        <div class="text-white-50 small">Pagamento: @(comanda.DataPagamentoPrazo.HasValue ? comanda.DataPagamentoPrazo.Value.ToString("dd/MM/yyyy") : "-")</div>
                                        <div class="text-white-50 small">@(comanda.DataPedido?.ToString("dd/MM/yyyy HH:mm") ?? "-")</div>
                                        @* Finalizar button moved to card actions for alignment *@
                                    </div>
                                </div>

                                <p class="card-text mt-2 mb-1">Pagamento: <strong>@comanda.FormaPagamento</strong> (@(comanda.ValorPago1?.ToString("F2") ?? "0.00"))</p>
                                @if (!string.IsNullOrEmpty(comanda.FormaPagamento2))
                                {
                                    <p class="card-text small">Pagamento 2: @comanda.FormaPagamento2 (@(comanda.ValorPago2?.ToString("F2") ?? "0.00"))</p>
                                }
                                @if (comanda.DataPagamentoPrazo.HasValue)
                                {
                                    <p class="card-text small">Data Pagamento: @comanda.DataPagamentoPrazo.Value.ToString("dd/MM/yyyy")</p>
                                }
                                @if (!string.IsNullOrEmpty(comanda.Observacoes))
                                {
                                    <p class="card-text small">Obs: @comanda.Observacoes</p>
                                }
                                <div class="mt-3 d-flex gap-2">
                                    @if (!string.Equals(comanda.Status, "Cancelado", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button class="btn btn-sm btn-primary" @onclick:stopPropagation="true" @onclick="() => ImprimirPedido(comanda.Id)">Imprimir</button>
                                    }
                                    @{
                                        var isCancelled = string.Equals(comanda.Status, "Cancelado", StringComparison.OrdinalIgnoreCase);
                                        var isFinalizado = string.Equals(comanda.Status, "Finalizado", StringComparison.OrdinalIgnoreCase);
                                        var hasAPrazoBtn = string.Equals(comanda.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase)
                                                       || string.Equals(comanda.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase);
                                        var isRetiradaOrEntregaBtn = string.Equals(comanda.Status, "Retirada", StringComparison.OrdinalIgnoreCase)
                                                                 || string.Equals(comanda.Status, "Em entrega", StringComparison.OrdinalIgnoreCase);

                                        var showFinalize = !isCancelled && ((isFinalizado && hasAPrazoBtn) || (!isFinalizado && (hasAPrazoBtn || isRetiradaOrEntregaBtn)));
                                    }
                                    @if (showFinalize)
                                    {
                                        <button class="btn btn-sm btn-success" @onclick:stopPropagation="true" @onclick="() => OpenFinalizeModal(comanda.Id)">Finalizar Pedido</button>
                                    }
                                    @if (!string.Equals(comanda.Status, "Cancelado", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button class="btn btn-sm btn-danger ms-auto" @onclick:stopPropagation="true" @onclick="() => ConfirmarCancelar(comanda.Id)">Cancelar</button>
                                    }
                                </div>
                            </div>
                             </div>
                    </div>
                }
            </div>
            <hr />
        }

        @if (aPrazo.Any())
        {
            <h5 class="mt-3">A Prazo</h5>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                @foreach (var comanda in aPrazo)
                {
                    <div class="col">
                        <div class="card pedido-card bg-dark text-white @GetBorderClass(comanda)" style="cursor:pointer;" @onclick="() => ShowPedidoModal(comanda.Id)">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="card-title mb-1">
                                            @{
                                                var displayName = (!string.IsNullOrWhiteSpace(comanda.ClienteNome))
                                                    ? comanda.ClienteNome
                                                    : (string.Equals(comanda.Status, "Finalizado", StringComparison.OrdinalIgnoreCase) ? "Avulso" : comanda.ClienteNome);

                                                var hasAPrazo = string.Equals(comanda.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase)
                                                               || string.Equals(comanda.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase);
                                                var statusText = (string.Equals(comanda.Status, "Finalizado", StringComparison.OrdinalIgnoreCase) && hasAPrazo)
                                                    ? "A prazo"
                                                    : (comanda.Status ?? "");
                                            }
                                            @displayName
                                            <span class="badge @GetStatusBadgeClass(comanda) me-2">@statusText</span>
                                        </h5>
                                        <div class="text-white-50 small">@comanda.VendedorNome</div>
                                    </div>
                                <div class="text-end">
                                        <div class="fs-6 text-success">R$ @comanda.ValorTotal.ToString("F2")</div>
                                        <div class="text-white-50 small">Pagamento: @(comanda.DataPagamentoPrazo.HasValue ? comanda.DataPagamentoPrazo.Value.ToString("dd/MM/yyyy") : "-")</div>
                                        <div class="text-white-50 small">@(comanda.DataPedido?.ToString("dd/MM/yyyy HH:mm") ?? "-")</div>
                                        @* Finalizar button moved to card actions for alignment *@
                                    </div>
                                </div>

                                <p class="card-text mt-2 mb-1">Pagamento: <strong>@comanda.FormaPagamento</strong> (@(comanda.ValorPago1?.ToString("F2") ?? "0.00"))</p>
                                @if (!string.IsNullOrEmpty(comanda.FormaPagamento2))
                                {
                                    <p class="card-text small">Pagamento 2: @comanda.FormaPagamento2 (@(comanda.ValorPago2?.ToString("F2") ?? "0.00"))</p>
                                }
                                @if (comanda.DataPagamentoPrazo.HasValue)
                                {
                                    <p class="card-text small">Data Pagamento: @comanda.DataPagamentoPrazo.Value.ToString("dd/MM/yyyy")</p>
                                }
                                @if (!string.IsNullOrEmpty(comanda.Observacoes))
                                {
                                    <p class="card-text small">Obs: @comanda.Observacoes</p>
                                }
                                <div class="mt-3 d-flex gap-2">
                                    @if (!string.Equals(comanda.Status, "Cancelado", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button class="btn btn-sm btn-primary" @onclick:stopPropagation="true" @onclick="() => ImprimirPedido(comanda.Id)">Imprimir</button>
                                    }
                                    @{
                                        var isCancelled = string.Equals(comanda.Status, "Cancelado", StringComparison.OrdinalIgnoreCase);
                                        var isFinalizado = string.Equals(comanda.Status, "Finalizado", StringComparison.OrdinalIgnoreCase);
                                        var hasAPrazoBtn = string.Equals(comanda.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase)
                                                       || string.Equals(comanda.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase);
                                        var isRetiradaOrEntregaBtn = string.Equals(comanda.Status, "Retirada", StringComparison.OrdinalIgnoreCase)
                                                                 || string.Equals(comanda.Status, "Em entrega", StringComparison.OrdinalIgnoreCase);

                                        var showFinalize = !isCancelled && ((isFinalizado && hasAPrazoBtn) || (!isFinalizado && (hasAPrazoBtn || isRetiradaOrEntregaBtn)));
                                    }
                                    @if (showFinalize)
                                    {
                                        <button class="btn btn-sm btn-success" @onclick:stopPropagation="true" @onclick="() => OpenFinalizeModal(comanda.Id)">Finalizar Pedido</button>
                                    }
                                    @if (!string.Equals(comanda.Status, "Cancelado", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button class="btn btn-sm btn-danger ms-auto" @onclick:stopPropagation="true" @onclick="() => ConfirmarCancelar(comanda.Id)">Cancelar</button>
                                    }
                                </div>
                            </div>
                             </div>
                    </div>
                }
            </div>
            <hr />
        }

        @if (finalizado.Any())
        {
            <h5 class="mt-3">Finalizados</h5>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                @foreach (var comanda in finalizado)
                {
                    <div class="col">
                        <div class="card pedido-card bg-dark text-white @GetBorderClass(comanda)" style="cursor:pointer;" @onclick="() => ShowPedidoModal(comanda.Id)">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h5 class="card-title mb-1">
                                            @{
                                                var displayName = (!string.IsNullOrWhiteSpace(comanda.ClienteNome))
                                                    ? comanda.ClienteNome
                                                    : (string.Equals(comanda.Status, "Finalizado", StringComparison.OrdinalIgnoreCase) ? "Avulso" : comanda.ClienteNome);

                                                var hasAPrazo = string.Equals(comanda.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase)
                                                               || string.Equals(comanda.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase);
                                                var statusText = (string.Equals(comanda.Status, "Finalizado", StringComparison.OrdinalIgnoreCase) && hasAPrazo)
                                                    ? "A prazo"
                                                    : (comanda.Status ?? "");
                                            }
                                            @displayName
                                            <span class="badge @GetStatusBadgeClass(comanda) me-2">@statusText</span>
                                        </h5>
                                        <div class="text-white-50 small">@comanda.VendedorNome</div>
                                    </div>
                                <div class="text-end">
                                        <div class="fs-6 text-success">R$ @comanda.ValorTotal.ToString("F2")</div>
                                        <div class="text-white-50 small">Pagamento: @(comanda.DataPagamentoPrazo.HasValue ? comanda.DataPagamentoPrazo.Value.ToString("dd/MM/yyyy") : "-")</div>
                                        <div class="text-white-50 small">@(comanda.DataPedido?.ToString("dd/MM/yyyy HH:mm") ?? "-")</div>
                                        @* Finalizar button moved to card actions for alignment *@
                                    </div>
                                </div>

                                <p class="card-text mt-2 mb-1">Pagamento: <strong>@comanda.FormaPagamento</strong> (@(comanda.ValorPago1?.ToString("F2") ?? "0.00"))</p>
                                @if (!string.IsNullOrEmpty(comanda.FormaPagamento2))
                                {
                                    <p class="card-text small">Pagamento 2: @comanda.FormaPagamento2 (@(comanda.ValorPago2?.ToString("F2") ?? "0.00"))</p>
                                }
                                @if (comanda.DataPagamentoPrazo.HasValue)
                                {
                                    <p class="card-text small">Data Pagamento: @comanda.DataPagamentoPrazo.Value.ToString("dd/MM/yyyy")</p>
                                }
                                @if (!string.IsNullOrEmpty(comanda.Observacoes))
                                {
                                    <p class="card-text small">Obs: @comanda.Observacoes</p>
                                }
                                <div class="mt-3 d-flex gap-2">
                                    @if (!string.Equals(comanda.Status, "Cancelado", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button class="btn btn-sm btn-primary" @onclick:stopPropagation="true" @onclick="() => ImprimirPedido(comanda.Id)">Imprimir</button>
                                    }
                                    @{
                                        var isCancelled = string.Equals(comanda.Status, "Cancelado", StringComparison.OrdinalIgnoreCase);
                                        var isFinalizado = string.Equals(comanda.Status, "Finalizado", StringComparison.OrdinalIgnoreCase);
                                        var hasAPrazoBtn = string.Equals(comanda.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase)
                                                       || string.Equals(comanda.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase);
                                        var isRetiradaOrEntregaBtn = string.Equals(comanda.Status, "Retirada", StringComparison.OrdinalIgnoreCase)
                                                                 || string.Equals(comanda.Status, "Em entrega", StringComparison.OrdinalIgnoreCase);

                                        var showFinalize = !isCancelled && ((isFinalizado && hasAPrazoBtn) || (!isFinalizado && (hasAPrazoBtn || isRetiradaOrEntregaBtn)));
                                    }
                                    @if (showFinalize)
                                    {
                                        <button class="btn btn-sm btn-success" @onclick:stopPropagation="true" @onclick="() => OpenFinalizeModal(comanda.Id)">Finalizar Pedido</button>
                                    }
                                    @if (!string.Equals(comanda.Status, "Cancelado", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button class="btn btn-sm btn-danger ms-auto" @onclick:stopPropagation="true" @onclick="() => ConfirmarCancelar(comanda.Id)">Cancelar</button>
                                    }
                                </div>
                            </div>
                             </div>
                    </div>
                }
            </div>
            <hr />
        }

        @if (others.Any())
        {
            <h5 class="mt-3">Outros</h5>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                @foreach (var comanda in others)
                {
                    @RenderPedidoCard(comanda)
                }
            </div>
        }
    </div>

    @* Confirm cancel modal *@
    @if (showCancelModal)
    {
        <div class="modal-backdrop fade show"></div>
        <div class="modal d-block">
            <div class="modal-dialog modal-sm mt-5">
                <div class="modal-content p-3">
                    <h5 class="fw-bold">Confirmar cancelamento</h5>
                    <p>Tem certeza que deseja cancelar o pedido <strong>#@cancelPedidoId</strong>?</p>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-secondary me-2" @onclick="() => showCancelModal = false">Não</button>
                        <button class="btn btn-danger" @onclick="ConfirmCancelar">Sim, cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    }
}

@code {
    private bool isEditingPedido = false;
    private string? editingField = null;
    private string? editClienteNome;
    private string? editTelefone;
    private string? editEndereco;
    private string? editObservacoes;
    private string? editFormaPagamento;
    private string? editFormaPagamento2;
    private DateTime? editDataPagamentoPrazo;
    private DateTime? editDataPagamentoPrazo2;

    private void StartEdit(string field)
    {
        if (currentPedido == null) return;
        isEditingPedido = true;
        editingField = field;
        editClienteNome = currentPedido.ClienteNome;
        editTelefone = currentPedido.Telefone;
        editEndereco = currentPedido.Endereco;
        editObservacoes = currentPedido.Observacoes;
    }

    private void EnableItemEditing()
    {
        isEditingPedido = true;
        StateHasChanged();
    }

    private Pedido? FindPedidoById(int pedidoId)
    {
        var p = pedidosPorData.FirstOrDefault(x => x.Id == pedidoId);
        if (p != null) return p;
        p = prazoOrders.FirstOrDefault(x => x.Id == pedidoId);
        if (p != null) return p;
        return pedidosHoje.FirstOrDefault(x => x.Id == pedidoId);
    }

    private System.Threading.Timer? _saveTimer;

    private void CancelScheduledSave(FocusEventArgs e)
    {
        try { _saveTimer?.Change(System.Threading.Timeout.Infinite, 0); } catch { }
    }

    private void ScheduleSaveOnBlur(FocusEventArgs e)
    {
        // schedule save in 300ms to allow focus moving between inputs without immediate save
        try
        {
            _saveTimer?.Dispose();
            _saveTimer = new System.Threading.Timer(async _ =>
            {
                await InvokeAsync(async () =>
                {
                    await SalvarEdicoes();
                });
            }, null, 300, System.Threading.Timeout.Infinite);
        }
        catch { }
    }

    private async Task SalvarEdicoes()
    {
        if (currentPedido == null) return;

        var dto = new Dictionary<string, object?>
        {
            ["ClienteNome"] = editClienteNome,
            ["Telefone"] = editTelefone,
            ["Endereco"] = editEndereco,
            ["Observacoes"] = editObservacoes
        };

        // include payment edits when present
        if (!string.IsNullOrEmpty(editFormaPagamento)) dto["FormaPagamento"] = editFormaPagamento;
        if (!string.IsNullOrEmpty(editFormaPagamento2)) dto["FormaPagamento2"] = editFormaPagamento2;
        if (editDataPagamentoPrazo.HasValue) dto["DataPagamentoPrazo"] = editDataPagamentoPrazo.Value;
        if (editDataPagamentoPrazo2.HasValue) dto["DataPagamentoPrazo2"] = editDataPagamentoPrazo2.Value;

        var result = await _apiService.AtualizarPedidoParcial(currentPedido.Id, dto);
        if (!string.IsNullOrEmpty(result.ErrorMessage) || !result.Data)
        {
            await JS.InvokeVoidAsync("alert", "Falha ao salvar: " + (result.ErrorMessage ?? ""));
            return;
        }

        currentPedido.ClienteNome = editClienteNome;
        currentPedido.Telefone = editTelefone;
        currentPedido.Endereco = editEndereco;
        currentPedido.Observacoes = editObservacoes;
        // persist payment-field edits locally as well
        if (!string.IsNullOrEmpty(editFormaPagamento)) currentPedido.FormaPagamento = editFormaPagamento;
        if (!string.IsNullOrEmpty(editFormaPagamento2)) currentPedido.FormaPagamento2 = editFormaPagamento2;
        if (editDataPagamentoPrazo.HasValue) currentPedido.DataPagamentoPrazo = editDataPagamentoPrazo;
        if (editDataPagamentoPrazo2.HasValue) currentPedido.DataPagamentoPrazo2 = editDataPagamentoPrazo2;

        // also update in list
        var pedido = pedidosHoje.FirstOrDefault(p => p.Id == currentPedido.Id);
        if (pedido != null)
        {
            pedido.ClienteNome = currentPedido.ClienteNome;
            pedido.Telefone = currentPedido.Telefone;
            pedido.Endereco = currentPedido.Endereco;
            pedido.Observacoes = currentPedido.Observacoes;
        }

        isEditingPedido = false;
        editingField = null;
        await RecomputeTotals();
        // also persist edited item prices/quantities if any
        await PersistEditedPedidoItemsIfAny(currentPedido.Id);
        StateHasChanged();
    }

    private async Task PersistEditedPedidoItemsIfAny(int pedidoId)
    {
        if (!detalhes.TryGetValue(pedidoId, out var pdItems) || pdItems == null) return;

        // Build a serializable list of dictionaries instead of anonymous types to avoid System.Text.Json issues
        var itensDto = pdItems.Select(d => new Dictionary<string, object?> {
            ["Id"] = d.Id,
            ["Preco"] = d.ProdutoPreco,
            ["Quantidade"] = d.Quantidade
        }).ToList();

        try
        {
            // Build DTO matching backend ApiECommerce.DTOs.PedidoUpdateDTO
            var dto = new Dictionary<string, object?>();
            dto["Itens"] = itensDto;

            // include payment/date fields if available on the current pedido object
            var pedido = pedidosPorData.FirstOrDefault(p => p.Id == pedidoId) ?? prazoOrders.FirstOrDefault(p => p.Id == pedidoId) ?? pedidosHoje.FirstOrDefault(p => p.Id == pedidoId);
            if (pedido != null)
            {
                if (!string.IsNullOrEmpty(pedido.FormaPagamento)) dto["FormaPagamento"] = pedido.FormaPagamento;
                if (!string.IsNullOrEmpty(pedido.FormaPagamento2)) dto["FormaPagamento2"] = pedido.FormaPagamento2;
                if (pedido.DataPagamentoPrazo.HasValue) dto["DataPagamentoPrazo"] = pedido.DataPagamentoPrazo;
                if (pedido.DataPagamentoPrazo2.HasValue) dto["DataPagamentoPrazo2"] = pedido.DataPagamentoPrazo2;
            }

            // Use existing helper which PUTs to api/pedidos/{id}/finalize
            var result = await _apiService.AtualizarPedidoParcial(pedidoId, dto);
            if (!string.IsNullOrEmpty(result.ErrorMessage) || !result.Data)
            {
                await JS.InvokeVoidAsync("alert", "Falha ao salvar itens do pedido: " + (result.ErrorMessage ?? ""));
            }
            else
            {
                // Optionally refresh details from server to get recalculated totals
                try
                {
                    var (items, err) = await _apiService.GetPedidoDetalhes(pedidoId);
                    if (items != null)
                    {
                        detalhes[pedidoId] = items;
                        // update local pedido total if returned via separate endpoint (or rely on Recompute)
                    }
                }
                catch { }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Erro ao persistir itens editados: " + ex.Message);
        }
    }
    private string statusFilter = string.Empty;
    // pedidos for the currently selected date (dataSelecionada)
    private List<Pedido> pedidosPorData = new();
    // extra: all orders that have a payment marked as 'A Prazo' (may be outside selected date)
    private List<Pedido> prazoOrders = new();
    private List<Pedido> pedidosHoje = new();

    private IEnumerable<Pedido> pedidosExibidos
    {
        get
        {
            // prazo orders that are not already included in the date list
            var prazoOnly = prazoOrders.Where(p => !pedidosPorData.Any(d => d.Id == p.Id));

            if (string.IsNullOrEmpty(statusFilter))
            {
                return pedidosPorData.Concat(prazoOnly);
            }

            // use effective status: consider Finalizado with payment A Prazo as 'A Prazo'
            // only rely on EffectiveStatus for filtering to avoid mismatches
            var filteredDate = pedidosPorData.Where(p => string.Equals(EffectiveStatus(p), statusFilter, StringComparison.OrdinalIgnoreCase));

            // also filter the prazoOnly list when a specific status filter is applied
            var filteredPrazoOnly = prazoOnly.Where(p => string.Equals(EffectiveStatus(p), statusFilter, StringComparison.OrdinalIgnoreCase));

            // per requirement: status filter should apply only to the orders of the selected date and prazoOrders
            return filteredDate.Concat(filteredPrazoOnly);
        }
    }
    private HashSet<int> expanded = new();
    private Dictionary<int, List<PedidoDetalhe>> detalhes = new();
    private decimal totalVendido = 0;

    private decimal totalDebito = 0;
    private decimal totalCredito = 0;
    private decimal totalPix = 0;
    private decimal totalDinheiro = 0;
    private decimal totalIfood = 0;
    private decimal totalAPrazo = 0;

    private DateTime dataSelecionada = DateTime.Today;

    private bool showCancelModal = false;
    private int cancelPedidoId = 0;
    private bool showPedidoModal = false;
    private Pedido? currentPedido = null;
    private bool showFinalizeModal = false;
    private int finalizePedidoId = 0;
    private string? SelectedFormaPagamento = null;

    private string GetRowClass(Pedido p)
    {
        if (string.Equals(p.Status, "Finalizado", StringComparison.OrdinalIgnoreCase))
            return "table-success";
        if (string.Equals(p.Status, "Retirada", StringComparison.OrdinalIgnoreCase))
            return "table-warning";
        if (string.Equals(p.Status, "Cancelado", StringComparison.OrdinalIgnoreCase))
            return "table-danger";
        return string.Empty; // normal
    }

    private string GetStatusBadgeClass(Pedido p)
    {
        var status = p?.Status;
        if (string.IsNullOrWhiteSpace(status))
            return "bg-secondary text-white";

        // If status is Finalizado but there is still a payment 'A Prazo', show red to indicate attention
        var hasAPrazo = string.Equals(p.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase)
                       || string.Equals(p.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase);

        var s = status.Trim().ToLowerInvariant();
        if (s == "finalizado" && hasAPrazo)
            return "bg-danger text-white"; // show red for finalized but still A Prazo

        return s switch
        {
            "finalizado" => "bg-success text-white",
            "retirada" => "bg-warning text-dark",
            "cancelado" => "bg-danger text-white",
            "em entrega" => "bg-info text-dark",
            "a caminho" => "bg-info text-dark",
            "a prazo" => "bg-primary text-white",
            _ => "bg-secondary text-white",
        };
    }

    private string GetBorderClass(Pedido p)
    {
        // keep dark background but add colored left border to indicate status
        if (p == null) return string.Empty;
        if (string.Equals(p.Status, "Finalizado", StringComparison.OrdinalIgnoreCase))
            return "border-start border-4 border-success";
        if (string.Equals(p.Status, "Retirada", StringComparison.OrdinalIgnoreCase))
            return "border-start border-4 border-warning";
        if (string.Equals(p.Status, "Cancelado", StringComparison.OrdinalIgnoreCase))
            return "border-start border-4 border-danger";
        if (string.Equals(p.Status, "Em entrega", StringComparison.OrdinalIgnoreCase))
            return "border-start border-4 border-info";
        if (string.Equals(p.Status, "A Prazo", StringComparison.OrdinalIgnoreCase))
            return "border-start border-4 border-primary";
        return string.Empty;
    }

    private void ConfirmarCancelar(int pedidoId)
    {
        cancelPedidoId = pedidoId;
        // If the details modal is open, close it so the confirm modal appears on top
        showPedidoModal = false;
        showCancelModal = true;
    }

    private string EffectiveStatus(Pedido p)
    {
        if (p == null) return string.Empty;
        // If finalized but either payment is 'A Prazo', treat as 'A Prazo'
        if (string.Equals(p.Status, "Finalizado", StringComparison.OrdinalIgnoreCase)
            && (string.Equals(p.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase)
                || string.Equals(p.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase)))
        {
            return "A Prazo";
        }

        return p.Status ?? string.Empty;
    }

    private async Task ShowPedidoModal(int pedidoId)
    {
        // try to find the pedido in the date list or in prazo orders
        currentPedido = FindPedidoById(pedidoId);
        // ensure details are loaded before showing modal
        await LoadDetailsIfNeeded(pedidoId);
        // initialize editable payment fields from currentPedido
        if (currentPedido != null)
        {
            editFormaPagamento = currentPedido.FormaPagamento;
            editFormaPagamento2 = currentPedido.FormaPagamento2;
            editDataPagamentoPrazo = currentPedido.DataPagamentoPrazo;
            editDataPagamentoPrazo2 = currentPedido.DataPagamentoPrazo2;
        }
        showPedidoModal = true;
        StateHasChanged();
    }

    private async Task ClosePedidoModal()
    {
        // ensure any scheduled save is cancelled and perform save if in edit mode
        try { _saveTimer?.Change(System.Threading.Timeout.Infinite, 0); } catch { }

        if (isEditingPedido && currentPedido != null)
        {
            // await save of edits before closing
            await SalvarEdicoes();
        }

        showPedidoModal = false;
        currentPedido = null;
        StateHasChanged();
    }

    private async Task ConfirmCancelar()
    {
        showCancelModal = false;
        try
        {
            var result = await _apiService.CancelarPedido(cancelPedidoId);
            if (!string.IsNullOrEmpty(result.ErrorMessage) || !result.Data)
            {
                await JS.InvokeVoidAsync("alert", "Falha ao cancelar pedido: " + (result.ErrorMessage ?? ""));
                return;
            }

            var pedido = pedidosHoje.FirstOrDefault(p => p.Id == cancelPedidoId);
            if (pedido != null)
            {
                pedido.Status = "Cancelado";
            }

            await RecomputeTotals();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Erro ao cancelar pedido: " + ex.Message);
            await JS.InvokeVoidAsync("alert", "Erro ao cancelar pedido: " + ex.Message);
        }
    }

    private async Task LoadDetailsIfNeeded(int pedidoId)
    {
        if (!detalhes.ContainsKey(pedidoId))
        {
            try
            {
                var (items, error) = await _apiService.GetPedidoDetalhes(pedidoId);
                detalhes[pedidoId] = items ?? new List<PedidoDetalhe>();
            }
            catch
            {
                detalhes[pedidoId] = new List<PedidoDetalhe>();
            }
        }
    }

    private Task RecomputeTotals()
    {
        // Recompute totals based on the currently displayed pedidos (pedidosHoje)
        ComputeSummaryFromList(pedidosHoje);

        return Task.CompletedTask;
    }

    // Compute summary totals for an arbitrary list of pedidos (used to show today's summary while listing all pedidos)
    private void ComputeSummaryFromList(List<Pedido> source)
    {
        if (source == null) source = new List<Pedido>();

        var valid = source.Where(c => !string.Equals(c.Status, "Cancelado", StringComparison.OrdinalIgnoreCase)).ToList();

        totalVendido = valid
            .Where(c => string.Equals(c.Status, "Finalizado", StringComparison.OrdinalIgnoreCase)
                        && !(
                            string.Equals(c.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase)
                            || string.Equals(c.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase)
                        ))
            .Sum(c => c.ValorTotal);

        totalDebito = valid
            .Where(c => string.Equals(c.FormaPagamento, "Debito", StringComparison.OrdinalIgnoreCase))
            .Sum(c => c.ValorTotal);

        totalCredito = valid
            .Where(c => string.Equals(c.FormaPagamento, "Credito", StringComparison.OrdinalIgnoreCase))
            .Sum(c => c.ValorTotal);

        totalPix = valid
            .Where(c => string.Equals(c.FormaPagamento, "Pix", StringComparison.OrdinalIgnoreCase))
            .Sum(c => c.ValorTotal);

        totalDinheiro = valid
            .Where(c => string.Equals(c.FormaPagamento, "Dinheiro", StringComparison.OrdinalIgnoreCase))
            .Sum(c => c.ValorTotal);

        totalIfood = valid
            .Where(c => string.Equals(c.FormaPagamento, "Ifood", StringComparison.OrdinalIgnoreCase))
            .Sum(c => c.ValorTotal);

        // compute A prazo totals: include both FormaPagamento and FormaPagamento2
        totalAPrazo = valid
            .Where(c => string.Equals(c.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase)
                     || string.Equals(c.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase))
            .Sum(c => c.ValorTotal);
    }

    protected override async Task OnInitializedAsync()
    {
        var nome = await JS.InvokeAsync<string>("sessionStorage.getItem", "Email");
        if (string.IsNullOrEmpty(nome))
        {
            Navigation.NavigateTo("login");
            return;
        }
        // load pedidos for the initial date (today) and prazo orders
        try
        {
        // fetch pedidos for the selected date (today)
        var (comandasHoje, errHoje) = await _apiService.GetPedidosPorData(DateTime.Today);
            if (string.IsNullOrEmpty(errHoje) && comandasHoje != null)
            {
                // exclude cancelled
                pedidosPorData = comandasHoje.Where(p => !string.Equals(p.Status, "Cancelado", StringComparison.OrdinalIgnoreCase)).ToList();
            }
            else
            {
                pedidosPorData = new List<Pedido>();
            }

            // also fetch all orders that have payment 'A Prazo' (either formaPagamento or formaPagamento2)
            var (todos, errAll) = await _apiService.GetAllPedidos();
            if (!string.IsNullOrEmpty(errAll) || todos == null)
            {
                prazoOrders = new List<Pedido>();
            }
            else
            {
                prazoOrders = todos
                    .Where(p => (string.Equals(p.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase)
                                 || string.Equals(p.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase))
                                && !string.Equals(p.Status, "Cancelado", StringComparison.OrdinalIgnoreCase))
                    .ToList();
            }

            // initial visible list uses pedidosPorData (today) and prazoOrders merged by the property above
            pedidosHoje = pedidosPorData.ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Exceção ao carregar todos pedidos: " + ex.Message);
            pedidosHoje = new List<Pedido>();
        }

        // compute summary specifically for today
        try
        {
            var (comandasHoje, errHoje) = await _apiService.GetPedidosPorData(DateTime.Today);
            if (string.IsNullOrEmpty(errHoje) && comandasHoje != null)
            {
                ComputeSummaryFromList(comandasHoje);
            }
            else
            {
                ComputeSummaryFromList(new List<Pedido>());
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Exceção ao carregar resumo de hoje: " + ex.Message);
            ComputeSummaryFromList(new List<Pedido>());
        }
    }

    private async Task BuscarPedidosPorData()
    {
        var (comandas, errorMessage) = await _apiService.GetPedidosPorData(dataSelecionada);
        if (!string.IsNullOrEmpty(errorMessage))
        {
            Console.WriteLine("Erro ao buscar pedidos: " + errorMessage);
            return;
        }

        // for selected date, exclude cancelled
        pedidosPorData = (comandas ?? new List<Pedido>()).Where(p => !string.Equals(p.Status, "Cancelado", StringComparison.OrdinalIgnoreCase)).ToList();

        // recompute prazoOrders in case they changed
        try
        {
            var (todos, errAll) = await _apiService.GetAllPedidos();
            if (string.IsNullOrEmpty(errAll) && todos != null)
            {
                prazoOrders = todos
                    .Where(p => (string.Equals(p.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase)
                                 || string.Equals(p.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase))
                                 && !string.Equals(p.Status, "Cancelado", StringComparison.OrdinalIgnoreCase))
                    .ToList();
            }
        }
        catch { }

        pedidosHoje = pedidosPorData.ToList();
        await RecomputeTotals();
        StateHasChanged();
    }

    private async Task ToggleDetails(int pedidoId)
    {
        if (expanded.Contains(pedidoId))
        {
            expanded.Remove(pedidoId);
            return;
        }

        if (!detalhes.ContainsKey(pedidoId))
        {
            try
            {
                var (items, error) = await _apiService.GetPedidoDetalhes(pedidoId);
                detalhes[pedidoId] = items ?? new List<PedidoDetalhe>();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Exceção ao buscar detalhes do pedido {pedidoId}: {ex.Message}");
                detalhes[pedidoId] = new List<PedidoDetalhe>();
            }
        }

        expanded.Add(pedidoId);
        // when details are loaded, ensure we can edit values locally
        if (detalhes.TryGetValue(pedidoId, out var pdItems) && pdItems != null)
        {
            // compute subtotals to ensure UI shows current values
            foreach (var it in pdItems)
            {
                it.SubTotal = Math.Round(it.ProdutoPreco * it.Quantidade, 2);
            }
        }
        StateHasChanged();
    }

    private void OnEditItemQuantity(int pedidoId, PedidoDetalhe detalhe, ChangeEventArgs e)
    {
        if (detalhe == null) return;
        if (int.TryParse(e?.Value?.ToString(), out var q))
        {
            detalhe.Quantidade = q;
            detalhe.SubTotal = Math.Round(detalhe.ProdutoPreco * q, 2);
            // update parent pedido total locally
            UpdatePedidoLocalTotal(pedidoId);
            StateHasChanged();
        }
    }

    private void OnEditItemPreco(int pedidoId, PedidoDetalhe detalhe, ChangeEventArgs e)
    {
        if (detalhe == null) return;
        if (decimal.TryParse(e?.Value?.ToString(), NumberStyles.Number, CultureInfo.CurrentCulture, out var p))
        {
            detalhe.ProdutoPreco = Math.Round(p, 2);
            detalhe.SubTotal = Math.Round(detalhe.ProdutoPreco * detalhe.Quantidade, 2);
            UpdatePedidoLocalTotal(pedidoId);
            StateHasChanged();
        }
    }

    private void UpdatePedidoLocalTotal(int pedidoId)
    {
        var pedido = pedidosHoje.FirstOrDefault(p => p.Id == pedidoId) ?? pedidosPorData.FirstOrDefault(p => p.Id == pedidoId);
        if (pedido == null) return;
        if (detalhes.TryGetValue(pedidoId, out var pdItems) && pdItems != null)
        {
            pedido.ValorTotal = pdItems.Sum(d => d.SubTotal);
        }
    }

    private void SetStatusFilter(string value)
    {
        statusFilter = value ?? string.Empty;
        // Apply filter locally to currently loaded lists and re-render
        StateHasChanged();
    }

    private RenderFragment RenderPedidoCard(Pedido comanda) => __builder =>
    {
        if (comanda == null) return;
        // show cancelled orders only when viewing today's date
        if (string.Equals(comanda.Status, "Cancelado", StringComparison.OrdinalIgnoreCase) && dataSelecionada.Date != DateTime.Today)
        {
            return;
        }

        <text>
        <div class="col">
            <div class="card pedido-card bg-dark text-white @GetBorderClass(comanda)" style="cursor:pointer;" @onclick="() => ShowPedidoModal(comanda.Id)">
                <div class="card-body d-flex flex-column justify-content-between">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1 pe-2">
                            <h5 class="card-title mb-1 text-truncate">
                                @((!string.IsNullOrWhiteSpace(comanda.ClienteNome)) ? comanda.ClienteNome : (string.IsNullOrWhiteSpace(comanda.ClienteNome) ? "Avulso" : comanda.ClienteNome))
                                <span class="badge @GetStatusBadgeClass(comanda) ms-2">@((EffectiveStatus(comanda) == "A Prazo") ? "A Prazo" : (comanda.Status ?? ""))</span>
                            </h5>
                            <div class="text-white-50 small text-truncate">@comanda.VendedorNome</div>
                        </div>
                        <div class="text-end ms-2">
                            <div class="fs-6 text-success">R$ @comanda.ValorTotal.ToString("F2")</div>
                            <div class="text-white-50 small">@(comanda.DataPedido?.ToString("dd/MM/yyyy HH:mm") ?? "-")</div>
                        </div>
                    </div>

                    <p class="card-text mt-2 mb-1 text-truncate">Pagamento: <strong>@comanda.FormaPagamento</strong> (@(comanda.ValorPago1?.ToString("F2") ?? "0.00"))</p>
                    @if (!string.IsNullOrEmpty(comanda.FormaPagamento2))
                    {
                        <p class="card-text small">Pagamento 2: @comanda.FormaPagamento2 (@(comanda.ValorPago2?.ToString("F2") ?? "0.00"))</p>
                    }
                    @if (comanda.DataPagamentoPrazo.HasValue)
                    {
                        <p class="card-text small">Data Pagamento: @comanda.DataPagamentoPrazo.Value.ToString("dd/MM/yyyy")</p>
                    }
                    @if (!string.IsNullOrEmpty(comanda.Observacoes))
                    {
                        <p class="card-text small">Obs: @comanda.Observacoes</p>
                    }
                    <div class="mt-3 d-flex gap-2">
                        @if (!string.Equals(comanda.Status, "Cancelado", StringComparison.OrdinalIgnoreCase))
                        {
                            <button class="btn btn-sm btn-primary" @onclick:stopPropagation="true" @onclick="() => ImprimirPedido(comanda.Id)">Imprimir</button>
                        }
                        @{
                            var isCancelled = string.Equals(comanda.Status, "Cancelado", StringComparison.OrdinalIgnoreCase);
                            var isFinalizado = string.Equals(comanda.Status, "Finalizado", StringComparison.OrdinalIgnoreCase);
                            var hasAPrazoBtn = string.Equals(comanda.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase)
                                           || string.Equals(comanda.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase);
                            var isRetiradaOrEntregaBtn = string.Equals(comanda.Status, "Retirada", StringComparison.OrdinalIgnoreCase)
                                                     || string.Equals(comanda.Status, "Em entrega", StringComparison.OrdinalIgnoreCase);

                            // Show finalize when not cancelled AND either:
                            // - order is finalized but still has a payment 'A Prazo' (allow converting prazo after finalization)
                            // - order is not finalized and is eligible (A Prazo OR Retirada OR Em entrega)
                            var showFinalize = !isCancelled && ((isFinalizado && hasAPrazoBtn) || (!isFinalizado && (hasAPrazoBtn || isRetiradaOrEntregaBtn)));
                        }
                        @if (showFinalize)
                        {
                            <button class="btn btn-sm btn-success" @onclick:stopPropagation="true" @onclick="() => OpenFinalizeModal(comanda.Id)">Finalizar Pedido</button>
                        }
                        @if (!string.Equals(comanda.Status, "Cancelado", StringComparison.OrdinalIgnoreCase))
                        {
                            <button class="btn btn-sm btn-danger ms-auto" @onclick:stopPropagation="true" @onclick="() => ConfirmarCancelar(comanda.Id)">Cancelar</button>
                        }
                    </div>
                </div>
                 </div>
        </div>
        </text>
    };

    private async Task ImprimirPedido(int pedidoId)
    {
        try
        {
            var dto = new { Id = pedidoId };
            var json = System.Text.Json.JsonSerializer.Serialize(dto);
            var content = new System.Net.Http.StringContent(json, System.Text.Encoding.UTF8, "application/json");
            var response = await _apiService.PostRequest("api/Impressao/pedido/imprimir", content);

            if (!response.IsSuccessStatusCode)
            {
                var text = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Falha na impressão: {response.StatusCode} - {text}");
                return;
            }

            var respJson = await response.Content.ReadAsStringAsync();
            // fallback: sometimes API wraps result in { data: ... } or returns direct object
            BlazorDeploy.Models.ImpressaoResultado? resultado = null;
            try
            {
                resultado = System.Text.Json.JsonSerializer.Deserialize<BlazorDeploy.Models.ImpressaoResultado>(respJson, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            }
            catch { }

            if (resultado == null)
            {
                try
                {
                    using var doc = JsonDocument.Parse(respJson);
                    if (doc.RootElement.TryGetProperty("data", out var dataEl))
                    {
                        var s = dataEl.GetRawText();
                        resultado = System.Text.Json.JsonSerializer.Deserialize<BlazorDeploy.Models.ImpressaoResultado>(s, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    }
                }
                catch { }
            }
            if (resultado == null)
            {
                await JS.InvokeVoidAsync("alert", "Resposta inválida do servidor de impressão.");
                return;
            }

            await JS.InvokeVoidAsync("alert", "Impressão gerada para pedido " + resultado.PedidoId + "\nTexto:\n" + (resultado.Texto ?? "(vazio)"));
        }
        catch (Exception ex)
        {
            Console.WriteLine("Erro ao imprimir: " + ex.Message);
            await JS.InvokeVoidAsync("alert", "Erro ao imprimir pedido: " + ex.Message);
        }
    }

    private async Task FinalizePedido(int pedidoId)
    {
        // Open modal to select payment form for eligible orders
        var pedido = FindPedidoById(pedidoId);
        if (pedido == null)
        {
            await JS.InvokeVoidAsync("alert", "Pedido não encontrado.");
            return;
        }

        // store id and show modal
        finalizePedidoId = pedidoId;
        SelectedFormaPagamento = null;
        showFinalizeModal = true;
    }

    private void OpenFinalizeModal(int pedidoId)
    {
        finalizePedidoId = pedidoId;
        SelectedFormaPagamento = null;
        showFinalizeModal = true;
    }

    private void CloseFinalizeModal(bool apply)
    {
        showFinalizeModal = false;
        if (!apply)
        {
            finalizePedidoId = 0;
            SelectedFormaPagamento = null;
        }
    }

    private async Task ConfirmFinalize()
    {
        if (finalizePedidoId == 0)
            return;

        if (string.IsNullOrEmpty(SelectedFormaPagamento))
        {
            await JS.InvokeVoidAsync("alert", "Selecione uma forma de pagamento.");
            return;
        }

        try
        {
            // Build DTO to set Status=Finalizado and update payment fields as needed
            var dto = new Dictionary<string, object>
            {
                ["Status"] = "Finalizado"
            };

            var pedido = FindPedidoById(finalizePedidoId);
            if (pedido == null)
            {
                await JS.InvokeVoidAsync("alert", "Pedido não encontrado.");
                CloseFinalizeModal(false);
                return;
            }

            // If either payment field is 'A Prazo', replace that field with selected forma and set DataPagamentoPrazo to today
            if (string.Equals(pedido.FormaPagamento, "A Prazo", StringComparison.OrdinalIgnoreCase))
            {
                dto["FormaPagamento"] = SelectedFormaPagamento;
                dto["DataPagamentoPrazo"] = DateTime.Today;
                pedido.FormaPagamento = SelectedFormaPagamento;
                pedido.DataPagamentoPrazo = DateTime.Today;
            }
            else if (string.Equals(pedido.FormaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase))
            {
                dto["FormaPagamento2"] = SelectedFormaPagamento;
                dto["DataPagamentoPrazo2"] = DateTime.Today;
                pedido.FormaPagamento2 = SelectedFormaPagamento;
                pedido.DataPagamentoPrazo2 = DateTime.Today;
            }
            else
            {
                // otherwise just set the primary formaPagamento to the selected one
                dto["FormaPagamento"] = SelectedFormaPagamento;
                pedido.FormaPagamento = SelectedFormaPagamento;
            }

            var updateResult = await _apiService.AtualizarPedidoParcial(finalizePedidoId, dto);
            if (!string.IsNullOrEmpty(updateResult.ErrorMessage) || !updateResult.Data)
            {
                await JS.InvokeVoidAsync("alert", "Falha ao finalizar pedido: " + (updateResult.ErrorMessage ?? ""));
                return;
            }

            // reflect locally
            pedido.Status = "Finalizado";

            // After finalizing, refresh today's summary so the finalized order (with payment date = today) is counted
            try
            {
                var (comandasHoje, errHoje) = await _apiService.GetPedidosPorData(DateTime.Today);
                if (string.IsNullOrEmpty(errHoje) && comandasHoje != null)
                {
                    ComputeSummaryFromList(comandasHoje);
                }
                else
                {
                    ComputeSummaryFromList(new List<Pedido>());
                }
            }
            catch
            {
                // ignore errors here but keep UI consistent
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", "Erro ao finalizar pedido: " + ex.Message);
        }
        finally
        {
            CloseFinalizeModal(true);
        }
    }
}