@page "/inventario"
@using BlazorDeploy.DTOs
@using Microsoft.AspNetCore.Components.Forms
@using System.Globalization
@inject ApiService _apiService
@inject AuthService AuthService
@inject IJSRuntime JS
@inject NavigationManager Navigation

<div class="row g-3">
    <div class="col-md-6">
        <div class="card p-3 mb-3 shadow-sm bg-dark text-white">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">Registrar Movimentação</h5>
                <button class="btn btn-sm btn-outline-primary" title="Abrir leitor (câmera)" @onclick="OpenScanner">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                        <path d="M10.5 2a.5.5 0 0 1 .5.5V3h1.5A1.5 1.5 0 0 1 14 4.5v7A1.5 1.5 0 0 1 12.5 13H3.5A1.5 1.5 0 0 1 2 11.5v-7A1.5 1.5 0 0 1 3.5 3H5v-.5a.5.5 0 0 1 .5-.5h5zM8 5a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>
                        <path d="M8 6.5a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3z"/>
                    </svg>
                </button>
            </div>

            @* <label class="form-label">Produto (nome ou código de barras)</label> *@
            <input class="form-control mb-2" value="@searchTerm" @oninput="OnProductSearchInput" placeholder="Pesquisar por nome ou código" />

            @if (produtosFiltrados.Any() && !string.IsNullOrWhiteSpace(searchTerm))
            {
                <div class="list-group mb-2" style="max-height:220px; overflow:auto;">
                    @foreach (var p in produtosFiltrados)
                    {
                        <button class="list-group-item list-group-item-action bg-dark text-white border-secondary" @onclick="async () => await SelecionarProduto(p)">
                            <div class="d-flex justify-content-between">
                                <div class="text-white">@p.Nome</div>
                                <div class="text-white-50 small">@p.Barcode</div>
                            </div>
                        </button>
                    }
                </div>
            }

            @if (produtoSelecionado != null)
            {
                <div class="card mb-2 p-2 bg-dark text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">@produtoSelecionado.Nome</div>
                            <div class="small text-white-50">Barcode: @(produtoSelecionado.Barcode ?? "-")</div>
                        </div>
                        <div class="text-end">
                            <div class="small text-white-50">Em estoque</div>
                            <div>
                                <span class="fw-bold">@produtoSelecionado.EmEstoque</span>
                                @if (TryGetProjectedStock(out var projected))
                                {
                                    var css = GetProjectedCss();
                                    <span class="ms-2 @css">→ @projected</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }

            <label>Quantidade</label>
            <input type="number" class="form-control mb-2" value="@quantidadeInput" @oninput="OnQuantidadeInput" />

            <label>Tipo de Movimentação</label>
            <select class="form-select mb-2" @onchange="OnTipoChanged">
                <option value="Compra">Entrada (Compra)</option>
                <option value="Venda">Saída (Venda)</option>
            </select>

            <label>Preço de Custo</label>
            <input type="number" step="0.01" class="form-control mb-2" @bind="movimentacao.PrecoCusto" />

            <button class="btn btn-primary w-100" @onclick="RegistrarMovimentacao">Registrar</button>
            @if (!string.IsNullOrEmpty(mensagem))
            {
                <div class="mt-2">@mensagem</div>
            }
        </div>
    </div>

    <div class="col-md-6">
        <div class="card p-3 mb-3">
            <h5>Upload de XML (Notas)</h5>
            <InputFile OnChange="OnFileSelected" accept=".xml" />
            <div class="mt-2 d-flex gap-2">
                <button class="btn btn-success" @onclick="UploadXml" disabled="@(!hasSelectedFile || isUploading)">
                    @(isUploading ? "Enviando..." : "Enviar XML")
                </button>
                <button class="btn btn-secondary" @onclick="() => { selectedFile = null; hasSelectedFile = false; }">Limpar</button>
            </div>
        </div>

        <div class="card p-3">
            <h5>Últimas Notas</h5>
            @if (latestNotas == null)
            {
                <p>Carregando...</p>
            }
            else if (!latestNotas.Any())
            {
                <p>Nenhuma nota encontrada.</p>
            }
            else
            {
                <div class="row row-cols-1 g-2">
                    @foreach (var inv in latestNotas)
                    {
                        <div class="col">
                            <div class="card p-2 shadow-sm" style="cursor:pointer;" @onclick="() => LoadInvoiceItems(inv.Id.ToString(), inv.NumeroNota)">
                                <div class="d-flex justify-content-between">
                                    <div><strong>@inv.NumeroNota</strong></div>
                                    <div class="text-muted">@inv.DataEmissao.ToString("yyyy-MM-dd")</div>
                                </div>
                                <div class="small text-muted">Fornecedor: @(inv.Fornecedor ?? "-")</div>
                                <div class="small text-muted">Valor: R$ @inv.ValorTotal.ToString("0.00")</div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <div class="col-12">
        @if (selectedItems != null)
        {
            <h5 class="mt-3">Itens da Nota: @selectedInvoiceNumber</h5>
            <div class="row row-cols-1 row-cols-md-3 g-3">
                @foreach (var it in selectedItems)
                {
                    <div class="col">
                        <div class="card p-2">
                            <div><strong>@(it.ProdutoNome ?? it.Nome ?? "-")</strong></div>
                            <div>Barcode: @(it.Barcode ?? "-")</div>
                            <div>Qtd: @it.Quantidade</div>
                            <div>Preço Custo: R$ @it.PrecoCusto.ToString("0.00")</div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private List<Produto> produtos = new();
    private List<Produto> produtosFiltrados = new();
    private MovimentacaoEstoque movimentacao = new();
    private string produtoBusca = "";
    private string searchTerm = string.Empty;
    private Produto? produtoSelecionado;
    private string mensagem = "";
    private bool isLoading = true;
    private bool isProcessing = false;
    private IBrowserFile? selectedFile;
    private bool hasSelectedFile = false;
    private bool isUploading = false;
    private List<NotaEntradaDto>? latestNotas;
    private List<NotaEntradaItemDto>? selectedItems;
    private string? selectedInvoiceNumber;
    private string quantidadeInput = string.Empty;
    private DotNetObjectReference<object>? _dotNetRefInventario;

    private void OnQuantidadeChanged()
    {
        // no-op: triggers UI refresh via binding
    }

    private void OnTipoChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<TipoMovimentacao>(e?.Value?.ToString(), out var t))
        {
            movimentacao.Tipo = t;
        }
        StateHasChanged();
    }

    private void OnQuantidadeInput(ChangeEventArgs e)
    {
        quantidadeInput = e?.Value?.ToString() ?? string.Empty;
        StateHasChanged();
    }

    private bool TryGetProjectedStock(out int projected)
    {
        projected = 0;
        if (produtoSelecionado == null) return false;
        if (!int.TryParse(quantidadeInput, NumberStyles.Integer, CultureInfo.InvariantCulture, out var q)) return false;

        if (movimentacao.Tipo == TipoMovimentacao.Compra)
        {
            projected = produtoSelecionado.EmEstoque + q;
            return true;
        }
        else if (movimentacao.Tipo == TipoMovimentacao.Venda)
        {
            projected = produtoSelecionado.EmEstoque - q;
            return true;
        }
        return false;
    }

    private string GetProjectedCss()
    {
        if (movimentacao.Tipo == TipoMovimentacao.Compra) return "text-success";
        if (movimentacao.Tipo == TipoMovimentacao.Venda) return "text-danger";
        return "";
    }

    protected override async Task OnInitializedAsync()
    {
        var nome = await JS.InvokeAsync<string>("sessionStorage.getItem", "Email");

        if (string.IsNullOrEmpty(nome))
        {
            Navigation.NavigateTo("login");
            return;
        }

        var (response, errorMessage) = await _apiService.GetTodosProdutos();
        produtos = response ?? new List<Produto>();

        // load notas via novo endpoint
        var (notas, notasErr) = await _apiService.GetNotasEntrada();
        latestNotas = notas ?? new List<NotaEntradaDto>();
    }

    private async Task OpenScanner()
    {
        _dotNetRefInventario ??= DotNetObjectReference.Create((object)this);
        await JS.InvokeVoidAsync("barcodeScanner.start", _dotNetRefInventario, "barcode-scanner-container");
    }

    [JSInvokable]
    public async Task OnBarcodeScanned(string code)
    {
        // fill searchTerm and trigger filter
        searchTerm = code;
        OnProductSearchInput(new ChangeEventArgs { Value = code });

        // try auto-select product if found
        var found = produtos.FirstOrDefault(p => string.Equals(p.Barcode?.Trim(), code?.Trim(), StringComparison.OrdinalIgnoreCase)
                    || (!string.IsNullOrEmpty(p.Barcode) && new string(p.Barcode.Where(char.IsDigit).ToArray()) == new string(code.Where(char.IsDigit).ToArray())));
        if (found != null)
        {
            await SelecionarProduto(found);
            StateHasChanged();
        }
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        hasSelectedFile = selectedFile != null;
    }

    private async Task UploadXml()
    {
        if (selectedFile == null) return;
        isUploading = true;
        var result = await _apiService.UploadInvoiceXml(selectedFile);
        if (result.Data)
        {
            await LoadLatestInvoices();
            await JS.InvokeVoidAsync("alert", "XML enviado com sucesso.");
        }
        else
        {
            await JS.InvokeVoidAsync("alert", $"Falha ao enviar XML: {result.ErrorMessage}");
        }
        isUploading = false;
    }

    private async Task LoadLatestInvoices()
    {
        var (list, err) = await _apiService.GetNotasEntrada();
        latestNotas = list ?? new List<NotaEntradaDto>();
    }

    private Task LoadInvoiceItems(string id, string number)
    {
        if (latestNotas == null)
            return Task.CompletedTask;

        NotaEntradaDto? nota = null;
        if (int.TryParse(id, out var iid))
            nota = latestNotas.FirstOrDefault(n => n.Id == iid || n.NumeroNota == number || n.NumeroNota == id);
        else
            nota = latestNotas.FirstOrDefault(n => n.NumeroNota == id || n.NumeroNota == number);

        if (nota != null)
        {
            selectedItems = nota.Itens ?? new List<NotaEntradaItemDto>();
            selectedInvoiceNumber = nota.NumeroNota;
        }

        return Task.CompletedTask;
    }

    private void FiltrarProdutos(ChangeEventArgs e)
    {
        produtoBusca = e.Value?.ToString() ?? "";

        var term = produtoBusca.Trim();
        if (string.IsNullOrEmpty(term))
        {
            produtosFiltrados.Clear();
            return;
        }

        // match either name or barcode
        produtosFiltrados = produtos
            .Where(p => (!string.IsNullOrEmpty(p.Nome) && p.Nome.Contains(term, StringComparison.OrdinalIgnoreCase))
                     || (!string.IsNullOrEmpty(p.Barcode) && p.Barcode.Contains(term, StringComparison.OrdinalIgnoreCase)))
            .Take(10)
            .ToList();
    }

    private void OnProductSearchInput(ChangeEventArgs e)
    {
        searchTerm = e?.Value?.ToString() ?? string.Empty;
        // reuse filter logic
        produtoBusca = searchTerm;
        FiltrarProdutos(new ChangeEventArgs { Value = produtoBusca });
    }

    private async Task SelecionarProduto(Produto produto)
    {
        produtoSelecionado = produto;
        movimentacao.ProdutoId = produto.Id;
        produtoBusca = produto.Nome;
        // initialize quantity input empty for manual entry
        quantidadeInput = string.Empty;
        movimentacao.Quantidade = 0;
        produtosFiltrados.Clear();

        // try fetch stock details from API to get accurate EmEstoque
        try
        {
            var (estoque, err) = await _apiService.GetProdutoEstoque(produto.Id);
            if (estoque != null)
            {
                produtoSelecionado.EmEstoque = estoque.Quantidade;
            }
        }
        catch { }

        StateHasChanged();
    }

    private async Task RegistrarMovimentacao()
    {
        if (produtoSelecionado == null)
        {
            mensagem = "Selecione um produto antes de registrar.";
            return;
        }

        if (!decimal.TryParse(quantidadeInput, out var q) || q <= 0)
        {
            mensagem = "Informe uma quantidade válida.";
            return;
        }

        movimentacao.Quantidade = (int)q;

        var result = await _apiService.MovimentarEstoqueAsync(movimentacao);

        if (result.Data)
        {
            mensagem = "Movimentação registrada com sucesso!";
            movimentacao = new MovimentacaoEstoque();
            produtoBusca = string.Empty;
            produtoSelecionado = null;
            quantidadeInput = string.Empty;
        }
        else
        {
            mensagem = "Erro ao registrar movimentação.";
        }
    }
}
