@page "/abrirfecharcaixa"
@inject ApiService _apiService
@inject IJSRuntime JS
@inject NavigationManager Navigation

<h3>Gerenciar Caixa</h3>

<!-- Current caixa value (top-right). On small screens we show an inline card below the header; on larger screens a fixed card at top-right. -->
<div class="d-block d-sm-none mb-3">@* visible only on xs screens *@
    <div class="card p-2 shadow-sm text-start">
        <div class="small text-muted">Caixa atual</div>
        <div class="fw-bold fs-5">R$ @currentCaixa.ToString("0.00")</div>
        @if (caixaAberto != null)
        {
            <div class="small text-muted">Aberto em @caixaAberto.DataAbertura.ToString("g")</div>
        }

        @if (caixaAberto != null)
        {
            <div class="mt-3">
                <h6 class="mb-2">Registrar Retirada do Caixa</h6>
                <div class="mb-2">
                    <label class="form-label">Valor</label>
                    <InputNumber @bind-Value="retiradaValor" class="form-control" step="0.01" />
                </div>
                <div class="mb-2">
                    <label class="form-label">Descrição</label>
                    <InputText @bind-Value="retiradaDescricao" class="form-control" />
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-danger" @onclick="RegistrarRetiradaAsync" disabled="@(isRegistrandoRetirada || retiradaValor <= 0)">Registrar Retirada</button>
                    <button class="btn btn-secondary" @onclick="LimparRetirada">Limpar</button>
                </div>
                @if (!string.IsNullOrEmpty(retiradaMensagem))
                {
                    <div class="mt-2 text-muted">@retiradaMensagem</div>
                }
            </div>
        }
    </div>
</div>

<div class="position-fixed d-none d-sm-block" style="top:12px; right:12px; z-index:2000;">@* visible on sm and larger screens *@
    <div class="card p-2 shadow-sm text-end" style="min-width:200px;">
        <div class="small text-muted">Caixa atual</div>
        <div class="fw-bold fs-5">R$ @currentCaixa.ToString("0.00")</div>
        @if (caixaAberto != null)
        {
            <div class="small text-muted">Aberto em @caixaAberto.DataAbertura.ToString("g")</div>
        }

        @if (caixaAberto != null)
        {
            <div class="card mt-3 p-3">
                <h5>Registrar Retirada do Caixa</h5>
                <div class="mb-2">
                    <label>Valor</label>
                    <InputNumber @bind-Value="retiradaValor" class="form-control" step="0.01" />
                </div>
                <div class="mb-2">
                    <label>Descrição</label>
                    <InputText @bind-Value="retiradaDescricao" class="form-control" />
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-danger" @onclick="RegistrarRetiradaAsync" disabled="@(isRegistrandoRetirada || retiradaValor <= 0)">Registrar Retirada</button>
                    <button class="btn btn-secondary" @onclick="LimparRetirada">Limpar</button>
                </div>
                @if (!string.IsNullOrEmpty(retiradaMensagem))
                {
                    <div class="mt-2 text-muted">@retiradaMensagem</div>
                }
            </div>
        }
    </div>
</div>

@if (carregando)
{
    <p>Carregando status do caixa...</p>
}
else if (caixaAberto == null)
{
    <EditForm Model="@abrirDto" OnValidSubmit="AbrirCaixa">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Valor de Abertura (somente Dinheiro):</label>
            <InputNumber @bind-Value="abrirDto.ValorAbertura" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Observação (Nome):</label>
            <InputTextArea @bind-Value="abrirDto.Observacao" class="form-control" />
        </div>

        <button class="btn btn-success" type="submit">Abrir Caixa</button>
    </EditForm>

    @* Registrar Retirada do Caixa appears only when caixa is open *@

    
}
else
{
    <div class="alert alert-info">
        Caixa aberto em: <strong>@caixaAberto.DataAbertura.ToString("g")</strong><br />
        Valor de Abertura: R$ @caixaAberto.ValorAbertura
    </div>

    <EditForm Model="@fecharDto" OnValidSubmit="FecharCaixa">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Valor de Fechamento (somente Dinheiro):</label>
            <InputNumber @bind-Value="fecharDto.ValorFechamento" class="form-control" />
        </div>

        <div class="mb-3">
            <label>Observação (total de vendas / nome):</label>
            <InputTextArea @bind-Value="fecharDto.Observacao" class="form-control" />
        </div>

        <button class="btn btn-danger" type="submit">Fechar Caixa</button>
    </EditForm>
}

@if (!string.IsNullOrEmpty(mensagem))
{
    <p class="mt-3 alert alert-warning">@mensagem</p>
}

@if (caixas is not null && caixas.Any())
{
    <h4 class="mt-5">Histórico de Caixas</h4>

    <table class="table table-bordered mt-3">
        <thead>
            <tr>
                <th>Abertura</th>
                <th>Fechamento</th>
                <th>Valor Abertura</th>
                <th>Valor Fechamento</th>
                <th>Observação</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var caixa in caixas.OrderByDescending(c => c.DataAbertura))
            {
                <tr>
                    <td>@caixa.DataAbertura.ToString("g")</td>
                    <td>@(caixa.DataFechamento?.ToString("g") ?? "-")</td>
                    <td>R$ @caixa.ValorAbertura.ToString("F2")</td>
                    <td>@(caixa.ValorFechamento.HasValue ? $"R$ {caixa.ValorFechamento.Value:F2}" : "-")</td>
                    <td>@caixa.Observacao</td>
                </tr>
            }
        </tbody>
    </table>
}


@code {
    private AbrirCaixaDto abrirDto = new();
    private FecharCaixaDto fecharDto = new();
    private Caixa caixaAberto;
    private List<Caixa> caixas = new();
    private string mensagem;
    private bool carregando = true;

    // current caixa computed value
    private decimal currentCaixa = 0m;
    // when caixa is closed, preserve last closed value until next open
    private decimal lastClosedCaixaValue = 0m;

    // retirada fields
    private decimal retiradaValor = 0m;
    private string retiradaDescricao = string.Empty;
    private bool isRegistrandoRetirada = false;
    private string retiradaMensagem = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var nome = await JS.InvokeAsync<string>("sessionStorage.getItem", "Email");

        if (string.IsNullOrEmpty(nome))
        {
            Navigation.NavigateTo("login");
        }
        await CarregarStatusCaixa();
    }

    private async Task CarregarStatusCaixa()
    {
        try
        {
            var (resultado, errorMessage) = await _apiService.ListarCaixasAsync();

            if (resultado is not null)
            {
                caixas = resultado;
                caixaAberto = caixas.FirstOrDefault(c => c.DataFechamento == null);
                if (caixaAberto == null)
                {
                    // no open caixa: keep last closed value for display
                    var lastClosed = caixas.OrderByDescending(c => c.DataAbertura).FirstOrDefault(c => c.DataFechamento != null);
                    if (lastClosed != null && lastClosed.ValorFechamento.HasValue)
                    {
                        lastClosedCaixaValue = lastClosed.ValorFechamento.Value;
                        currentCaixa = lastClosedCaixaValue;
                    }
                }
                else
                {
                    // when there is an open caixa, prefill the fecharDto with current caixa value (will be updated after ComputeCurrentCaixaAsync)
                    fecharDto.ValorFechamento = caixaAberto.ValorAbertura;
                }
            }

            carregando = false;
            // compute current caixa value after loading only if there's an open caixa
            if (caixaAberto != null)
            {
                await ComputeCurrentCaixaAsync();
            }
        }
        catch (Exception ex)
        {
            mensagem = $"Erro ao carregar: {ex.Message}";
        }
    }

    private async Task ComputeCurrentCaixaAsync()
    {
        // default to zero
        currentCaixa = 0m;
        try
        {
            if (caixaAberto == null) return;

            // start with abertura value
            currentCaixa = caixaAberto.ValorAbertura;

            // prefill fecharDto with the computed current caixa value
            fecharDto.ValorFechamento = currentCaixa;

            // fetch vendas em dinheiro desde a abertura
            var since = caixaAberto.DataAbertura;
            var sinceUtc = since.ToUniversalTime();
            (List<Pedido>? pedidos, string? err) = await _apiService.GetPedidosPorData(since.Date);
            if (pedidos != null)
            {
                // include only pedidos after abertura time
                var vendasEmDinheiro = pedidos
                    .Where(p => p.DataPedido.HasValue && p.DataPedido.Value >= since)
                    .Where(p => string.Equals(p.FormaPagamento, "Dinheiro", StringComparison.OrdinalIgnoreCase) || string.Equals(p.FormaPagamento2, "Dinheiro", StringComparison.OrdinalIgnoreCase))
                    .Sum(p => p.ValorPago1 ?? 0m + (p.ValorPago2 ?? 0m));

                currentCaixa += vendasEmDinheiro;
            }

            // subtract previously recorded retiradas (Despesas categoria 'Caixa'?)
            (List<BlazorDeploy.Models.Despesas>? despesas, string? dex) = await _apiService.GetDespesasAsync();
            if (despesas != null)
            {
                // allow small clock skew: include despesas a few seconds before abertura
                var sinceCutoffUtc = sinceUtc.AddSeconds(-10);
                var retiradas = despesas
                    .Where(d => (d.Data.ToUniversalTime() >= sinceCutoffUtc)
                                && string.Equals(d.Categoria, "Caixa", StringComparison.OrdinalIgnoreCase)
                                && string.Equals(d.FormaPagamento, "Dinheiro", StringComparison.OrdinalIgnoreCase))
                    .Sum(d => d.Valor);

                // subtract only cash-form despesas since caixa opening
                currentCaixa -= retiradas;
            }
            // after final calculation, update the fechar DTO so input shows the current caixa
            fecharDto.ValorFechamento = currentCaixa;
            StateHasChanged();
        }
        catch { }
    }

    private void LimparRetirada()
    {
        retiradaValor = 0m;
        retiradaDescricao = string.Empty;
        retiradaMensagem = string.Empty;
    }

    private async Task RegistrarRetiradaAsync()
    {
        if (caixaAberto == null)
        {
            retiradaMensagem = "Nenhum caixa aberto.";
            return;
        }

        if (retiradaValor <= 0)
        {
            retiradaMensagem = "Informe um valor válido.";
            return;
        }

        isRegistrandoRetirada = true;
        try
        {
            var desp = new BlazorDeploy.Models.Despesas
            {
                Data = DateTime.Now,
                Descricao = retiradaDescricao ?? "Retirada de caixa",
                Categoria = "Caixa",
                FormaPagamento = "Dinheiro",
                Valor = retiradaValor,
                Parcelas = 1,
                Observacao = retiradaDescricao
            };

                var res = await _apiService.AdicionarDespesaAsync(desp);
            if (res.Data)
            {
                retiradaMensagem = "Retirada registrada com sucesso.";
                // reload server state so despesas are reflected in computation
                await Task.Delay(200);
                await CarregarStatusCaixa();
                StateHasChanged();
                LimparRetirada();
            }
            else
            {
                retiradaMensagem = "Falha ao registrar retirada: " + res.ErrorMessage;
            }
        }
        catch (Exception ex)
        {
            retiradaMensagem = "Erro: " + ex.Message;
        }
        finally
        {
            isRegistrandoRetirada = false;
        }
    }

    private async Task AbrirCaixa()
    {
        try
        {
            var caixa = await _apiService.AbrirCaixaAsync(abrirDto);
            mensagem = $"Caixa aberto com sucesso!";
            abrirDto = new(); // limpa o form
            await CarregarStatusCaixa();
        }
        catch (Exception ex)
        {
            mensagem = $"Erro ao abrir caixa: {ex.Message}";
        }
    }

    private async Task FecharCaixa()
    {
        try
        {
            await _apiService.FecharCaixaAsync(caixaAberto.Id, fecharDto);
            mensagem = "Caixa fechado com sucesso!";
            // preserve the last closed value locally so UI shows it until next open
            lastClosedCaixaValue = fecharDto.ValorFechamento;
            fecharDto = new();
            caixaAberto = null;
            // reload status (this will not overwrite currentCaixa because no open caixa exists)
            await CarregarStatusCaixa();
        }
        catch (Exception ex)
        {
            mensagem = $"Erro ao fechar caixa: {ex.Message}";
        }
    }
}
