@page "/cardapio"
@layout CardapioLayout
@inject ApiService _apiService
@inject IJSRuntime JS
@inject IValidator Validator

<div class="text-center mt-4">
<img src="/logo.jpg" class="img-fluid rounded-circle" style="max-height: 90px; object-fit: contain;" />
</div>
@if (todosProdutos == null)
{
    <p>Carregando...</p>
}
else
{
    <!-- Barra de categorias rolável -->
<div class="d-flex overflow-auto mb-3 gap-3 px-2 py-1 border-bottom" style="white-space: nowrap;">
    @foreach (var categoria in categorias)
    {
        <div class="text-center flex-shrink-0" style="width: 80px; cursor: pointer;" @onclick="() => SelecionarCategoria(categoria.Id)">
            <img src="@categoria.CaminhoImagem" class="rounded-circle mb-1" style="width: 60px; height: 60px; object-fit: cover;" />
            <div style="font-size: 0.75rem; white-space: normal;">@categoria.Nome</div>
        </div>
    }

    <div class="text-center flex-shrink-0" style="width: 80px; cursor: pointer;" @onclick="() => SelecionarCategoria(null)">
        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mb-1" style="width: 60px; height: 60px;">
            📋
        </div>
        <div style="font-size: 0.75rem;">Todos</div>
    </div>
</div>

<!-- Campo de busca -->
<input type="text" class="form-control mb-3" placeholder="🔍 Buscar por nome..."
       @oninput="BuscarPorNome" />

<!-- Lista de produtos -->
@if (produtosFiltrados.Any())
{
    <div class="row">
        @foreach (var produto in ProdutosDisponiveisHoje)
        {
            <div class="col-6 col-md-4 mb-3">
                <div class="card h-100 shadow-sm" style="font-size: 0.9rem;">
                    <div class="card-body text-center p-2">
                        <img src="@produto.CaminhoImagem" class="img-fluid mb-1" style="max-height: 50px; object-fit: contain;" />
                        <div class="fw-bold text-truncate" style="font-size: 0.85rem;" title="@produto.Nome">
                            @produto.Nome
                        </div>
                        <div class="text-success mb-1">R$ @produto.Preco.ToString("0.00")</div>
                        <button class="btn btn-sm btn-outline-success" @onclick="() => AdicionarAoCarrinho(produto)">Adicionar</button>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <p class="text-muted text-center">Nenhum produto encontrado.</p>
}


    <!-- Carrinho fixo no rodapé -->
<div class="carrinho-footer bg-success text-white text-center p-3" @onclick="ToggleCarrinho">
    🛒 Carrinho (@carrinho.Sum(c => c.Quantidade) itens)
</div>

<!-- Carrinho expandido -->
@if (carrinhoAberto)
{
    <div class="carrinho-expandido shadow-lg p-3 bg-white">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">🛒 Meu Carrinho</h5>
            <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleCarrinho">Fechar</button>
        </div>

        @if (!carrinho.Any())
        {
            <p>Seu carrinho está vazio.</p>
        }
        else
        {
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Qtd</th>
                        <th>Preço</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in carrinho)
                    {
                        <tr>
                            <td>@item.Produto.Nome</td>
                            <td>
                                <button class="btn btn-sm btn-light me-1" @onclick="() => Decrementar(item)">-</button>
                                @item.Quantidade
                                <button class="btn btn-sm btn-light ms-1" @onclick="() => Incrementar(item)">+</button>
                            </td>
                            <td>R$ @item.Produto.Preco</td>
                            <td><button class="btn btn-sm btn-danger" @onclick="() => Remover(item)">🗑</button></td>
                        </tr>
                    }
                </tbody>
            </table>

<!-- Forma de pagamento -->
<div class="mb-3">
    <label>Forma de pagamento</label>
    <select class="form-select" @bind="formaPagamento">
        <option value="">Selecione a Forma de Pagamento</option>
        <option value="Dinheiro">Dinheiro</option>
        <option value="Credito">Crédito</option>
        <option value="Debito">Débito</option>
        <option value="Pix">Pix</option>
    </select>
</div>

@if (formaPagamento == "Dinheiro")
{
    <div class="mb-3">
        <label>Troco Para:</label>
        <InputNumber @bind-Value="trocoPara" class="form-control" />
    </div>
}

<!-- Endereço -->
<div class="mb-3">
    <label>Endereço</label>
    <input class="form-control" @bind="endereco" @oninput="@(() => Validator.EnderecoErro = "")"/>
    @if (!string.IsNullOrEmpty(Validator.EnderecoErro))
    {
        <div class="text-danger">@Validator.EnderecoErro</div>
    }
</div>

<!-- Nome -->
<div class="mb-3">
    <label>Nome</label>
    <input class="form-control" @bind="nome" @oninput="@(() => Validator.NomeErro = "")"/>
    @if (!string.IsNullOrEmpty(Validator.NomeErro))
    {
        <div class="text-danger">@Validator.NomeErro</div>
    }
</div>

<!-- Telefone -->
<div class="mb-3">
    <label>Telefone</label>
    <input class="form-control" @bind="telefone" @oninput="@(() => Validator.TelefoneErro = "")"/>
    @if (!string.IsNullOrEmpty(Validator.TelefoneErro))
    {
        <div class="text-danger">@Validator.TelefoneErro</div>
    }
</div>

<h5 class="text-end">Total: R$ @carrinho.Sum(i => i.Produto.Preco * i.Quantidade):F2</h5>

<button class="btn btn-success w-100"
        @onclick="EnviarPedido"
        disabled="@(!carrinho.Any() || string.IsNullOrEmpty(formaPagamento) || isProcessing ||
                (formaPagamento == "Dinheiro" && trocoPara < carrinho.Sum(p => p.Preco * p.ValorTotal)))">
    Finalizar Pedido
</button>

        }
    </div>
}



    @code {
    private List<CarrinhoCompraItem> carrinho = new();
    private string mensagem;
    private bool carrinhoAberto = false;
    private string formaPagamento = "";
    private string endereco = "";
    private string nome = "";
    private string telefone = "";
    private bool isProcessing = false;
    private List<Categoria> categorias = new();
    private List<Produto> todosProdutos = new();
    private List<Produto> produtosFiltrados = new();
    private List<Produto> ProdutosDisponiveisHoje => produtosFiltrados.Where(produto =>
    string.Equals(produto.DiasDisponiveis, "Todos", StringComparison.OrdinalIgnoreCase) ||
    produto.DiasDisponiveis?
        .Split(',', StringSplitOptions.RemoveEmptyEntries)
        .Select(d => Enum.Parse<DayOfWeek>(d.Trim()))
        .Contains(DateTime.Today.DayOfWeek) == true
).ToList();

    private int? categoriaSelecionadaId = null;
    private string filtroNome = string.Empty;
    private decimal trocoPara = 0;


    protected override async Task OnInitializedAsync()
    {
        var (catResult, catError) = await _apiService.GetCategorias();
        var (prodResult, prodError) = await _apiService.GetTodosProdutos();

        if (catResult != null) categorias = catResult;
        if (prodResult != null) todosProdutos = prodResult;

        AplicarFiltros();
    }



    private void ToggleCarrinho()
    {
        carrinhoAberto = !carrinhoAberto;
    }

    private void AdicionarAoCarrinho(Produto produto)
    {
        var existente = carrinho.FirstOrDefault(p => p.Produto.Id == produto.Id);
        if (existente != null)
        {
            existente.Quantidade++;
        }
        else
        {
            carrinho.Add(new CarrinhoCompraItem { Produto = produto, Quantidade = 1 });
        }
    }

    private void Incrementar(CarrinhoCompraItem item) => item.Quantidade++;
    private void Decrementar(CarrinhoCompraItem item)
    {
        item.Quantidade--;
        if (item.Quantidade <= 0)
            carrinho.Remove(item);
    }

    private void Remover(CarrinhoCompraItem item) => carrinho.Remove(item);

    private async Task EnviarPedido()
    {
        if (isProcessing)
            return;

        isProcessing = true;

    var isValido = await Validator.ValidarCliente(nome, telefone, endereco); // só usa os campos necessários

    if (!isValido)
    {
        ShowAlert("Por favor, corrija os erros antes de continuar.");
        isProcessing = false;
        return;
    }

        if (!carrinho.Any())
        {
            ShowAlert("Seu carrinho está vazio.");
            return;
        }

        var preComanda = carrinho
                        .Select(i => new CarrinhoCompraItem
                        {
                            Preco = i.Produto.Preco,
                            ProdutoId = i.Produto.Id,
                            ProdutoNome = i.Produto.Nome,
                            UrlImagem = i.Produto.CaminhoImagem,
                            Quantidade = i.Quantidade,
                            ValorTotal = i.Produto.Preco * i.Quantidade
                        })
                        .ToList();

        var comanda = new Comanda
        {
            DataAbertura = DateTime.Now,
            Nome = nome,
            Telefone = telefone,
            Endereco = endereco,
            ValorTotal = carrinho.Sum(i => i.Produto.Preco * i.Quantidade),
            FormaPagamento = formaPagamento,
            Status = "Aguardando Impressao",
            ValorRecebido = trocoPara,
            Itens = preComanda.Select(i => new ItemComanda
            {
                Nome = nome,
                ProdutoId = i.ProdutoId,
                NomeProduto = i.ProdutoNome,
                PrecoUnitario = i.Preco,
                Quantidade = i.Quantidade,
                UrlImagem = i.UrlImagem
            }).ToList()
        };


        var responseComanda = await _apiService.CriarComanda(comanda);
   
        if (responseComanda.Data != null)
        {
           ShowAlert("Pedido enviado com sucesso!");
            carrinho.Clear();
            nome = "";
            endereco = "";
            telefone = "";
            formaPagamento = "";
            StateHasChanged(); // Atualiza a UI
        }
        else
        
        {
            ShowAlert("Erro ao enviar pedido.");
        }
         isProcessing = false;

    }

    private void SelecionarCategoria(int? categoriaId)
{
    categoriaSelecionadaId = categoriaId;
    AplicarFiltros();
}

private void FiltrarProdutosPorNome(ChangeEventArgs e)
{
    filtroNome = e?.Value?.ToString() ?? string.Empty;
    AplicarFiltros();
}

private void BuscarPorNome(ChangeEventArgs e)
{
    filtroNome = e.Value?.ToString() ?? string.Empty;
    AplicarFiltros();
}

private void AplicarFiltros()
{
    if (!categoriaSelecionadaId.HasValue && string.IsNullOrWhiteSpace(filtroNome))
    {
        // Exibe os produtos mais populares por padrão (ex: top 10 mais vendidos ou aleatórios)
        produtosFiltrados = todosProdutos
            .OrderByDescending(p => p.Popular) // ou outro critério
            .Take(10)
            .ToList();
    }
    else
    {
        produtosFiltrados = todosProdutos
            .Where(p =>
                (!categoriaSelecionadaId.HasValue || p.CategoriaId == categoriaSelecionadaId.Value) &&
                (string.IsNullOrWhiteSpace(filtroNome) || p.Nome.Contains(filtroNome, StringComparison.OrdinalIgnoreCase)))
            .ToList();
    }
}



    private async Task ShowAlert(string message)
    {
        await JS.InvokeVoidAsync("alert", message);
    }
}


}