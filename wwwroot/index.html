<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rota019</title>
    <base href="/" />

    <!-- ✅ Bootstrap via CDN (sem arquivos locais) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Seu CSS e manifestos -->
    <link href="css/app.css" rel="stylesheet" />
    <link href="BlazorDeploy.styles.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="logo.png" />
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="apple-touch-icon" sizes="512x512" href="logo.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="logo.png" />

    <!-- Google Places API (load dynamically with error capture). Skip on iOS to avoid blocking issues there. -->
    <script>
        (function(){
            try {
                var isIOS = false;
                try {
                    var platform = navigator.platform || '';
                    var ua = navigator.userAgent || '';
                    if (/iP(hone|od|ad)/i.test(platform)) isIOS = true;
                    if (platform === 'MacIntel' && navigator.maxTouchPoints && navigator.maxTouchPoints > 1) isIOS = true;
                    if (/iP(hone|od|ad)/i.test(ua)) isIOS = true;
                } catch(e) { }

                if (isIOS) {
                    console.warn('Skipping Google Places script load on iOS to avoid CORS/initialization issues');
                    return;
                }

                // load Google Maps API async with error handler
                var gmapsScript = document.createElement('script');
                gmapsScript.async = true;
                gmapsScript.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBy_9neF5tiB38rjc9FiZjbP7H13JS-OZI&libraries=places&v=weekly&region=BR&language=pt-BR&components=element';
                gmapsScript.onload = function(){ try{ console.log('Google Maps script loaded'); }catch{} };
                gmapsScript.onerror = function(ev){ try{ sessionStorage.setItem('lastClientError', JSON.stringify({ message: 'Failed to load Google Maps script', detail: String(ev), time: new Date().toISOString() })); }catch{} };
                document.head.appendChild(gmapsScript);

                // load Places widget module via jsDelivr as module
                var widgetScript = document.createElement('script');
                widgetScript.type = 'module';
                widgetScript.crossOrigin = 'anonymous';
                widgetScript.src = 'https://cdn.jsdelivr.net/npm/@googlemaps/places-widget-element/dist/places-widget-element.js';
                widgetScript.onerror = function(ev){ try{ sessionStorage.setItem('lastClientError', JSON.stringify({ message: 'Failed to load places-widget module', detail: String(ev), time: new Date().toISOString() })); }catch{} };
                document.head.appendChild(widgetScript);
            } catch(e) { try{ sessionStorage.setItem('lastClientError', JSON.stringify({ message: 'places loader exception', detail: e && e.message ? e.message : String(e), time: new Date().toISOString() })); }catch{} }
        })();
    </script>
    <script src="js/autocomplete.js"></script>
    <script src="js/triggerFileInput.js"></script>
    <script src="js/barcodeScanner.js"></script>
    <script src="js/layout-utils.js"></script>


</head>


<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>
    <script src="_framework/blazor.webassembly.js"></script>

    <script>
        // keyHandler: expose F1 handler that calls .NET OnF1Key via DotNetObjectReference
        (function () {
            var dotNetRefF1 = null;
            function f1Handler(e) {
                try {
                    if (e.key === 'F1') {
                        e.preventDefault();
                        if (dotNetRefF1) {
                            try { dotNetRefF1.invokeMethodAsync('OnF1Key'); } catch (ex) { }
                        }
                    }
                } catch (ex) { }
            }

            window.keyHandler = {
                addF1Handler: function (dref) {
                    try {
                        dotNetRefF1 = dref;
                        window.addEventListener('keydown', f1Handler);
                    } catch (e) { }
                },
                removeF1Handler: function () {
                    try {
                        window.removeEventListener('keydown', f1Handler);
                        dotNetRefF1 = null;
                    } catch (e) { }
                }
            };
        })();

        // Global ESC handler registration for Blazor pages
        (function () {
            var dotRef = null;
            
            // Log when handler is set up
            console.log('[JS] Global ESC handler module loaded at:', new Date().toISOString());
            console.log('[JS] Document state:', document.readyState);
            
            function onKeyDown(e) {
                // Log EVERY keypress for debugging (can be removed later)
                console.log('[JS] Key pressed:', e.key, 'dotRef:', dotRef ? 'valid' : 'NULL');
                
                // Log every keypress for debugging
                if (e.key === 'Escape') {
                    console.log('[JS] ESC key pressed');
                }
                
                try {
                    // For ESC key, ALWAYS call C# first and let it decide what to do
                    if (e.key === 'Escape') {
                        console.log('[JS] ESC pressed - calling C# to handle it');
                        e.preventDefault();
                        e.stopPropagation();
                        
                        if (dotRef) {
                            try { 
                                dotRef.invokeMethodAsync('OnEscapePressed'); 
                            } catch (ex) { 
                                console.error('[JS] Error calling OnEscapePressed:', ex);
                            }
                        } else {
                            console.warn('[JS] dotRef is null - cannot call C#');
                        }
                        return;
                    }
                } catch (ex) { 
                    console.error('[JS] ESC handler error:', ex);
                }

                try {
                    // Check if quantity modal is open - if so, handle temperature shortcuts regardless of focus
                    var quantityModal = document.querySelector('.modal.d-block');
                    var quantityInput = document.getElementById('quantity_input');
                    
                    if (quantityModal && quantityInput) {
                        // Modal is open - handle temperature shortcuts N, Q, G
                        var key = e.key ? e.key.toLowerCase() : '';
                        
                        if (key === 'n') {
                            e.preventDefault(); // prevent the 'n' from being typed in the input
                            if (dotRef) {
                                try { dotRef.invokeMethodAsync('OnTemperatureShortcut', null); } catch { }
                            }
                            return;
                        }
                        else if (key === 'q') {
                            e.preventDefault(); // prevent the 'q' from being typed in the input
                            if (dotRef) {
                                try { dotRef.invokeMethodAsync('OnTemperatureShortcut', 'Quente'); } catch { }
                            }
                            return;
                        }
                        else if (key === 'g') {
                            e.preventDefault(); // prevent the 'g' from being typed in the input
                            if (dotRef) {
                                try { dotRef.invokeMethodAsync('OnTemperatureShortcut', 'Gelada'); } catch { }
                            }
                            return;
                        }
                        
                        // Don't process other shortcuts while modal is open
                        return;
                    }
                } catch (ex) { 
                    console.error('Temperature shortcut error:', ex);
                }

                try {
                    // Check if user is typing in specific inputs where shortcuts should be blocked
                    var activeEl = document.activeElement;
                    var isTypingInBlockedInput = false;
                    
                    if (activeEl && activeEl.tagName) {
                        var tag = activeEl.tagName.toUpperCase();
                        var elId = activeEl.id || '';
                        var elPlaceholder = (activeEl.placeholder || '').toLowerCase();
                        
                        // Block shortcuts in textareas (product description in cart)
                        if (tag === 'TEXTAREA') {
                            isTypingInBlockedInput = true;
                        }
                        
                        // Block shortcuts in select elements
                        if (tag === 'SELECT' || tag === 'OPTION') {
                            isTypingInBlockedInput = true;
                        }
                        
                        // For inputs, check specific ones where shortcuts should be blocked
                        if (tag === 'INPUT') {
                            var inputType = (activeEl.type || '').toLowerCase();
                            var hasPaymentInputClass = activeEl.classList && activeEl.classList.contains('payment-input-shortcut');
                            
                            // ✅ SPECIAL: payment inputs (pag1_input, pag2_input) ALLOW shortcuts
                            if (hasPaymentInputClass || elId === 'pag1_input' || elId === 'pag2_input') {
                                // Allow shortcuts to work
                                isTypingInBlockedInput = false;
                                
                                // But prevent non-numeric keys from being typed
                                var key = e.key;
                                var isNumeric = (key >= '0' && key <= '9') || key === '.' || key === ',';
                                var isControl = key === 'Backspace' || key === 'Delete' || key === 'ArrowLeft' || key === 'ArrowRight' || key === 'Tab' || key === 'Enter' || key === 'Escape';
                                var isShortcut = key.length === 1 && /[a-z]/i.test(key); // any letter is a potential shortcut
                                
                                if (!isNumeric && !isControl && isShortcut) {
                                    // It's a letter shortcut - prevent it from being typed into the input
                                    e.preventDefault();
                                }
                                
                                // Don't block shortcut processing - continue to handle shortcuts below
                            }
                            // ✅ SPECIAL: searchInput allows NUMBER shortcuts (1-9) but blocks LETTER shortcuts
                            else if (elId === 'searchInput') {
                                // Block all letter shortcuts when typing in search input
                                // Only allow number shortcuts (1-9) for product selection
                                var key = e.key;
                                var isNumber = key.length === 1 && key >= '1' && key <= '9';
                                
                                if (!isNumber) {
                                    // Block letter shortcuts (vendedor, payment, status, etc)
                                    isTypingInBlockedInput = true;
                                }
                                // If it's a number (1-9), allow it to pass through for product selection
                            }
                            // ✅ Block in ALL cart table inputs (price, quantity, etc)
                            // Check if ID starts with price_ or qty_ (cart table inputs)
                            else if (elId.startsWith('price_') || elId.startsWith('qty_')) {
                                isTypingInBlockedInput = true;
                            }
                            // Block in client name input
                            else if (elPlaceholder.includes('nome do cliente')) {
                                isTypingInBlockedInput = true;
                            }
                            // Block in address input
                            else if (elPlaceholder.includes('endereço')) {
                                isTypingInBlockedInput = true;
                            }
                            // Block in phone input
                            else if (elPlaceholder.includes('telefone')) {
                                isTypingInBlockedInput = true;
                            }
                            // Block in observations input
                            else if (elPlaceholder.includes('observações') || elPlaceholder.includes('observacoes')) {
                                isTypingInBlockedInput = true;
                            }
                            // Block in vendedor name input (when "Outro" is selected)
                            else if (elPlaceholder.includes('digite o nome do vendedor')) {
                                isTypingInBlockedInput = true;
                            }
                            // ✅ Block in number inputs (type="number")
                            else if (inputType === 'number') {
                                isTypingInBlockedInput = true;
                            }
                            // ✅ Block in decimal inputs (inputmode="decimal")
                            else if (activeEl.inputMode === 'decimal' || activeEl.inputMode === 'numeric') {
                                isTypingInBlockedInput = true;
                            }
                            // Block in all text-type inputs (but allow radio/checkbox to work)
                            else if (inputType !== 'radio' && inputType !== 'checkbox') {
                                isTypingInBlockedInput = true;
                            }
                        }
                    }
                    
                    // Handle number keys 1-9 for product selection
                    // Works when NO input has focus OR when searchInput has focus
                    if (!isTypingInBlockedInput) {
                        var numKey = e.key;
                        if (numKey && numKey.length === 1 && numKey >= '1' && numKey <= '9') {
                            // Call .NET method to select product by index
                            if (dotRef) {
                                try { 
                                    dotRef.invokeMethodAsync('OnProductNumberShortcut', parseInt(numKey)); 
                                    console.log('Product number shortcut: ' + numKey);
                                } catch { }
                            }
                            return;
                        }
                    }
                    
                    // ✅ IMPORTANT: Allow letter shortcuts in searchInput AND payment inputs
                    // Block letter shortcuts only when typing in blocked inputs (cart table, cliente, observações, etc)
                    if (isTypingInBlockedInput) {
                        return; // Block all shortcuts when in blocked inputs
                    }
                } catch (ex) { }

                var key = e.key ? e.key.toLowerCase() : '';

                // Handle Enter key to finalize purchase (if button is visible)
                if (key === 'enter') {
                    // Check if we're NOT in an input that should handle Enter normally
                    var activeEl = document.activeElement;
                    var tag = activeEl ? activeEl.tagName.toUpperCase() : '';
                    
                    // Don't trigger finalize if typing in textarea or specific inputs
                    if (tag === 'TEXTAREA') return;
                    if (tag === 'INPUT') {
                        var inputType = (activeEl.type || '').toLowerCase();
                        // Allow Enter in text inputs (search, cliente, etc) - those have their own handlers
                        if (inputType === 'text' || inputType === 'date' || inputType === 'number') return;
                    }
                    
                    // Check if finalize button is visible - updated selector to match new button class
                    var finalizeBtn = document.querySelector('button.btn-success.btn-lg.w-100.mt-2');
                    if (!finalizeBtn) {
                        // Fallback to old selector for backwards compatibility
                        finalizeBtn = document.querySelector('button.btn-success.btn-lg.w-100.mt-3');
                    }
                    
                    if (finalizeBtn && finalizeBtn.textContent.includes('Finalizar Compra')) {
                        e.preventDefault();
                        if (dotRef) {
                            try { 
                                dotRef.invokeMethodAsync('OnEnterToFinalize');
                                console.log('[JS] Enter pressed - triggering finalize purchase');
                            } catch { }
                        }
                        return;
                    }
                }

                // Vendedor shortcuts: R=Ronaldo, N=Nathan, E=Carlinhos, V=Allan, S=Beatriz, K=Kayke
                if (key === 'r') {
                    if (dotRef) {
                        try { dotRef.invokeMethodAsync('OnVendedorShortcut', 'Ronaldo'); } catch { }
                    }
                    return;
                }
                // N is handled in modal for temperature, so only handle if modal is not open
                if (key === 'n' && !quantityModal) {
                    if (dotRef) {
                        try { dotRef.invokeMethodAsync('OnVendedorShortcut', 'Nathan'); } catch { }
                    }
                    return;
                }
                if (key === 'e') {
                    if (dotRef) {
                        try { dotRef.invokeMethodAsync('OnVendedorShortcut', 'Carlinhos'); } catch { }
                    }
                    return;
                }
                if (key === 'v') {
                    if (dotRef) {
                        try { dotRef.invokeMethodAsync('OnVendedorShortcut', 'Allan'); } catch { }
                    }
                    return;
                }
                if (key === 's') {
                    if (dotRef) {
                        try { dotRef.invokeMethodAsync('OnVendedorShortcut', 'Beatriz'); } catch { }
                    }
                    return;
                }
                if (key === 'k') {
                    if (dotRef) {
                        try { dotRef.invokeMethodAsync('OnVendedorShortcut', 'Kayke'); } catch { }
                    }
                    return;
                }

                // Status shortcuts: F=Finalizado, R=Retirada (conflicts with Ronaldo, R is already used)
                // Let's use F=Finalizado, T=reTirada (R already used for Ronaldo), M=eM entrega
                if (key === 'f') {
                    if (dotRef) {
                        try { dotRef.invokeMethodAsync('OnStatusShortcut', 'Finalizado'); } catch { }
                    }
                    return;
                }
                if (key === 't') {
                    if (dotRef) {
                        try { dotRef.invokeMethodAsync('OnStatusShortcut', 'Retirada'); } catch { }
                    }
                    return;
                }
                if (key === 'm') {
                    if (dotRef) {
                        try { dotRef.invokeMethodAsync('OnStatusShortcut', 'Em entrega'); } catch { }
                    }
                    return;
                }

                // Payment method shortcuts: D=Dinheiro, C=Credito, B=Debito, P=Pix, A=A Prazo
                if (key === 'd') {
                    if (dotRef) {
                        try { dotRef.invokeMethodAsync('OnPaymentShortcut', 'Dinheiro'); } catch { }
                    }
                    return;
                }
                if (key === 'c') {
                    if (dotRef) {
                        try { dotRef.invokeMethodAsync('OnPaymentShortcut', 'Credito'); } catch { }
                    }
                    return;
                }
                if (key === 'b') {
                    if (dotRef) {
                        try { dotRef.invokeMethodAsync('OnPaymentShortcut', 'Debito'); } catch { }
                    }
                    return;
                }
                if (key === 'p') {
                    if (dotRef) {
                        try { dotRef.invokeMethodAsync('OnPaymentShortcut', 'Pix'); } catch { }
                    }
                    return;
                }
                if (key === 'a') {
                    if (dotRef) {
                        try { dotRef.invokeMethodAsync('OnPaymentShortcut', 'A Prazo'); } catch { }
                    }
                    return;
                }

                // detect plus: main keyboard '+' (Shift+'='), Numpad add
                var isPlus = false;
                try {
                    if (e.key === '+') isPlus = true;
                    if (e.code === 'NumpadAdd') isPlus = true;
                    if (e.key === 'Add') isPlus = true;
                    if (e.key === '=' && e.shiftKey) isPlus = true;
                } catch (ex) { }

                if (isPlus && dotRef) {
                    try {
                        // prevent browser from inserting the '+' character into any focused input
                        try { e.preventDefault(); } catch (ex) { }
                        dotRef.invokeMethodAsync('OnPlusPressed');
                    } catch { }
                }
            }
            window.addGlobalEscHandler = function (dref) {
                console.log('[JS] addGlobalEscHandler called, dotRef:', dref ? 'VALID' : 'NULL');
                console.log('[JS] User Agent:', navigator.userAgent);
                console.log('[JS] Document ready state:', document.readyState);
                try {
                    dotRef = dref;
                    // Use capture phase (true) to catch ESC before it reaches inputs
                    window.addEventListener('keydown', onKeyDown, true);
                    console.log('[JS] ESC handler registered successfully (capture phase)');
                    
                    // Test log to confirm handler works
                    console.log('[JS] Keyboard shortcuts ready. Try pressing R, N, D, etc.');
                } catch (ex) { 
                    console.error('[JS] Error registering ESC handler:', ex);
                }
            };
            window.removeGlobalEscHandler = function () {
                console.log('[JS] removeGlobalEscHandler called');
                try {
                    window.removeEventListener('keydown', onKeyDown, true);
                    dotRef = null;
                    console.log('[JS] ESC handler removed');
                } catch (ex) { 
                    console.error('[JS] Error removing ESC handler:', ex);
                }
            };
        // helper to focus the last blank descricao textarea (prefer the most recently added)
        window.focusFirstBlankDescricao = function () {
            try {
                var els = document.querySelectorAll("textarea[placeholder='Descrição']");
                if (els && els.length) {
                    var el = els[els.length - 1];
                    // remove a leading '+' that may have been typed while adding the item
                    try {
                        if (el.value && el.value.length > 0 && el.value.charAt(0) === '+') {
                            el.value = el.value.replace(/^\+/, '');
                            // notify Blazor of the change
                            el.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    } catch (e) { }
                    el.focus();
                    try { el.scrollIntoView({ block: 'center', behavior: 'smooth' }); } catch (e) { }
                }
            } catch (e) { }
        };
        })();

        // Numeric keypad implementation removed for iOS compatibility.
        // Provide a safe no-op shim so any remaining calls from components or global handlers do not fail.
        window.numericKeypad = window.numericKeypad || {
            _target: null,
            show: function (elementId) { try { /* no-op */ } catch (e) { } },
            hide: function () { try { /* no-op */ } catch (e) { } },
            insert: function (elementId, ch) { try { /* no-op */ } catch (e) { } },
            backspace: function (elementId) { try { /* no-op */ } catch (e) { } },
            commit: function (elementId) { try { /* no-op */ } catch (e) { } }
        };
    </script>

    <script>
        // Global client-side error capture to help diagnose white-screen issues on mobile.
        // Stores a short JSON with message and stack into sessionStorage key 'lastClientError'.
        (function () {
            function saveError(obj) {
                try {
                    var payload = {
                        message: obj && obj.message ? obj.message : (obj && obj.reason ? String(obj.reason) : String(obj)),
                        stack: obj && obj.stack ? obj.stack : (obj && obj.reason && obj.reason.stack ? obj.reason.stack : null),
                        time: new Date().toISOString(),
                        userAgent: navigator.userAgent || null
                    };
                    try { console.error('Captured client error for diagnostics', payload); } catch (e) { }
                    sessionStorage.setItem('lastClientError', JSON.stringify(payload));
                } catch (e) { }
            }

            window.addEventListener('error', function (ev) {
                try { saveError({ message: ev.message, stack: ev.error && ev.error.stack ? ev.error.stack : null }); } catch (e) { }
            });

            window.addEventListener('unhandledrejection', function (ev) {
                try { saveError(ev.reason || ev); } catch (e) { }
            });

            // small helper to read last error from sessionStorage (callable from console)
            window.__getLastClientError = function () {
                try { return sessionStorage.getItem('lastClientError'); } catch (e) { return null; }
            };
        })();
    </script>

    <script>
        // If Blazor shows the built-in error UI (#blazor-error-ui) make it display our captured error details
        (function () {
            try {
                var raw = null;
                try { raw = sessionStorage.getItem('lastClientError'); } catch (e) { raw = null; }
                if (!raw) return;

                function escapeHtml(s) {
                    if (!s) return '';
                    return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                }

                function inject() {
                    try {
                        var el = document.getElementById('blazor-error-ui');
                        if (!el) return false;
                        el.style.display = 'block';
                        var parsed = null;
                        try { parsed = JSON.parse(raw); } catch { parsed = null; }
                        var message = parsed && parsed.message ? parsed.message : raw;
                        var stack = parsed && parsed.stack ? parsed.stack : null;
                        var content = '<div style="padding:0.5rem; max-height:50vh; overflow:auto;">'
                            + '<div style="font-weight:700; margin-bottom:6px;">Erro detectado (detalhes abaixo)</div>'
                            + '<pre style="white-space:pre-wrap; word-break:break-word; background:rgba(0,0,0,0.04); padding:8px; border-radius:4px;">' + escapeHtml(message) + '</pre>';
                        if (stack) content += '<pre style="white-space:pre-wrap; word-break:break-word; margin-top:6px; font-size:0.85rem; opacity:0.9;">' + escapeHtml(stack) + '</pre>';
                        content += '<div style="margin-top:8px; display:flex; gap:8px;"><button id="__copyBlazorError" class="btn btn-sm btn-light">Copiar</button><button id="__clearBlazorError" class="btn btn-sm btn-secondary">Fechar e limpar</button></div>';
                        content += '</div>';
                        el.innerHTML = content;
                        try {
                            var copy = document.getElementById('__copyBlazorError');
                            if (copy) copy.addEventListener('click', function () { try { navigator.clipboard.writeText(raw); } catch (e) { window.prompt('Copiar (Ctrl+C):', raw); } });
                            var clear = document.getElementById('__clearBlazorError');
                            if (clear) clear.addEventListener('click', function () { try { sessionStorage.removeItem('lastClientError'); } catch (e) { } try { el.style.display = 'none'; } catch (e) { } });
                        } catch { }
                        return true;
                    } catch { return false; }
                }

                if (!inject()) {
                    var mo = new MutationObserver(function () { if (inject()) mo.disconnect(); });
                    try { mo.observe(document.documentElement || document.body, { childList: true, subtree: true }); } catch { }
                }
            } catch (e) { }
        })();
    </script>

    <script>
        // Register service worker only when supported. Skip registration on iOS
        // because some iOS/Safari combinations have caused issues with service
        // workers (older WKWebView or limited support). Wrap in try/catch to avoid
        // breaking the app on browsers that reject registration.
        try {
            // Detect iOS / iPadOS reliably: check platform and fallback to UA.
            var isIOS = (function () {
                try {
                    var platform = navigator.platform || '';
                    var ua = navigator.userAgent || '';
                    if (/iP(hone|od|ad)/i.test(platform)) return true;
                    // iPadOS 13+ reports as MacIntel but has touch support
                    if (platform === 'MacIntel' && navigator.maxTouchPoints && navigator.maxTouchPoints > 1) return true;
                    if (/iP(hone|od|ad)/i.test(ua)) return true;
                } catch (ex) { }
                return false;
            })();

            if (isIOS) {
                console.warn('Service worker registration skipped on iOS.');
            }
            else if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js').catch(function (err) {
                    console.warn('Service worker registration failed:', err);
                });
            }
        } catch (e) {
            console.warn('Service worker registration error:', e);
        }
    </script>

    <script>
        // If an error was captured earlier (before Blazor boot), show a small overlay
        // so users on mobile (iPhone) can read the diagnostic without devtools.
        (function () {
            try {
                var raw = null;
                try { raw = sessionStorage.getItem('lastClientError'); } catch (e) { raw = null; }
                if (!raw) return;
                var data = null;
                try { data = JSON.parse(raw); } catch (e) { data = { message: raw }; }

                var overlay = document.createElement('div');
                overlay.id = '__clientErrorOverlay';
                overlay.style.position = 'fixed';
                overlay.style.left = '8px';
                overlay.style.right = '8px';
                overlay.style.top = '8px';
                overlay.style.zIndex = '2147483647';
                overlay.style.background = 'rgba(0,0,0,0.85)';
                overlay.style.color = '#fff';
                overlay.style.padding = '12px';
                overlay.style.borderRadius = '8px';
                overlay.style.fontSize = '0.9rem';
                overlay.style.maxHeight = '60vh';
                overlay.style.overflow = 'auto';
                overlay.style.boxShadow = '0 6px 20px rgba(0,0,0,0.5)';

                var title = document.createElement('div');
                title.style.fontWeight = '700';
                title.style.marginBottom = '6px';
                title.innerText = 'Erro no cliente (diagnóstico)';
                overlay.appendChild(title);

                var msg = document.createElement('div');
                msg.style.whiteSpace = 'pre-wrap';
                msg.style.wordBreak = 'break-word';
                msg.innerText = (data && data.message) ? data.message : String(raw);
                overlay.appendChild(msg);

                if (data && data.stack) {
                    var stack = document.createElement('div');
                    stack.style.marginTop = '8px';
                    stack.style.opacity = '0.9';
                    stack.style.fontSize = '0.8rem';
                    stack.style.whiteSpace = 'pre-wrap';
                    stack.innerText = data.stack;
                    overlay.appendChild(stack);
                }

                var buttons = document.createElement('div');
                buttons.style.display = 'flex';
                buttons.style.gap = '8px';
                buttons.style.marginTop = '8px';

                var copyBtn = document.createElement('button');
                copyBtn.innerText = 'Copiar erro';
                copyBtn.className = 'btn btn-sm btn-light';
                copyBtn.onclick = function () {
                    try {
                        var toCopy = raw;
                        navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(toCopy) : window.prompt('Copiar (Ctrl+C)', toCopy);
                    } catch (e) { }
                };
                buttons.appendChild(copyBtn);

                var clearBtn = document.createElement('button');
                clearBtn.innerText = 'Fechar e limpar';
                clearBtn.className = 'btn btn-sm btn-secondary';
                clearBtn.onclick = function () {
                    try { sessionStorage.removeItem('lastClientError'); } catch (e) { }
                    try { overlay.remove(); } catch (e) { }
                };
                buttons.appendChild(clearBtn);

                overlay.appendChild(buttons);

                // inject bootstrap styles if available fallback to inline simple styles
                try { document.body.appendChild(overlay); } catch (e) { }
            } catch (e) { }
        })();
    </script>
</body>

</html>
