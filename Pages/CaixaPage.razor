@page "/"
@inject ApiService _apiService
@inject AuthService AuthService
@inject IJSRuntime JS
@inject IValidator Validator
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web

@inject NavigationManager Navigation

<PageTitle>Caixa</PageTitle>

@* compact vendor + client inputs shown at bottom (rendered near cart) *@


    <div class="card shadow-sm p-3 mb-4 bg-dark text-white">
    <h4 class="fw-bold text-white">Produtos</h4>

    <div class="row g-3 mb-3">
        <div class="col-12">
            <input class="form-control form-control-lg"
                   placeholder="Pesquisar por nome ou código de barras"
                   value="@searchTerm"
                   @oninput="@(e => { searchTerm = e?.Value?.ToString() ?? string.Empty; _ = SearchProducts(e); })"
                   @onkeyup="OnSearchKeyUp" />
            <div class="mt-2">
                <button class="btn btn-outline-primary mt-2 me-2" @onclick="OpenScanner">Abrir Leitor (câmera)</button>
                <button class="btn btn-outline-secondary mt-2" @onclick="OpenNativeScanner">Abrir Leitor (app)</button>
            </div>
        </div>
    </div>

    @if (showProductList)
    {
        <div style="max-height: 480px; overflow-y: auto;">
            <div class="row row-cols-2 row-cols-sm-3 row-cols-md-6 g-2">
                @foreach (var Produto in filteredProdutos)
                {
                    <div class="col">
                        <div class="card h-100 shadow-sm small" @onclick="() => OpenQuantityModal(Produto)" style="cursor:pointer;">
                            @if (!string.IsNullOrEmpty(Produto.CaminhoImagem))
                            {
                                <div style="height:72px; overflow:hidden; background:#f8f9fa;">
                            <img loading="lazy" src="@Produto.CaminhoImagem" onerror="this.onerror=null;this.src='/logo.png'" alt="@Produto.Nome" style="width:100%; height:100%; object-fit:cover; display:block;" />
                                </div>
                            }

                               else
                            {
                                <div class="d-flex align-items-center justify-content-center" style="height:72px; background:#f8f9fa;">
                                    <span class="text-muted small">Sem imagem</span>
                                </div>
                            }

                            <div class="card-body p-1 d-flex flex-column">
                                <div class="card-title mb-1" title="@Produto.Nome" style="font-size:0.85rem;">@Produto.Nome</div>
                                @if (!string.IsNullOrWhiteSpace(Produto.Detalhe))
                                {
                                    <div class="card-text small text-muted" style="white-space:normal;">@Produto.Detalhe</div>
                                }
                                <div class="text-success mb-1 mt-2" style="font-size:0.75rem;">R$ @(GetProdutoDisplayPrice(Produto).ToString("0.00"))</div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>
@* create-from-barcode modal *@
@if (showCreateProductModal)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block">
        <div class="modal-dialog modal-md mt-5">
            <div class="modal-content p-4 shadow-lg">
                <h5 class="fw-bold text-center">Cadastrar Produto (código: @newProductForBarcode.Barcode)</h5>

                <div class="mb-3">
                    <label class="form-label">Nome</label>
                    <input class="form-control" @bind="newProductForBarcode.Nome" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Preço (padrão)</label>
                    <input type="number" step="0.01" class="form-control" @bind="newProductForBarcode.Preco" />
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Preço Quente (opcional)</label>
                        <input type="number" step="0.01" class="form-control" @bind="newProductForBarcode.PrecoQuente" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Preço Gelada (opcional)</label>
                        <input type="number" step="0.01" class="form-control" @bind="newProductForBarcode.PrecoGelada" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Preço Custo (opcional)</label>
                        <input type="number" step="0.01" class="form-control" @bind="newProductForBarcode.PrecoCusto" />
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-3">
                    <button class="btn btn-secondary btn-lg" @onclick="CancelCreateProduct">Cancelar</button>
                    <button class="btn btn-primary btn-lg" @onclick="CreateProductFromBarcode">Cadastrar e Adicionar</button>
                </div>
            </div>
        </div>
    </div>
}


<div class="card shadow-sm p-3 mb-4 bg-dark text-white">
    <h4 class="fw-bold text-white">Carrinho</h4>

    <table class="table table-bordered table-striped align-middle mt-2">
        <thead class="table-dark">
            <tr>
                <th>Produto</th>
                <th>Unit.</th>
                <th>Qtd</th>
                <th>Total</th>
                <th class="text-center">
                    <button class="btn btn-success btn-sm" title="Adicionar item livre" @onclick="AddBlankCartItem">+</button>
                </th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in cart)
            {
                <tr>
                    <td>
                        @if (item.Produto == null || item.Produto.Id == 0)
                        {
                            <input class="form-control form-control-sm" placeholder="Descrição" @bind="item.Produto.Nome" />
                        }
                        else
                        {
                            <span class="fw-bold">@item.Produto.Nome</span>
                        }
                    </td>

                    <td>
                        <input type="number" min="0" step="0.01"
                               class="form-control form-control-sm text-end"
                               @bind="item.PrecoUnitario" @bind:after="UpdateCartTotals" />
                    </td>

                    <td>
                        <input type="number" min="1"
                               class="form-control form-control-sm text-center"
                               @bind="item.Quantidade" @bind:after="UpdateCartTotals" />
                    </td>

                    <td class="fw-bold">R$ @item.Total.ToString("0.00")</td>

                    <td>
                        <button class="btn btn-danger btn-sm"
                                @onclick="@(() => RemoveFromCart(item))">
                            X
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <h3 class="text-end mt-3 fw-bold">
        Total: R$ @cart.Sum(p => p.Total).ToString("0.00")
    </h3>

    <div class="row g-2 align-items-start">
        <div class="col-md-6">
            <label class="form-label fw-bold">Forma de Pagamento</label>
            <div class="d-flex">
                <div class="me-3">
                    <div class="form-check d-flex flex-column">
                        <div class="mb-2">
                            <input class="form-check-input" type="radio" name="pag1" value="Dinheiro" checked='@(formaPagamentoSelecionada == "Dinheiro")' @onclick='() => formaPagamentoSelecionada = "Dinheiro"' />
                            <label class="form-check-label ms-2">Dinheiro</label>
                        </div>
                        <div class="mb-2">
                            <input class="form-check-input" type="radio" name="pag1" value="Credito" checked='@(formaPagamentoSelecionada == "Credito")' @onclick='() => formaPagamentoSelecionada = "Credito"' />
                            <label class="form-check-label ms-2">Crédito</label>
                        </div>
                        <div class="mb-2">
                            <input class="form-check-input" type="radio" name="pag1" value="Debito" checked='@(formaPagamentoSelecionada == "Debito")' @onclick='() => formaPagamentoSelecionada = "Debito"' />
                            <label class="form-check-label ms-2">Débito</label>
                        </div>
                        <div class="mb-2">
                            <input class="form-check-input" type="radio" name="pag1" value="Pix" checked='@(formaPagamentoSelecionada == "Pix")' @onclick='() => formaPagamentoSelecionada = "Pix"' />
                            <label class="form-check-label ms-2">Pix</label>
                        </div>
                        <div class="mb-2">
                            <input class="form-check-input" type="radio" name="pag1" value="A Prazo" checked='@(formaPagamentoSelecionada == "A Prazo")' @onclick='() => formaPagamentoSelecionada = "A Prazo"' />
                            <label class="form-check-label ms-2">A Prazo</label>
                        </div>
                    </div>
                </div>
                <div class="flex-fill">
                    <label class="form-label">Valor (principal)</label>
                    <input type="number" step="1.00" class="form-control" style="max-width:220px;" placeholder="Valor" @bind="pagamento1" @bind:after="RecalculateSecondary" />
                    <div class="col-md-6">
                        @if (formaPagamentoSelecionada == "Dinheiro")
                        {
                            <div>
                                <p class="mt-2 fs-5">
                                    Troco: <strong>R$ @trocoDinheiro.ToString("0.00")</strong>
                                </p>
                            </div>
                        }
                    </div>

                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" id="usar_pag2" @bind="UsarPagamento2" @bind:after="() => { RecalculateSecondary(); }" />
                        <label class="form-check-label ms-2" for="usar_pag2">Adicionar forma de pagamento 2</label>
                    </div>
                </div>
            </div>
        </div>

        @* Data pagamento pra "A Prazo" *@
        @if (formaPagamentoSelecionada == "A Prazo")
        {
            <div class="mt-2">
                <label class="fw-bold">Data de Pagamento (prazo)</label>
                <InputDate @bind-Value="dataPagamentoPrazo" class="form-control w-auto" />
            </div>
        }

        
        @if (UsarPagamento2)
        {
            <div class="col-12 mt-2">
                <label class="form-label fw-bold">Forma de Pagamento 2 (opcional)</label>
                <div>
                    <div class="form-check d-flex flex-column">
                        <div class="mb-2">
                            <input class="form-check-input" type="radio" name="pag2" value="Credito" checked='@(formaPagamento2 == "Credito")' @onclick='() => formaPagamento2 = "Credito"' />
                            <label class="form-check-label ms-2">Crédito</label>
                        </div>
                        <div class="mb-2">
                            <input class="form-check-input" type="radio" name="pag2" value="Debito" checked='@(formaPagamento2 == "Debito")' @onclick='() => formaPagamento2 = "Debito"' />
                            <label class="form-check-label ms-2">Débito</label>
                        </div>
                        <div class="mb-2">
                            <input class="form-check-input" type="radio" name="pag2" value="Pix" checked='@(formaPagamento2 == "Pix")' @onclick='() => formaPagamento2 = "Pix"' />
                            <label class="form-check-label ms-2">Pix</label>
                        </div>
                        <div class="mb-2">
                            <input class="form-check-input" type="radio" name="pag2" value="A Prazo" checked='@(formaPagamento2 == "A Prazo")' @onclick='() => formaPagamento2 = "A Prazo"' />
                            <label class="form-check-label ms-2">A Prazo</label>
                        </div>
                    </div>
                    <div class="mt-2">
                        <input type="number" step="0.01" class="form-control ms-2" style="max-width:140px;" placeholder="Valor" @bind="pagamento2" disabled="@SecondaryCalculated" />
                    </div>
                </div>
            </div>
        }
    </div>

   
    @if (formaPagamento2 == "A Prazo")
    {
        <div class="mt-2">
            <label class="fw-bold">Data de Pagamento 2 (prazo)</label>
            <InputDate @bind-Value="dataPagamentoPrazo2" class="form-control w-auto" />
        </div>
    }

    
    @* Compact inputs row below cart: vendedor e dados do cliente lado a lado *@
    <div class="d-flex gap-3 mt-3">
        <div style="flex:1; max-width:380px;">
            <label class="form-label fw-bold">Vendedor</label>
            <div>
                @if (vendedores != null && vendedores.Any())
                {
                    @foreach (var v in vendedores)
                    {
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="vendedor" id="v_@v" @onchange="() => vendedorNome = v" checked="@(vendedorNome == v)" />
                            <label class="form-check-label ms-2" for="v_@v">@v</label>
                        </div>
                    }

                    <div class="form-check mt-1">
                        <input class="form-check-input" type="radio" name="vendedor" id="v_outro" @onchange="() => vendedorNome = string.Empty" checked="@(!string.IsNullOrEmpty(vendedorNome) && !vendedores.Contains(vendedorNome))" />
                        <label class="form-check-label ms-2" for="v_outro">Outro</label>
                    </div>

                    @if (string.IsNullOrEmpty(vendedorNome) || !vendedores.Contains(vendedorNome))
                    {
                        <input class="form-control form-control-sm mt-1" @bind="vendedorNome" placeholder="Digite o nome do vendedor" />
                    }
                }
                else
                {
                    <input type="text" class="form-control form-control-sm" @bind="vendedorNome" placeholder="Vendedor" />
                }
            </div>
        </div>

        <div style="flex:2; display:flex; gap:8px; flex-direction:column;">
            <div style="display:flex; gap:8px;">
                <div style="flex:1">
                    <label class="form-label fw-bold">Cliente</label>
                    <input type="text" class="form-control form-control-sm" @bind="clienteNome" @oninput="BuscarSugestoesComanda" placeholder="Nome cliente" />
                </div>
                <div style="width:140px">
                    <label class="form-label fw-bold">Telefone</label>
                    <input type="text" class="form-control form-control-sm" @bind="entryTelefone" placeholder="Telefone" />
                </div>
            </div>
            <div>
                <label class="form-label fw-bold">Endereço</label>
                <input type="text" class="form-control form-control-sm" @bind="entryEndereco" placeholder="Endereço" />
            </div>

            <div class="mt-2">
                <label class="form-label fw-bold">Observações</label>
                <input type="text" class="form-control form-control-sm" @bind="observacoes" placeholder="Observações do pedido" />
            </div>
        </div>
    </div>

        <div class="mt-3">
            <label class="form-label fw-bold">Status do Pedido</label>
            <div class="d-flex gap-3 mt-2 flex-column">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="statusPedido" id="status_finalizado" value="Finalizado" checked='@(PedidoStatus == "Finalizado")' @onclick='() => PedidoStatus = "Finalizado"' />
                    <label class="form-check-label ms-2" for="status_finalizado">Finalizado</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="statusPedido" id="status_retirada" value="Retirada" checked='@(PedidoStatus == "Retirada")' @onclick='() => PedidoStatus = "Retirada"' />
                    <label class="form-check-label ms-2" for="status_retirada">Retirada</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="statusPedido" id="status_entrega" value="Em entrega" checked='@(PedidoStatus == "Em entrega")' @onclick='() => PedidoStatus = "Em entrega"' />
                    <label class="form-check-label ms-2" for="status_entrega">Em entrega</label>
                </div>
            </div>
        </div>

    <button class="btn btn-success btn-lg w-100 mt-3"
            @onclick="FinalizePurchase"
            disabled="@(!cart.Any() || string.IsNullOrEmpty(formaPagamentoSelecionada) || string.IsNullOrEmpty(pedidoStatus))">
        Finalizar Compra
    </button>
</div>




@if (showQuantityModal)
{
    <div class="modal-backdrop fade show"></div>

    <div class="modal d-block">
        <div class="modal-dialog modal-sm mt-5">
            <div class="modal-content p-4 shadow-lg">
                <h5 class="fw-bold text-center">Quantidade</h5>

                <div class="mb-3">
                    <input type="number" class="form-control form-control-lg text-center"
                           min="1" @bind="selectedQuantity" />
                </div>

                <div class="mb-3">
                    <label class="form-label">Temperatura</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="temp" id="temp_none" checked="@(string.IsNullOrEmpty(selectedTemperatura))" @onchange="() => selectedTemperatura = null" />
                            <label class="form-check-label" for="temp_none">Nenhuma</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="temp" id="temp_quente" checked='@(selectedTemperatura == "Quente")' @onchange='() => selectedTemperatura = "Quente"' />
                            <label class="form-check-label" for="temp_quente">Quente</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="temp" id="temp_gelada" checked='@(selectedTemperatura == "Gelada")' @onchange='() => selectedTemperatura = "Gelada"' />
                            <label class="form-check-label" for="temp_gelada">Gelada</label>
                        </div>
                    </div>
                </div>

                <div class="d-flex mt-3 justify-content-around">
                    <button class="btn btn-secondary btn-lg" @onclick="CloseModal">Cancelar</button>
                    <button class="btn btn-primary btn-lg" @onclick="ConfirmAddToCart">OK</button>
                </div>
            </div>
        </div>
    </div>
}



@* html *@
@code {
    //c#
    private string searchNome = string.Empty;
    private string searchBarcode = string.Empty;
    private string searchTerm = string.Empty;
    private bool showProductList = false;
    private string clienteNome = string.Empty;
    private string vendedorNome = string.Empty;
    private List<Produto> filteredProdutos = new();
    private List<Produto> maisVendidos = new();
    private List<CartItem> cart = new();
    private List<ItemComanda> itensComanda = new();
    private int idcomanda;
    private bool isProcessing = false;
    private string formaPagamentoSelecionada = string.Empty;
    private List<Comanda> todasComandasAbertas = new();
    private List<Comanda> sugestoesComanda = new();
    private string entryTelefone;
    private string entryEndereco;
    private bool imprimirNaCozinha = false;
    private DateTime? dataPagamentoPrazo;
    private DateTime? dataPagamentoPrazo2;

    private bool showQuantityModal = false;
    private bool showCreateProductModal = false;
    private Produto newProductForBarcode = new Produto();
private Produto selectedProduct;
private int? selectedQuantity = null;
private string? selectedTemperatura = null;
    private string observacoes = string.Empty;
    private bool showDebugImages = false;
    private List<string> debugImageSources = new();
    private string formaPagamento2 = string.Empty;
    private decimal? pagamento1;
    private decimal? pagamento2;
    private List<string> vendedores = new();
    private bool UsarPagamento2 = false;
    private bool SecondaryCalculated = false;
    private string pedidoStatus = string.Empty;
    private string PedidoStatus
    {
        get => pedidoStatus;
        set
        {
            if (pedidoStatus != value)
            {
                var previousStatus = pedidoStatus;
                pedidoStatus = value;

                // If changing to 'Em entrega', increase all existing cart items by 0.10
                if (previousStatus != "Em entrega" && pedidoStatus == "Em entrega")
                {
                    foreach (var item in cart)
                    {
                        // apply only once
                        if (!item.DeliverySurchargeApplied)
                        {
                            item.PrecoUnitario = Math.Round(item.PrecoUnitario + 0.10m, 2);
                            item.DeliverySurchargeApplied = true;
                        }
                    }
                }

                // If changing from 'Em entrega' to something else (e.g., Retirada), remove previously applied 0.10
                if (previousStatus == "Em entrega" && pedidoStatus != "Em entrega")
                {
                    foreach (var item in cart)
                    {
                        if (item.DeliverySurchargeApplied)
                        {
                            item.PrecoUnitario = Math.Round(item.PrecoUnitario - 0.10m, 2);
                            item.DeliverySurchargeApplied = false;
                        }
                    }
                }

                // When switching to Retirada, prefer PrecoRetirar if available (but keep surcharge logic above)
                if (pedidoStatus == "Retirada")
                {
                    foreach (var item in cart)
                    {
                        if (!string.IsNullOrEmpty(item.Temperatura))
                            continue;
                        if (item.Produto.PrecoRetirar > 0)
                        {
                            // If surcharge already applied, set to PrecoRetirar + surcharge
                            var basePrice = item.Produto.PrecoRetirar;
                            item.PrecoUnitario = item.DeliverySurchargeApplied ? Math.Round(basePrice + 0.10m, 2) : basePrice;
                        }
                    }
                }

                StateHasChanged();
            }
        }
    }
    
    private void SelectVendedor(string nome) => vendedorNome = nome;
    private void SelectStatus(string status) => pedidoStatus = status;

    // scanner interop fields moved into code-behind section
    private DotNetObjectReference<object>? _dotNetRef;


    private void CancelCreateProduct()
    {
        showCreateProductModal = false;
    }

    private async Task CreateProductFromBarcode()
    {
        try
        {
            // Basic validation and defaults required by backend
            if (string.IsNullOrWhiteSpace(newProductForBarcode.Nome))
            {
                await ShowAlert("Por favor informe o nome do produto antes de cadastrar.");
                return;
            }

            // PrecoCusto is required by backend. If not provided, fallback to Preco or a small non-zero value.
            if (newProductForBarcode.PrecoCusto <= 0)
            {
                if (newProductForBarcode.Preco > 0)
                    newProductForBarcode.PrecoCusto = newProductForBarcode.Preco;
                else
                    newProductForBarcode.PrecoCusto = 0.01m;
            }

            // CategoriaId may be required; pick a sensible default if not set
            if (newProductForBarcode.CategoriaId == 0)
            {
                var (cats, _) = await _apiService.GetCategorias();
                if (cats != null && cats.Any())
                    newProductForBarcode.CategoriaId = cats.First().Id;
                else
                    newProductForBarcode.CategoriaId = 1; // fallback
            }

            // call API to create product
            var response = await _apiService.AdicionarProdutoAsync(newProductForBarcode);
            if (!string.IsNullOrEmpty(response.ErrorMessage))
            {
                await ShowAlert("Falha ao criar produto: " + response.ErrorMessage);
                return;
            }

            // reload products and add created product to cart
            var (todosProdutos, err) = await _apiService.GetTodosProdutos();
            var created = todosProdutos?.FirstOrDefault(p => p.Barcode == newProductForBarcode.Barcode) ?? newProductForBarcode;
            // open quantity modal for the newly created product
            showCreateProductModal = false;
            OpenQuantityModal(created);
        }
        catch (Exception ex)
        {
            await ShowAlert("Erro ao criar produto: " + ex.Message);
        }
    }

    private decimal GetProdutoDisplayPrice(Produto p)
    {
        if (p == null) return 0m;
        if (p.PrecoRetirar > 0) return p.PrecoRetirar;
        if (p.PrecoEntrega > 0) return p.PrecoEntrega;
        if (p.PrecoQuente > 0) return p.PrecoQuente;
        if (p.PrecoGelada > 0) return p.PrecoGelada;
        return p.Preco;
    }

    private void ToggleDebugImages()
    {
        showDebugImages = !showDebugImages;
        if (showDebugImages)
        {
            debugImageSources = filteredProdutos.Select(p => p.CaminhoImagem ?? p.UrlImagem ?? "(none)").ToList();
        }
    }

    private async Task OpenScanner()
    {
        _dotNetRef ??= DotNetObjectReference.Create((object)this);
        await JS.InvokeVoidAsync("barcodeScanner.start", _dotNetRef, "barcode-scanner-container");
    }

    private async Task OpenNativeScanner()
    {
        // call JS helper that tries to open ZXing or Intent
        await JS.InvokeVoidAsync("barcodeScanner.openScannerApp");
    }

    [JSInvokable]
    public async Task OnBarcodeScanned(string code)
    {
        searchTerm = code;
        await SearchProducts(null);
        StateHasChanged();
        await ProcessBarcode(code);
    }

    private async Task OnSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await ProcessBarcode(searchTerm);
        }
    }

    private async Task SearchProducts(ChangeEventArgs e)
    {
        // unify name or barcode search into single input
        if (e != null)
            searchTerm = e.Value?.ToString() ?? string.Empty;
        else
        {
            // when used from JSInvokable or code, searchTerm already set
        }

        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredProdutos = new List<Produto>();
            showProductList = false;
            return;
        }

        // attempt exact barcode match first
        var (todosProdutos, _) = await _apiService.GetTodosProdutos();
        if (todosProdutos == null)
        {
            filteredProdutos = new();
            showProductList = false;
            return;
        }

        var byBarcode = todosProdutos.Where(p => !string.IsNullOrWhiteSpace(p.Barcode) && p.Barcode.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();
        if (byBarcode.Any())
        {
            filteredProdutos = byBarcode;
            showProductList = true;
            return;
        }

        // fallback to name search
        filteredProdutos = todosProdutos.Where(p => p.Nome != null && p.Nome.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)).ToList();
        showProductList = filteredProdutos.Any();
    }

    private async Task OnBarcodeKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            var code = searchBarcode?.Trim();
            await JS.InvokeVoidAsync("console.log", $"OnBarcodeKeyDown Enter pressed, code='" + (code ?? "(null)") + "'");
            if (string.IsNullOrEmpty(code))
            {
                await JS.InvokeVoidAsync("console.warn", "Barcode input empty on Enter");
                return;
            }
            await ProcessBarcode(code);
            StateHasChanged();
        }
    }

    private async Task OnBarcodeKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            var code = searchBarcode?.Trim();
            await JS.InvokeVoidAsync("console.log", $"OnBarcodeKeyUp Enter pressed, code='" + (code ?? "(null)") + "'");
            if (string.IsNullOrEmpty(code))
            {
                await JS.InvokeVoidAsync("console.warn", "Barcode input empty on Enter (keyup)");
                return;
            }

            await ProcessBarcode(code);
            StateHasChanged();
        }
    }

    private async Task ProcessBarcode(string code)
    {
        try
        {
            // 1) Check backend product DB first
            var (todosProdutos, errorMessage) = await _apiService.GetTodosProdutos();

            if (todosProdutos == null || !todosProdutos.Any())
            {
                await JS.InvokeVoidAsync("console.warn", "ProcessBarcode: GetTodosProdutos returned no items: " + (errorMessage ?? "(no error msg)"));
            }

            string Normalize(string? s) => string.IsNullOrWhiteSpace(s) ? string.Empty : new string(s.Where(char.IsDigit).ToArray());
            var normalizedCode = Normalize(code);

            Produto? produto = null;
            if (!string.IsNullOrEmpty(normalizedCode))
            {
                produto = (todosProdutos ?? new List<Produto>())
                    .FirstOrDefault(p => !string.IsNullOrWhiteSpace(p.Barcode) && Normalize(p.Barcode) == normalizedCode);
            }
            if (produto == null)
            {
                produto = (todosProdutos ?? new List<Produto>())
                    .FirstOrDefault(p => string.Equals(p.Barcode?.Trim(), code?.Trim(), StringComparison.OrdinalIgnoreCase));
            }

            if (produto != null)
            {
                // product exists in DB -> open quantity modal
                OpenQuantityModal(produto);
                return;
            }
            // 2) Not in DB -> open modal immediately with barcode, then prefill asynchronously
            try
            {
                // set minimal barcode and clear other fields on the existing instance so bindings show immediately
                newProductForBarcode.Barcode = code;
                newProductForBarcode.Nome = null;
                newProductForBarcode.Preco = 0m;
                newProductForBarcode.Detalhe = null;
                newProductForBarcode.UrlImagem = null;
                newProductForBarcode.PrecoCusto = 0m;
                newProductForBarcode.PrecoQuente = 0m;
                newProductForBarcode.PrecoGelada = 0m;
                newProductForBarcode.PrecoEntrega = 0m;
                newProductForBarcode.PrecoRetirar = 0m;
                newProductForBarcode.CategoriaId = 0;

                showCreateProductModal = true;
                StateHasChanged();

                // Prefill in background so UI is responsive
                _ = PrefillProductFromLookup(code);
                return;
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("console.error", "Barcode lookup exception: " + ex.Message);
                newProductForBarcode.Barcode = code;
                showCreateProductModal = true;
                StateHasChanged();
                return;
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Erro em ProcessBarcode: " + ex.Message);
            newProductForBarcode = new Produto { Barcode = code };
            showCreateProductModal = true;
            StateHasChanged();
        }
    }

    private class CaixaStateDto
    {
        public List<object>? Cart { get; set; }
        public string? ClienteNome { get; set; }
        public string? VendedorNome { get; set; }
        public string? FormaPagamentoSelecionada { get; set; }
        public string? FormaPagamento2 { get; set; }
        public decimal? Pagamento1 { get; set; }
        public decimal? Pagamento2 { get; set; }
        public string? PedidoStatus { get; set; }
        public decimal ValorRecebido { get; set; }
    }

    private async Task SaveCaixaStateAsync()
    {
        try
        {
            var dto = new CaixaStateDto
            {
                Cart = cart.Select(i => new {
                    ProdutoId = i.Produto?.Id,
                    i.Produto?.Nome,
                    i.Produto?.Barcode,
                    PrecoUnitario = i.PrecoUnitario,
                    Quantidade = i.Quantidade,
                    Temperatura = i.Temperatura
                }).Cast<object>().ToList(),
                ClienteNome = clienteNome,
                VendedorNome = vendedorNome,
                FormaPagamentoSelecionada = formaPagamentoSelecionada,
                FormaPagamento2 = formaPagamento2,
                Pagamento1 = pagamento1,
                Pagamento2 = pagamento2,
                PedidoStatus = pedidoStatus,
                ValorRecebido = valorRecebidoDinheiro
            };

            var json = System.Text.Json.JsonSerializer.Serialize(dto);
            await JS.InvokeVoidAsync("sessionStorage.setItem", "caixaState", json);
        }
        catch (Exception ex)
        {
            Console.WriteLine("Erro ao salvar estado do caixa: " + ex.Message);
        }
    }

    private async Task RestoreCaixaStateIfAnyAsync()
    {
        try
        {
            var json = await JS.InvokeAsync<string>("sessionStorage.getItem", "caixaState");
            if (string.IsNullOrWhiteSpace(json)) return;

            var dto = System.Text.Json.JsonSerializer.Deserialize<CaixaStateDto>(json, new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            if (dto == null) return;

            // restore basic fields
            clienteNome = dto.ClienteNome ?? clienteNome;
            vendedorNome = dto.VendedorNome ?? vendedorNome;
            formaPagamentoSelecionada = dto.FormaPagamentoSelecionada ?? formaPagamentoSelecionada;
            formaPagamento2 = dto.FormaPagamento2 ?? formaPagamento2;
            pagamento1 = dto.Pagamento1 ?? pagamento1;
            pagamento2 = dto.Pagamento2 ?? pagamento2;
            pedidoStatus = dto.PedidoStatus ?? pedidoStatus;
            valorRecebidoDinheiro = dto.ValorRecebido;

            // restore cart: we need to fetch products and match ids
            if (dto.Cart != null && dto.Cart.Any())
            {
                var (todosProdutos, err) = await _apiService.GetTodosProdutos();
                var prodList = todosProdutos ?? new List<Produto>();
                var newCart = new List<CartItem>();
                foreach (var itemObj in dto.Cart)
                {
                    // parse with JsonElement
                    var elem = itemObj as System.Text.Json.JsonElement?;
                    System.Text.Json.JsonElement je;
                    if (itemObj is System.Text.Json.JsonElement)
                        je = (System.Text.Json.JsonElement)itemObj;
                    else
                        je = (System.Text.Json.JsonElement)System.Text.Json.JsonSerializer.SerializeToElement(itemObj);

                    int? prodId = null;
                    try { if (je.TryGetProperty("ProdutoId", out var p1) && p1.ValueKind == System.Text.Json.JsonValueKind.Number) prodId = p1.GetInt32(); } catch { }
                    string nome = null;
                    try { if (je.TryGetProperty("Nome", out var p2) && p2.ValueKind == System.Text.Json.JsonValueKind.String) nome = p2.GetString(); } catch { }
                    decimal preco = 0;
                    try { if (je.TryGetProperty("PrecoUnitario", out var p3) && p3.ValueKind == System.Text.Json.JsonValueKind.Number) preco = p3.GetDecimal(); } catch { }
                    int quantidade = 1;
                    try { if (je.TryGetProperty("Quantidade", out var p4) && p4.ValueKind == System.Text.Json.JsonValueKind.Number) quantidade = p4.GetInt32(); } catch { }
                    string temperatura = null;
                    try { if (je.TryGetProperty("Temperatura", out var p5) && p5.ValueKind == System.Text.Json.JsonValueKind.String) temperatura = p5.GetString(); } catch { }

                    Produto? prod = null;
                    if (prodId.HasValue) prod = prodList.FirstOrDefault(p => p.Id == prodId.Value);
                    if (prod == null && !string.IsNullOrEmpty(nome)) prod = prodList.FirstOrDefault(p => p.Nome == nome);

                    if (prod != null)
                    {
                        newCart.Add(new CartItem { Produto = prod, Quantidade = quantidade, PrecoUnitario = preco, Temperatura = temperatura });
                    }
                }

                if (newCart.Any()) cart = newCart;
            }

            // remove saved state
            await JS.InvokeVoidAsync("sessionStorage.removeItem", "caixaState");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Erro ao restaurar estado do caixa: " + ex.Message);
        }
    }

    [JSInvokable]
    public async Task OnBarcodeError(string message)
    {
        await ShowAlert("Erro no leitor: " + message);
    }

void OpenQuantityModal(Produto produto)
{
    selectedProduct = produto;
    // start empty so user can type a value without having to delete a default
    selectedQuantity = null;
    // default temperature to null
    selectedTemperatura = null;
    showQuantityModal = true;
}

void CloseModal()
{
    showQuantityModal = false;
    // clear search so user can type a new search after adding
    searchTerm = string.Empty;
    showProductList = false;
    StateHasChanged();
}

    void ConfirmAddToCart()
{
    var qty = selectedQuantity ?? 1; // default 1 if user leaves empty

    // consider product identity + temperatura when merging items
    var existing = cart.FirstOrDefault(c => c.Produto.Id == selectedProduct.Id && (c.Temperatura ?? string.Empty) == (selectedTemperatura ?? string.Empty));

    if (existing == null)
    {
            var precoUnit = selectedProduct.Preco;
            // treat 'Nenhuma' (null) as Quente — prefer PrecoQuente when available
            var temp = selectedTemperatura ?? "Quente";
            if (temp == "Quente")
            {
                if (selectedProduct.PrecoQuente > 0) precoUnit = selectedProduct.PrecoQuente;
            }
            else if (temp == "Gelada")
            {
                if (selectedProduct.PrecoGelada > 0) precoUnit = selectedProduct.PrecoGelada;
            }
            else
            {
                // fallback: if order status indicates retirada/entrega, use those prices
                if (pedidoStatus == "Retirada" && selectedProduct.PrecoRetirar > 0) precoUnit = selectedProduct.PrecoRetirar;
                if (pedidoStatus == "Em entrega" && selectedProduct.PrecoEntrega > 0) precoUnit = selectedProduct.PrecoEntrega;
            }

        // If current order status is delivery, apply surcharge to the price we add
        var cartItem = new CartItem
        {
            Produto = selectedProduct,
            Quantidade = qty,
            PrecoUnitario = precoUnit,
            Temperatura = selectedTemperatura,
            DeliverySurchargeApplied = false
        };

        if (pedidoStatus == "Em entrega")
        {
            cartItem.PrecoUnitario = Math.Round(cartItem.PrecoUnitario + 0.10m, 2);
            cartItem.DeliverySurchargeApplied = true;
        }

        cart.Add(cartItem);
    }
    else
    {
        // same product and temperature -> increment quantity
        existing.Quantidade += qty;
    }

    showQuantityModal = false;
    // clear search so user can type a new search after adding
    searchTerm = string.Empty;
    showProductList = false;
    StateHasChanged();
}

void UpdateCartTotals()
{
    StateHasChanged();
}

    private decimal valorRecebidoDinheiro;
    private decimal valorRecebidoDinheiro2;

    private decimal trocoDinheiro => ComputeTrocoPrimary();
    private decimal trocoDinheiro2 => ComputeTrocoSecondary();

    private decimal ComputeTrocoPrimary()
    {
        var total = cart.Sum(p => p.Total);

        // Determine how much was paid as primary cash
        decimal paidPrimary = 0m;
        if (string.Equals(formaPagamentoSelecionada, "Dinheiro", StringComparison.OrdinalIgnoreCase))
        {
            paidPrimary = (pagamento1.HasValue && pagamento1.Value > 0) ? pagamento1.Value : valorRecebidoDinheiro;
        }

        // Determine how much was paid as secondary cash (if any)
        decimal paidSecondary = 0m;
        if (UsarPagamento2 && string.Equals(formaPagamento2, "Dinheiro", StringComparison.OrdinalIgnoreCase))
        {
            paidSecondary = (pagamento2.HasValue && pagamento2.Value > 0) ? pagamento2.Value : valorRecebidoDinheiro2;
        }

        // Secondary cash covers up to paidSecondary; remaining amount is covered by primary
        var remainingForPrimary = Math.Max(0, total - paidSecondary);
        var assignedToPrimary = Math.Min(paidPrimary, remainingForPrimary);

        var troco = paidPrimary - assignedToPrimary;
        return Math.Round(troco, 2);
    }

    private decimal ComputeTrocoSecondary()
    {
        var total = cart.Sum(p => p.Total);

        if (!(UsarPagamento2 && string.Equals(formaPagamento2, "Dinheiro", StringComparison.OrdinalIgnoreCase)))
            return 0m;

        var paidSecondary = (pagamento2.HasValue && pagamento2.Value > 0) ? pagamento2.Value : valorRecebidoDinheiro2;

        decimal paidPrimary = 0m;
        if (string.Equals(formaPagamentoSelecionada, "Dinheiro", StringComparison.OrdinalIgnoreCase))
            paidPrimary = (pagamento1.HasValue && pagamento1.Value > 0) ? pagamento1.Value : valorRecebidoDinheiro;

        var remainingForSecondary = Math.Max(0, total - paidPrimary);
        var assignedToSecondary = Math.Min(paidSecondary, remainingForSecondary);

        var troco = paidSecondary - assignedToSecondary;
        return Math.Round(troco, 2);
    }

    private int? NumeroComanda => int.TryParse(clienteNome, out int num) ? num : (int?)null;

    protected override async Task OnInitializedAsync()
    {
        // try to restore previous caixa state if any
        await RestoreCaixaStateIfAnyAsync();

        // If opened via external scanner app it may include ?scanned=CODE in the URL -> handle it
        try
        {
            var uri = Navigation.Uri;
            var marker = "?scanned=";
            var idx = uri.IndexOf(marker, StringComparison.OrdinalIgnoreCase);
            if (idx >= 0)
            {
                var code = Uri.UnescapeDataString(uri.Substring(idx + marker.Length));
                if (!string.IsNullOrWhiteSpace(code))
                {
                    // remove query part from URL and process
                    var baseUri = uri.Substring(0, idx);
                    // navigate to base to remove query (keeps app state)
                    Navigation.NavigateTo(baseUri, replace: true);
                    await ProcessBarcode(code);
                }
            }
        }
        catch { }

        var nome = await JS.InvokeAsync<string>("sessionStorage.getItem", "Email");

        if (string.IsNullOrEmpty(nome))
        {
            Navigation.NavigateTo("login");
        }

        var (produtosMaisVendidos, errorMessage) = await _apiService.GetProdutosMaisVendidos();
        filteredProdutos = produtosMaisVendidos ?? new List<Produto>();

        // Preencher lista de vendedores aqui (OnInitializedAsync) e selecionar o primeiro por padrão
        if (vendedores == null || !vendedores.Any())
        {
            vendedores = new List<string> { "Ronaldo", "Neno", "Carlinhos", "Juliana", "Beatriz", "Kayke" };
        }
    }

    private async Task BuscarSugestoesComanda(ChangeEventArgs e)
    {
        clienteNome = e.Value.ToString();

        if (string.IsNullOrWhiteSpace(clienteNome))
        {
            sugestoesComanda.Clear();
            return;
        }

        // Se ainda não carregou todas as comandas abertas
        if (!todasComandasAbertas.Any())
        {
            var (lista, erro) = await _apiService.GetComandas();
            todasComandasAbertas = lista ?? new();
        }

        sugestoesComanda = todasComandasAbertas
            .Where(c => c.Nome.Contains(clienteNome, StringComparison.OrdinalIgnoreCase))
            .Take(5) // Limita sugestões
            .ToList();
    }

    private void SelecionarSugestaoComanda(string idSelecionado)
    {
        clienteNome = idSelecionado;
        sugestoesComanda.Clear();
    }

    private string GetProdutoImageSrc(Produto produto)
    {
        // Prefer Produto.CaminhoImagem (already includes AppConfig.BaseUrl) when available
        if (!string.IsNullOrEmpty(produto.CaminhoImagem))
            return produto.CaminhoImagem;

        // Fallback to UrlImagem if it's already an absolute URL
        if (!string.IsNullOrEmpty(produto.UrlImagem) && produto.UrlImagem.StartsWith("http", StringComparison.OrdinalIgnoreCase))
            return produto.UrlImagem;

        return string.Empty;
    }

    private async Task SearchByNome(ChangeEventArgs e)
    {
        searchBarcode = string.Empty; // Limpa a pesquisa por código de barras
        searchNome = e.Value.ToString();
        if (string.IsNullOrWhiteSpace(searchNome))
        {
            var (maisVendidos, errorMessage) = await _apiService.GetProdutosMaisVendidos();
            filteredProdutos = maisVendidos;
        }
        else
        {
            var (todosProdutos, errorMessage) = await _apiService.GetTodosProdutos();
            filteredProdutos = todosProdutos
                                .Where(c => c.Nome.IndexOf(searchNome, StringComparison.OrdinalIgnoreCase) >= 0)
                                .ToList();
        }
    }

    private async Task SearchByBarcode(ChangeEventArgs e)
    {
        searchNome = string.Empty; // Limpa a pesquisa por nome
        searchBarcode = e.Value.ToString();
        if (string.IsNullOrWhiteSpace(searchBarcode))
        {
            var (todosProdutos, errorMessage) = await _apiService.GetTodosProdutos();
            filteredProdutos = todosProdutos;
        }
        else
        {
            var (todosProdutos, errorMessage) = await _apiService.GetTodosProdutos();
            filteredProdutos = todosProdutos
                                .Where(c => c.Barcode == searchBarcode)
                                .ToList();
        }
    }

    private async Task OnBarcodeInput(ChangeEventArgs e)
    {
        // keep behavior consistent with SearchByBarcode
        searchNome = string.Empty;
        searchBarcode = e?.Value?.ToString();

        if (string.IsNullOrWhiteSpace(searchBarcode))
        {
            var (todosProdutos, errorMessage) = await _apiService.GetTodosProdutos();
            filteredProdutos = todosProdutos ?? new List<Produto>();
        }
        else
        {
            var (todosProdutos, errorMessage) = await _apiService.GetTodosProdutos();
            filteredProdutos = (todosProdutos ?? new List<Produto>())
                                .Where(c => string.Equals(c.Barcode, searchBarcode, StringComparison.OrdinalIgnoreCase))
                                .ToList();
        }
    }

    // private void AddToCart(Produto Produto)
    // {
    //     var newItem = new CartItem
    //     {
    //         Produto = Produto,
    //         Quantidade = 1
    //     };
    //     cart.Add(Produto);
    // }

    private void RemoveFromCart(CartItem  Produto)
    {
        cart.Remove(Produto);
    }

    private void AddBlankCartItem()
    {
        var blank = new Produto { Id = 0, Nome = string.Empty, Preco = 0m, PrecoCusto = 0.01m, CategoriaId = 1 };
        var item = new CartItem { Produto = blank, Quantidade = 1, PrecoUnitario = 0m };
        cart.Add(item);
        StateHasChanged();
    }

    private async Task FinalizePurchase()
    {
        // exigir vendedor preenchido
        if (string.IsNullOrWhiteSpace(vendedorNome))
        {
            await ShowAlert("Por favor selecione ou digite o nome do vendedor antes de finalizar a compra.");
            return;
        }

        // exigir status selecionado
        if (string.IsNullOrWhiteSpace(pedidoStatus))
        {
            await ShowAlert("Por favor selecione o status do pedido antes de finalizar a compra.");
            return;
        }

        // If payment is 'A Prazo' require dataPagamentoPrazo, clienteNome and telefone
        if (string.Equals(formaPagamentoSelecionada, "A Prazo", StringComparison.OrdinalIgnoreCase))
        {
            if (!dataPagamentoPrazo.HasValue)
            {
                await ShowAlert("Para pagamento a prazo, informe a data de pagamento (prazo).");
                return;
            }
            // require clienteNome and telefone when forma1 is A Prazo
            if (string.IsNullOrWhiteSpace(clienteNome))
            {
                await ShowAlert("Para pagamento a prazo (forma 1), informe o nome do cliente.");
                return;
            }
            if (string.IsNullOrWhiteSpace(entryTelefone))
            {
                await ShowAlert("Para pagamento a prazo (forma 1), informe o telefone do cliente.");
                return;
            }
        }
        
        // If payment 2 is used and is 'A Prazo', require clienteNome and telefone as well
        if (UsarPagamento2 && string.Equals(formaPagamento2, "A Prazo", StringComparison.OrdinalIgnoreCase))
        {
            if (string.IsNullOrWhiteSpace(clienteNome))
            {
                await ShowAlert("Para pagamento a prazo (forma 2), informe o nome do cliente.");
                return;
            }
            if (string.IsNullOrWhiteSpace(entryTelefone))
            {
                await ShowAlert("Para pagamento a prazo (forma 2), informe o telefone do cliente.");
                return;
            }
        }
        // Build DTO matching backend PedidoDetalheDTO for items
        var itensDto = cart.Select(item => new
        {
            ProdutoId = item.Produto.Id,    
            ProdutoNome = item.Produto.Nome,
            ProdutoImagem = item.Produto.UrlImagem ?? item.Produto.CaminhoImagem,
            Quantidade = item.Quantidade,
            ProdutoPreco = item.PrecoUnitario,
            SubTotal = item.Total,
            CaminhoImagem = item.Produto.CaminhoImagem ?? (item.Produto.UrlImagem != null ? AppConfig.BaseUrl + item.Produto.UrlImagem : null)
        }).ToList();

        var pedidoDto = new
        {
            Endereco = entryEndereco,
            VendedorNome = vendedorNome,
            ClienteNome = clienteNome,
            ValorTotal = cart.Sum(p => p.Total),
            DataPedido = DateTime.Now,
            FormaPagamento = formaPagamentoSelecionada,
            ValorPago1 = pagamento1,
            FormaPagamento2 = formaPagamento2,
            ValorPago2 = pagamento2,
            Status = pedidoStatus,
            DataPagamentoPrazo = dataPagamentoPrazo,
            DataPagamentoPrazo2 = dataPagamentoPrazo2,
            Observacoes = observacoes,
            Itens = itensDto
        };

        // serialize and post directly to API
        var json = System.Text.Json.JsonSerializer.Serialize(pedidoDto);
        var content = new System.Net.Http.StringContent(json, System.Text.Encoding.UTF8, "application/json");

        var response = await _apiService.PostRequest("api/Pedidos", content);

        if (!response.IsSuccessStatusCode)
        {
            await ShowAlert($"Falha ao confirmar pedido: {response.ReasonPhrase}");
            return;
        }

        // registrar movimentações de estoque
        foreach (var item in cart)
        {
            var movimentacao = new MovimentacaoEstoque()
            {
                ProdutoId = item.Produto.Id,
                Tipo = TipoMovimentacao.Venda,
                Quantidade = item.Quantidade,
                DataMovimentacao = DateTime.Now
            };
            await _apiService.MovimentarEstoqueAsync(movimentacao);
        }

        cart.Clear();
        // reset payment fields and selections so next sale starts clean
        formaPagamentoSelecionada = string.Empty;
        formaPagamento2 = string.Empty;
        // deselect all radio buttons by clearing bound values
        UsarPagamento2 = false;
        pagamento1 = null;
        pagamento2 = null;
        valorRecebidoDinheiro = 0m;
        valorRecebidoDinheiro2 = 0m;
        UsarPagamento2 = false;

        clienteNome = string.Empty;
        vendedorNome = string.Empty;
        // clear radio selections
        formaPagamentoSelecionada = string.Empty;
        formaPagamento2 = string.Empty;
        pedidoStatus = string.Empty;
        entryTelefone = string.Empty;
        entryEndereco = string.Empty;
        observacoes = string.Empty;
        dataPagamentoPrazo = null;
        dataPagamentoPrazo2 = null;

        StateHasChanged(); // Atualiza a UI
        Console.WriteLine("Compra finalizada!");
    }

    private void RecalculateSecondary()
    {
        try
        {
            if (!UsarPagamento2)
            {
                SecondaryCalculated = false;
                return;
            }

            var total = cart.Sum(p => p.Total);

            // if primary provided, allocate remaining to secondary
            var primaryValue = pagamento1 ?? 0m;

            var remaining = total - primaryValue;
            if (remaining <= 0)
            {
                pagamento2 = 0m;
            }
            else
            {
                pagamento2 = Math.Round(remaining, 2);
            }

            SecondaryCalculated = true;
        }
        catch { }
    }

    private async Task CreateComanda()
    {
        if (isProcessing)
            return;

        if (string.IsNullOrEmpty(clienteNome))
            return;

        isProcessing = true;

        try
        {
            if (!string.IsNullOrEmpty(entryTelefone))
            {
            var (existeCliente, errorMessage) = await _apiService.GetClienteByPhoneAsync(entryTelefone);
            if (existeCliente == null)
            {
                var novoCliente = new Clientes
                    {
                        Nome = clienteNome,
                        Telefone = entryTelefone,
                        Endereco = entryEndereco
                    };
                var respondeCliente = await _apiService.AddClienteAsync(novoCliente);
            }
        }
            var (comandaExistente, erro) = await _apiService.GetComandaPorNome(clienteNome);

            if (comandaExistente != null)
            {
                var produtosCart = cart.Select(p => new Produto
                {
                    Id = p.Produto.Id,
                    Nome = p.Produto.Nome,
                    Preco = p.Produto.Preco,
                    UrlImagem = p.Produto.UrlImagem
                }).ToList();

                // Comanda já existe, adicionar produtos do carrinho a ela
                await AdicionarProdutosAComanda(comandaExistente.Nome, produtosCart);
                await AtualizarValorComanda(comandaExistente.Nome);
            }
            else
            {
                // Comanda não existe, criar uma nova
                var comandaId = await CriarNovaComanda(clienteNome, itensComanda);
                var produtosCart = cart.Select(p => new Produto
                {
                    Id = p.Produto.Id,
                    Nome = p.Produto.Nome,
                    Preco = p.Produto.Preco,
                    UrlImagem = p.Produto.UrlImagem
                }).ToList();

                if (!(comandaId == 0))
                {
                    await AdicionarProdutosAComanda(clienteNome, produtosCart);
                    await AtualizarValorComanda(clienteNome);
                }
            }
            cart.Clear();
            itensComanda.Clear();
            clienteNome = string.Empty;
            entryTelefone = string.Empty;
            StateHasChanged(); // Atualiza a UI
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao criar ou atualizar comanda: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task AdicionarProdutosAComanda(string nome, List<Produto> carrinho)
    {
        //adicionar os itens na comanda
        foreach (var produto in carrinho)
        {
            var itemComanda = new ItemComanda
            {
                Nome = nome,
                PrecoUnitario = produto.Preco,
                Quantidade = 1,
                ProdutoId = produto.Id,
                NomeProduto = produto.Nome,
                UrlImagem = produto.UrlImagem
            };
            var responseAddItem = await _apiService.AdicionaItemNaComanda(itemComanda);
            if (responseAddItem.Data)
            {
                // await ShowAlert("Item adicionado na comanda !");
            }
            else
            {
                await ShowAlert($"Falha ao adicionar item: {responseAddItem.ErrorMessage}");
            }
            var movimentacao = new MovimentacaoEstoque()
            {
                ProdutoId = produto.Id,
                Tipo = TipoMovimentacao.Venda,
                Quantidade = 1,
                DataMovimentacao = DateTime.Now
            };
            var responseMovimetacao = await _apiService.MovimentarEstoqueAsync(movimentacao);
            if (responseMovimetacao.Data)
            {
                // await ShowAlert("Item adicionado na comanda !");
            }
            else
            {
                // await ShowAlert($"Falha ao movimentar estoque: {responseAddItem.ErrorMessage}");
            }
        }
    }

    private async Task<int> CriarNovaComanda(string nome, List<ItemComanda> carrinho)
    {
        var dto = carrinho.Select(i => new ItemComandaDTO
        {
            Id = i.Id,
            Nome = i.Nome,
            ProdutoId = i.ProdutoId,
            NomeProduto = i.NomeProduto,
            Quantidade = i.Quantidade,
            PrecoUnitario = i.PrecoUnitario
        }).ToList();

        // Verifica se o carrinho tem produtos da categoria 99 (Cozinha)
        var temProdutosDeCozinha = dto.Any(p => p.CategoriaId == 22 || p.CategoriaId == 18);

        // Define o status com base nisso
        var statusComanda = temProdutosDeCozinha ? "Aguardando Impressao" : "Aberta";

        // Cria a nova comanda com o status adequado
        var novaComanda = new Comanda()
        {
            DataAbertura = DateTime.Now,
            Nome = nome,
            ValorTotal = carrinho.Sum(p => p.ValorTotal),
            Itens = carrinho,
            Status = statusComanda
        };


        var responseComanda = await _apiService.CriarComanda(novaComanda);
        if (responseComanda.Data != null)
        {
            // await ShowAlert("Comanda criada!");
            return responseComanda.Data;
        }
        else
        {
            await ShowAlert($"Falha ao criar comanda: {responseComanda.ErrorMessage}");
            return 0;
        }
    }

    private async Task AtualizarValorComanda(string nome)
    {
        var (itensComanda, errorMessage) = await _apiService.GetItensComanda(nome);

        //atualizar o valor da comanda
        var (comanda, errorMessageComanda) = await _apiService.GetComandaPorNome(nome);

        comanda.ValorTotal = itensComanda.Sum(p => p.Quantidade * p.PrecoUnitario);

        // ??? Enviar a comanda atualizada para a API para persistência no banco
        var responseUpdateComanda = await _apiService.AtualizarComanda(comanda);
        // if (!responseUpdateComanda.HasError)
        // {
        //     //await DisplayAlert("Sucesso", "Comanda atualizada!", "OK");
        //     await Navigation.PopAsync();
        // }
        // else
        // {
        //     await ShowAlert($"Falha ao criar comanda: {responseComanda.ErrorMessage}");
        // }
    }

    private async Task ShowAlert(string message)
    {
        await JS.InvokeVoidAsync("alert", message);
    }

    private async Task PrefillProductFromLookup(string code)
    {
        try
        {
            await JS.InvokeVoidAsync("console.log", "PrefillProductFromLookup: calling GetProdutoPorBarcodeLookup for: " + code);
            var (produtoLookup, errLookup) = await _apiService.GetProdutoPorBarcodeLookup(code);

            if (!string.IsNullOrEmpty(errLookup))
            {
                await JS.InvokeVoidAsync("console.warn", "GetProdutoPorBarcodeLookup returned error: " + errLookup);
            }

            if (produtoLookup != null)
            {
                newProductForBarcode.Nome = produtoLookup.Nome;
                newProductForBarcode.Preco = produtoLookup.Preco;
                newProductForBarcode.Detalhe = produtoLookup.Detalhe;
                newProductForBarcode.UrlImagem = produtoLookup.UrlImagem;
                newProductForBarcode.PrecoCusto = produtoLookup.PrecoCusto;
                newProductForBarcode.PrecoQuente = produtoLookup.PrecoQuente;
                newProductForBarcode.PrecoGelada = produtoLookup.PrecoGelada;
                newProductForBarcode.PrecoEntrega = produtoLookup.PrecoEntrega;
                newProductForBarcode.PrecoRetirar = produtoLookup.PrecoRetirar;
                newProductForBarcode.CategoriaId = produtoLookup.CategoriaId;

                try { await JS.InvokeVoidAsync("console.log", "PrefillProductFromLookup: filled -> " + System.Text.Json.JsonSerializer.Serialize(newProductForBarcode)); } catch { }

                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "PrefillProductFromLookup exception: " + ex.Message);
        }
    }

}
