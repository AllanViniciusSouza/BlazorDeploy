@page "/produtos"
@inject ApiService _apiService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Lista de Produtos</PageTitle>

<div id="produtos-barcode-scanner" style="display:none;"></div>

<div class="d-flex align-items-center justify-content-between mb-3">
    <button class="btn btn-primary" @onclick="MostrarFormulario">Adicionar Novo Produto</button>
    <button class="btn btn-sm btn-outline-primary" title="Abrir leitor (câmera)" @onclick="OpenScanner" aria-label="Abrir leitor de códigos">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
            <path d="M10.5 2a.5.5 0 0 1 .5.5V3h1.5A1.5 1.5 0 0 1 14 4.5v7A1.5 1.5 0 0 1 12.5 13H3.5A1.5 1.5 0 0 1 2 11.5v-7A1.5 1.5 0 0 1 3.5 3H5v-.5a.5.5 0 0 1 .5-.5h5z"/>
            <path d="M8 5a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/>
            <path d="M8 6.5a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3z"/>
        </svg>
    </button>
</div>

@if (exibirFormulario)
{
    <EditForm Model="novoProduto" OnValidSubmit="AdicionarProduto">
        <DataAnnotationsValidator />
        <div class="form-group mb-2">
            <label for="nome">Nome:</label>
            <InputText id="nome" class="form-control" @bind-Value="novoProduto.Nome" />
            <ValidationMessage For="@(() => novoProduto.Nome)" />
        </div>
        <div class="row mb-2">
            <div class="col-md-6">
                <label class="form-label">Preço Quente</label>
                <InputNumber class="form-control" @bind-Value="novoProduto.PrecoQuente" step="0.01" />
            </div>
            <div class="col-md-6">
                <label class="form-label">Preço Gelada</label>
                <InputNumber class="form-control" @bind-Value="novoProduto.PrecoGelada" step="0.01" />
            </div>
        </div>

        <div class="form-group mb-2">
            <label for="categoria">Categoria:</label>
            <InputSelect id="categoria" class="form-control" @bind-Value="novoProduto.CategoriaId">
                <option value="">Selecione...</option>
                @foreach (var cat in categorias)
                {
                    <option value="@cat.Id">@cat.Nome</option>
                }
            </InputSelect>
        </div>

        <div class="form-group mb-3">
            <label for="barcode">Barcode:</label>
            <InputText id="barcode" class="form-control" @bind-Value="novoProduto.Barcode" />
        </div>

        <button type="submit" class="btn btn-success me-2">Salvar</button>
        <button type="button" class="btn btn-secondary" @onclick="Cancelar">Cancelar</button>
    </EditForm>
}

<div class="row mb-3">
    <div class="col-12">
        <label class="form-label fw-bold">Pesquisar (nome ou código de barras)</label>
        <input class="form-control" @bind="searchTerm" @oninput="Search" placeholder="Digite nome ou código" />
    </div>
</div>

<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
    @if (filteredProdutos != null)
    {
        @foreach (var produto in filteredProdutos)
        {
            <div class="col">
                <div class="card bg-dark text-white h-100 position-relative" style="cursor:pointer;" @onclick="@(() => EditRowClicked(produto.Id))">
                    @* small delete X in top-right; stopPropagation so clicking it doesn't open edit *@
                    <button class="btn btn-sm btn-outline-light position-absolute" style="top:6px; right:6px; padding:0.15rem 0.4rem; font-size:0.9rem; line-height:1;" @onclick:stopPropagation="true" @onclick="() => ExcluirProduto(produto.Id)">×</button>

                    <div class="card-body p-2">
                        @if (editandoProdutos.ContainsKey(produto.Id) && editandoProdutos[produto.Id])
                        {
                            <InputText class="form-control form-control-sm mb-1" @bind-Value="produto.Nome" @onclick:stopPropagation="true" />
                            <InputSelect class="form-control form-control-sm mb-1" @bind-Value="produto.CategoriaId" @onclick:stopPropagation="true">
                                @foreach (var cat in categorias)
                                {
                                    <option value="@cat.Id">@cat.Nome</option>
                                }
                            </InputSelect>

                            <div class="d-flex gap-2 align-items-center">
                                <div class="input-group" style="width:170px;">
                                    <span class="input-group-text small">Quente</span>
                                    <InputNumber id="@($"precoQ-{produto.Id}")" class="form-control form-control-sm text-end" @bind-Value="produto.PrecoQuente" step="0.01" @onclick:stopPropagation="true" />
                                </div>
                                <div class="input-group" style="width:170px;">
                                    <span class="input-group-text small">Gelada</span>
                                    <InputNumber id="@($"precoG-{produto.Id}")" class="form-control form-control-sm text-end" @bind-Value="produto.PrecoGelada" step="0.01" @onclick:stopPropagation="true" />
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="fw-bold text-truncate">@produto.Nome</div>
                            <div class="small text-white-50">@categorias.FirstOrDefault(c => c.Id == produto.CategoriaId)?.Nome</div>
                            <div class="mt-2"><span class="small text-white-50">Quente:</span> <span class="fw-bold">R$ @produto.PrecoQuente.ToString("0.00")</span></div>
                            <div class="small"><span class="small text-white-50">Gelada:</span> <span class="fw-bold">R$ @produto.PrecoGelada.ToString("0.00")</span></div>
                        }
                    </div>

                    <div class="card-footer bg-transparent d-flex justify-content-end">
                        @if (editandoProdutos.ContainsKey(produto.Id) && editandoProdutos[produto.Id])
                        {
                            <button class="btn btn-success btn-sm me-1" @onclick:stopPropagation="true" @onclick="() => SalvarEdicao(produto)">Salvar</button>
                            <button class="btn btn-secondary btn-sm" @onclick:stopPropagation="true" @onclick="() => CancelarEdicao(produto.Id)">Cancelar</button>
                        }
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private DotNetObjectReference<object>? _dotNetRefProdutos;
    [JSInvokable]
    public async Task OnBarcodeScanned_Produtos(string code)
    {
        // put code into search field and trigger search
        searchTerm = code;
        await Search(new ChangeEventArgs { Value = code });

        // if product found, move it to top and enter edit mode
        var found = filteredProdutos.FirstOrDefault(p => string.Equals(p.Barcode?.Trim(), code?.Trim(), StringComparison.OrdinalIgnoreCase)
                    || (!string.IsNullOrEmpty(p.Barcode) && new string(p.Barcode.Where(char.IsDigit).ToArray()) == new string(code.Where(char.IsDigit).ToArray())));
        if (found != null)
        {
            // move to top
            filteredProdutos.Remove(found);
            filteredProdutos.Insert(0, found);
            editandoProdutos[found.Id] = true;
            StateHasChanged();
        }
    }

    private async Task OpenScanner()
    {
        _dotNetRefProdutos ??= DotNetObjectReference.Create((object)this);
        // use same container id as CaixaPage so scanner UI/behavior is identical
        await JS.InvokeVoidAsync("barcodeScanner.start", _dotNetRefProdutos, "barcode-scanner-container");
    }

    // The shared JS expects a method named OnBarcodeScanned; provide a wrapper that calls our handler
    [JSInvokable]
    public async Task OnBarcodeScanned(string code)
    {
        await OnBarcodeScanned_Produtos(code);
    }

    private string searchTerm = string.Empty;
    private List<Produto> filteredProdutos = new();
    private List<Categoria> categorias = new();
    private Produto novoProduto = new Produto();
    private bool exibirFormulario = false;
    private Dictionary<int, bool> editandoProdutos = new();

    protected override async Task OnInitializedAsync()
    {
        var nome = await JS.InvokeAsync<string>("sessionStorage.getItem", "Email");
        if (string.IsNullOrEmpty(nome))
        {
            Navigation.NavigateTo("login");
            return;
        }

        var (todosProdutos, _) = await _apiService.GetTodosProdutos();
        filteredProdutos = todosProdutos ?? new List<Produto>();

        var (cats, _) = await _apiService.GetCategorias();
        categorias = cats ?? new List<Categoria>();
    }

    private async Task Search(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;

        var (todosProdutos, _) = await _apiService.GetTodosProdutos();
        var all = todosProdutos ?? new List<Produto>();

        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            filteredProdutos = all;
            return;
        }

        var term = searchTerm.Trim();
        filteredProdutos = all
            .Where(p => (!string.IsNullOrEmpty(p.Nome) && p.Nome.Contains(term, StringComparison.OrdinalIgnoreCase))
                     || (!string.IsNullOrEmpty(p.Barcode) && p.Barcode.Equals(term, StringComparison.OrdinalIgnoreCase)))
            .ToList();
    }

    private void MostrarFormulario()
    {
        novoProduto = new Produto();
        exibirFormulario = true;
    }

    private void Cancelar()
    {
        exibirFormulario = false;
    }

    private async Task AdicionarProduto()
    {
        await _apiService.AdicionarProdutoAsync(novoProduto);
        var (todosProdutos, _) = await _apiService.GetTodosProdutos();
        filteredProdutos = todosProdutos ?? new List<Produto>();
        exibirFormulario = false;
    }

    private async Task ExcluirProduto(int id)
    {
        bool ok = await JS.InvokeAsync<bool>("confirm", "Tem certeza que deseja excluir este produto?");
        if (!ok) return;
        var sucesso = await _apiService.ExcluirProdutoAsync(id);
        if (sucesso)
        {
            var (todosProdutos, _) = await _apiService.GetTodosProdutos();
            filteredProdutos = todosProdutos ?? new List<Produto>();
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Erro ao excluir o produto.");
        }
    }

    private void EditarProduto(int id)
    {
        editandoProdutos[id] = true;
    }

    private Task EditRowClicked(int id)
    {
        if (editandoProdutos.ContainsKey(id) && editandoProdutos[id])
            return Task.CompletedTask;

        editandoProdutos[id] = true;
        return Task.CompletedTask;
    }

    private async Task SalvarEdicao(Produto produto)
    {
        var sucesso = await _apiService.AtualizarProduto(produto.Id, produto);
        if (sucesso)
        {
            editandoProdutos[produto.Id] = false;
            var (todosProdutos, _) = await _apiService.GetTodosProdutos();
            filteredProdutos = todosProdutos ?? new List<Produto>();
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Erro ao atualizar produto.");
        }
    }

    private void CancelarEdicao(int id)
    {
        editandoProdutos[id] = false;
    }
}
